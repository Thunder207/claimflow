<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ClaimFlow</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .role-selector { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 5px solid #3498db; }
        .nav-tabs { margin: 20px 0; }
        .nav-tab { padding: 15px 25px; margin: 0 8px; background: white; border: 2px solid #e9ecef; cursor: pointer; border-radius: 25px; display: inline-block; transition: all 0.3s ease; font-weight: 600; }
        .nav-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .nav-tab:hover { background: #f8f9fa; border-color: #667eea; transform: translateY(-1px); }
        .nav-tab.active:hover { background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%); }
        .tab-content { display: none; padding: 25px; background: white; border-radius: 12px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { padding: 25px; background: white; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value { font-size: 2.2em; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .stat-label { color: #6c757d; font-size: 0.95em; font-weight: 500; }
        .section-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 25px; margin: -25px -25px 25px -25px; border-radius: 12px 12px 0 0; font-size: 18px; font-weight: 600; }
        .expense-item { background: #f8fcff; padding: 20px; margin: 15px 0; border-radius: 12px; border-left: 5px solid #3498db; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .expense-item:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .employee-item { background: #f8fcff; padding: 15px 20px; margin: 12px 0; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; border-left: 4px solid #17a2b8; }
        .employee-item:hover { background: #e8f4fd; transform: translateY(-1px); }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; margin: 0 4px; }
        .btn-primary { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .alert { padding: 20px; margin: 20px 0; border-radius: 10px; }
        .alert-info { background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); color: #0c5460; border-left: 5px solid #17a2b8; }
        .alert-success { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; border-left: 5px solid #28a745; }
        .alert-danger { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); color: #721c24; border-left: 5px solid #dc3545; }
        .loading { text-align: center; padding: 40px; color: #6c757d; }
        .loading .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* üì± Mobile Responsive Enhancements */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { border-radius: 15px; }
            .header { padding: 18px 15px; flex-direction: column; gap: 12px; text-align: center; }
            .header h1 { font-size: 20px; }
            .role-selector { padding: 15px; }
            .role-selector > div { flex-direction: column; gap: 12px; }
            .nav-tabs { margin: 15px 0; display: flex; flex-wrap: wrap; gap: 8px; }
            .nav-tab { padding: 12px 18px; margin: 0; font-size: 14px; flex: 1; min-width: 120px; text-align: center; min-height: 44px; }
            .stats { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .stat-card { padding: 18px 12px; }
            .stat-value { font-size: 1.8em; }
            .tab-content { padding: 18px 14px; }
            .expense-item { padding: 16px; }
            .expense-item > div { flex-direction: column !important; }
            .form-control { font-size: 16px; min-height: 48px; padding: 14px; }
            .btn { min-height: 44px; padding: 12px 16px; font-size: 14px; }
            .btn-success, .btn-danger { min-width: 100px; }
        }
        
        @media (max-width: 480px) {
            .header h1 { font-size: 18px; }
            .stats { grid-template-columns: 1fr 1fr; gap: 10px; }
            .stat-card { padding: 14px 10px; }
            .stat-value { font-size: 1.5em; }
            .nav-tab { padding: 10px 14px; font-size: 13px; min-width: 90px; }
            .btn { padding: 10px 14px; font-size: 13px; width: 100%; margin: 4px 0; }
            .section-header { padding: 15px 18px; font-size: 16px; }
            .employee-item { flex-direction: column; gap: 10px; align-items: flex-start; }
        }
        .status-badge { padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
        .form-group { margin-bottom: 15px; }
        .form-control { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
        .form-control:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .back-link { color: #667eea; text-decoration: none; font-weight: 600; margin-bottom: 20px; display: inline-block; }
        .back-link:hover { color: #5a6fd8; text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="flex-grow: 1;">
                <h1>üèõÔ∏è Government Expense Management System</h1>
                <p>Comprehensive expense tracking and approval dashboard</p>
            </div>
            <div style="text-align: right;">
                <button onclick="exportAdminCSV()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); margin-bottom: 10px;">üì• Export CSV</button>
                <button onclick="logout()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); margin-bottom: 10px;">üö™ Logout</button>
                <br>
                <a href="/dashboard" class="back-link" style="color: white; opacity: 0.9; font-size: 14px;">‚Üê Employee Portal</a>
            </div>
        </div>

        <div class="role-selector">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h4 style="color: #2c3e50; margin: 0 0 8px 0;">üë§ Choose Your Dashboard View</h4>
                    <p style="color: #7f8c8d; margin: 0; font-size: 14px;">Different roles see different data and have different capabilities</p>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                        üîß <strong>Admin:</strong> All employees, all expenses, full management
                        ‚Ä¢ üëî <strong>Supervisor:</strong> Your team only, approval powers
                    </div>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <select id="role-selector" onchange="changeRole()" class="form-control" style="width: auto; min-width: 180px;">
                        <option value="">Select Your Role...</option>
                        <option value="admin">üîß System Administrator</option>
                        <option value="supervisor">üëî Supervisor/Manager</option>
                    </select>
                    <div id="supervisor-selector" style="display: none;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Choose your name to see your team:</div>
                        <select id="supervisor-employee-selector" onchange="selectSupervisor()" class="form-control" style="width: auto; min-width: 200px;">
                            <option value="">Select Your Name...</option>
                        </select>
                    </div>
                    <div id="current-role" style="display: none; padding: 10px 16px; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-radius: 8px; color: #155724; font-weight: 600; font-size: 14px;"></div>
                </div>
            </div>
        </div>

        <div class="nav-tabs" id="nav-tabs" style="display: none;">
            <button class="nav-tab active" onclick="showTab('expenses')" id="expenses-tab-btn">üìä Expenses Dashboard</button>
            <button class="nav-tab" onclick="showTab('employees')" id="employees-tab-btn">üë• Employee Directory</button>
            <button class="nav-tab" onclick="showTab('chart')" id="chart-tab-btn">üè¢ Organization Chart</button>
            <button class="nav-tab" onclick="showTab('sage300')" id="sage300-tab-btn" style="display: none;">üí∞ Sage 300</button>
        </div>

        <div class="stats" id="dashboard-stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="total-expenses">-</div>
                <div class="stat-label">Total Expenses</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-amount">-</div>
                <div class="stat-label">Total Amount</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="approved-amount">-</div>
                <div class="stat-label">Approved Amount</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pending-count">-</div>
                <div class="stat-label">Pending Approval</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="unique-employees">-</div>
                <div class="stat-label" id="employees-stat-label">Employees</div>
            </div>
        </div>

        <div id="expenses-tab" class="tab-content active">
            <div class="section-header">
                <span id="expenses-section-title">üìä All Expenses (Admin View)</span>
            </div>
            <div id="expenses-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading expenses...</p>
                </div>
            </div>
        </div>

        <div id="employees-tab" class="tab-content">
            <div class="section-header">
                <span id="employees-section-title">üë• Employee Directory</span>
                <div style="float: right;" id="employee-actions">
                    <button class="btn btn-primary" onclick="showAddEmployeeForm()" id="add-employee-btn" style="display: none;" title="Add a new employee to the system">‚ûï Add New Employee</button>
                </div>
            </div>
            <div style="background: #f8f9ff; padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;" id="employee-help">
                <div style="font-size: 14px; color: #2c3e50; margin-bottom: 6px;">
                    <strong>üí° Managing Employees</strong>
                </div>
                <div style="font-size: 13px; color: #666; line-height: 1.4;">
                    <span id="employee-help-text">View and manage employee information. Admins can add, edit, and organize reporting structure.</span>
                </div>
            </div>
            
            <!-- Add Employee Form (Hidden by default) -->
            <div id="add-employee-form" style="display: none; background: linear-gradient(135deg, #f8fcff 0%, #e8f4fd 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                <h4 style="margin-bottom: 15px; color: #2c3e50;">‚ûï Add New Employee</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label for="new-employee-name">Full Name *</label>
                        <input type="text" id="new-employee-name" class="form-control" placeholder="John Smith" required>
                    </div>
                    <div class="form-group">
                        <label for="new-employee-number">Employee Number *</label>
                        <input type="text" id="new-employee-number" class="form-control" placeholder="EMP001" required>
                    </div>
                    <div class="form-group">
                        <label for="new-employee-position">Position</label>
                        <input type="text" id="new-employee-position" class="form-control" placeholder="Financial Analyst">
                    </div>
                    <div class="form-group">
                        <label for="new-employee-department">Department</label>
                        <input type="text" id="new-employee-department" class="form-control" placeholder="Finance">
                    </div>
                    <div class="form-group">
                        <label for="new-employee-supervisor">Reports To</label>
                        <select id="new-employee-supervisor" class="form-control">
                            <option value="">No supervisor (Top Level)</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-success" onclick="addEmployee()">‚úÖ Add Employee</button>
                    <button class="btn btn-danger" onclick="hideAddEmployeeForm()">‚ùå Cancel</button>
                </div>
            </div>
            
            <!-- Edit Employee Form (Hidden by default) -->
            <div id="edit-employee-form" style="display: none; background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <h4 style="margin-bottom: 15px; color: #2c3e50;">‚úèÔ∏è Edit Employee</h4>
                <input type="hidden" id="edit-employee-id">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label for="edit-employee-name">Full Name *</label>
                        <input type="text" id="edit-employee-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-employee-number">Employee Number *</label>
                        <input type="text" id="edit-employee-number" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-employee-position">Position</label>
                        <input type="text" id="edit-employee-position" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="edit-employee-department">Department</label>
                        <input type="text" id="edit-employee-department" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="edit-employee-supervisor">Reports To</label>
                        <select id="edit-employee-supervisor" class="form-control">
                            <option value="">No supervisor (Top Level)</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-success" onclick="updateEmployee()">‚úÖ Save Changes</button>
                    <button class="btn btn-danger" onclick="hideEditEmployeeForm()">‚ùå Cancel</button>
                </div>
            </div>
            
            <div id="employees-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading employees...</p>
                </div>
            </div>
        </div>

        <div id="chart-tab" class="tab-content">
            <div class="section-header">
                <span id="chart-section-title">üè¢ Organization Chart</span>
            </div>
            <div id="org-chart-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading organization chart...</p>
                </div>
            </div>
        </div>

        <!-- üí∞ SAGE 300 TAB (Admin Only) -->
        <div id="sage300-tab" class="tab-content">
            <div class="section-header">
                <span>üí∞ Sage 300 GL Account Mapping</span>
            </div>
            
            <!-- GL Account Mapping Section -->
            <div style="margin-bottom: 40px;">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">üìä GL Account Mapping</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="addGLAccount()">+ Add GL Account</button>
                    <button class="btn btn-warning" onclick="previewSageExport()">üëÅÔ∏è Preview Export</button>
                    <button class="btn btn-success" onclick="exportToSage()">üì• Export to Sage 300</button>
                </div>
                <div id="gl-accounts-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading GL accounts...</p>
                    </div>
                </div>
            </div>
            
            <!-- Cost Center Mapping Section -->
            <div>
                <h3 style="margin-bottom: 20px; color: #2c3e50;">üè¢ Department Cost Centers</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="addCostCenter()">+ Add Cost Center</button>
                </div>
                <div id="cost-centers-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading cost centers...</p>
                    </div>
                </div>
            </div>
            
            <!-- Export Preview Modal -->
            <div id="export-preview-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 80%; overflow: auto;">
                    <h3 style="margin-bottom: 20px;">üìã Sage 300 Export Preview</h3>
                    <div id="export-preview-content" style="font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 400px; overflow: auto; white-space: pre-wrap;"></div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-primary" onclick="closeExportPreview()">Close</button>
                        <button class="btn btn-success" onclick="exportToSage()">Download CSV</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUserRole = '';
        let currentSupervisorId = null;
        let currentSupervisorName = '';

        // Role management
        async function changeRole() {
            const roleSelector = document.getElementById('role-selector');
            const supervisorSelector = document.getElementById('supervisor-selector');
            const currentRoleDiv = document.getElementById('current-role');
            const role = roleSelector.value;
            
            currentUserRole = role;
            
            console.log('‚úÖ Role changed to:', role);
            
            if (role === 'supervisor') {
                supervisorSelector.style.display = 'block';
                currentRoleDiv.style.display = 'none';
                await loadSupervisorOptions();
            } else if (role === 'admin') {
                supervisorSelector.style.display = 'none';
                currentRoleDiv.style.display = 'block';
                currentRoleDiv.textContent = 'üîß System Administrator';
                currentSupervisorId = null;
                currentSupervisorName = '';
                showDashboard();
            } else {
                supervisorSelector.style.display = 'none';
                currentRoleDiv.style.display = 'none';
                currentSupervisorId = null;
                currentSupervisorName = '';
                hideDashboard();
            }
        }

        async function selectSupervisor() {
            const supervisorSelect = document.getElementById('supervisor-employee-selector');
            const currentRoleDiv = document.getElementById('current-role');
            
            currentSupervisorId = supervisorSelect.value;
            
            // FIXED: Better name retrieval with fallback options
            if (supervisorSelect.selectedOptions[0]) {
                const selectedOption = supervisorSelect.selectedOptions[0];
                currentSupervisorName = selectedOption.dataset.name || selectedOption.getAttribute('data-name') || '';
                
                // If still no name, extract from option text (fallback)
                if (!currentSupervisorName) {
                    const optionText = selectedOption.textContent || selectedOption.innerText || '';
                    currentSupervisorName = optionText.split(' (')[0]; // Get name before " (X direct reports)"
                }
                
                console.log(`‚úÖ Supervisor selected: ID=${currentSupervisorId}, Name="${currentSupervisorName}"`);
            } else {
                currentSupervisorName = '';
            }
            
            if (currentSupervisorId && currentSupervisorName) {
                currentRoleDiv.style.display = 'block';
                currentRoleDiv.textContent = `üë®‚Äçüíº ${currentSupervisorName} (Manager)`;
                showDashboard();
            } else {
                currentRoleDiv.style.display = 'none';
                hideDashboard();
            }
        }

        async function loadSupervisorOptions() {
            try {
                const response = await fetch('/api/employees', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                if (!response.ok) throw new Error('Failed to load employees');
                
                const employees = await response.json();
                
                const supervisorSelect = document.getElementById('supervisor-employee-selector');
                supervisorSelect.innerHTML = '<option value="">Select Your Name...</option>';
                
                // Find employees who have direct reports (are supervisors)
                const supervisors = employees.filter(emp => 
                    employees.some(other => other.supervisor_id == emp.id)
                );
                
                supervisors.forEach(emp => {
                    const directReports = employees.filter(e => e.supervisor_id == emp.id).length;
                    supervisorSelect.innerHTML += `<option value="${emp.id}" data-name="${emp.name}">${emp.name} (${directReports} direct reports)</option>`;
                });
                
            } catch (error) {
                console.error('‚ùå Error loading supervisor options:', error);
                showMessage('danger', '‚ùå Failed to load supervisor options');
            }
        }

        function showDashboard() {
            document.getElementById('nav-tabs').style.display = 'block';
            document.getElementById('dashboard-stats').style.display = 'grid';
            
            updateTabLabels();
            showTab('expenses');
        }

        function hideDashboard() {
            document.getElementById('nav-tabs').style.display = 'none';
            document.getElementById('dashboard-stats').style.display = 'none';
        }

        function updateTabLabels() {
            const expensesBtn = document.getElementById('expenses-tab-btn');
            const employeesBtn = document.getElementById('employees-tab-btn');
            const chartBtn = document.getElementById('chart-tab-btn');
            const sage300Btn = document.getElementById('sage300-tab-btn');
            const addEmployeeBtn = document.getElementById('add-employee-btn');
            
            if (currentUserRole === 'admin') {
                expensesBtn.innerHTML = 'üìä All Expenses';
                employeesBtn.innerHTML = 'üë• Employee Directory';
                chartBtn.innerHTML = 'üè¢ Organization Chart';
                sage300Btn.style.display = 'inline-block';
                addEmployeeBtn.style.display = 'inline-block';
                
                document.getElementById('expenses-section-title').textContent = 'üìä All System Expenses (Admin View)';
                document.getElementById('employees-section-title').textContent = 'üë• Complete Employee Directory';
                document.getElementById('chart-section-title').textContent = 'üè¢ Full Organization Chart';
                document.getElementById('employees-stat-label').textContent = 'Total Employees';
                
            } else if (currentUserRole === 'supervisor' && currentSupervisorId) {
                expensesBtn.innerHTML = 'üìä Team Approvals';
                employeesBtn.innerHTML = 'üë• My Team';
                chartBtn.innerHTML = 'üè¢ Team Structure';
                sage300Btn.style.display = 'none'; // Supervisors cannot access Sage 300
                addEmployeeBtn.style.display = 'none'; // Supervisors cannot manage employees
                
                // FIXED: Use fallback text if name is not available
                const supervisorDisplayName = currentSupervisorName || 'Supervisor';
                console.log(`üìã Updating tab labels for supervisor: "${supervisorDisplayName}" (ID: ${currentSupervisorId})`);
                
                document.getElementById('expenses-section-title').textContent = `üë®‚Äçüíº ${supervisorDisplayName}'s Team Expenses`;
                document.getElementById('employees-section-title').textContent = `üë• ${supervisorDisplayName}'s Direct Reports`;
                document.getElementById('chart-section-title').textContent = `üè¢ ${supervisorDisplayName}'s Team Structure`;
                document.getElementById('employees-stat-label').textContent = 'Direct Reports';
            }
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            document.getElementById(tabName + '-tab-btn').classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'expenses') {
                loadExpenses();
            } else if (tabName === 'employees') {
                loadEmployees();
            } else if (tabName === 'chart') {
                loadOrganizationChart();
            } else if (tabName === 'sage300') {
                loadSage300Data();
            }
        }

        async function loadExpenses() {
            const container = document.getElementById('expenses-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading expenses...</p></div>';
            
            try {
                const response = await fetch('/api/expenses', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                
                const allExpenses = await response.json();
                console.log(`‚úÖ Loaded ${allExpenses.length} expenses`);
                
                // API already filters by role (supervisor sees team only, admin sees all)
                let expenses = allExpenses;
                console.log(`‚úÖ Showing ${expenses.length} expenses (server-filtered by role)`);
                
                await updateDashboardStats(expenses);
                
                if (expenses.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
                                <h3>No Expenses Found</h3>
                                <p>${currentUserRole === 'supervisor' ? 'Your team has not submitted any expenses yet.' : 'No expenses have been submitted to the system yet.'}</p>
                                <a href="/" class="btn btn-primary" style="margin-top: 15px; text-decoration: none;">‚ûï Submit First Expense</a>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = expenses.map(expense => {
                    const statusClass = expense.status === 'approved' ? 'status-approved' : 
                                      expense.status === 'rejected' ? 'status-rejected' : 'status-pending';
                    const statusText = expense.status === 'approved' ? '‚úÖ Approved' :
                                     expense.status === 'rejected' ? '‚ùå Rejected' : '‚è≥ Pending';
                    
                    let actionButtons = '';
                    if (expense.status === 'pending') {
                        if (currentUserRole === 'supervisor') {
                            actionButtons = `
                                <button class="btn btn-success" onclick="approveExpense(${expense.id})">‚úÖ Approve</button>
                                <button class="btn btn-danger" onclick="rejectExpense(${expense.id})">‚ùå Reject</button>
                            `;
                        } else if (currentUserRole === 'admin') {
                            actionButtons = `
                                <button class="btn btn-success" onclick="approveExpense(${expense.id})">‚úÖ Approve</button>
                                <button class="btn btn-danger" onclick="rejectExpense(${expense.id})">‚ùå Reject</button>
                                <button class="btn btn-warning" onclick="deleteExpense(${expense.id})">üóëÔ∏è Delete</button>
                            `;
                        }
                    }
                    
                    return `
                        <div class="expense-item">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; flex-wrap: wrap;">
                                <div style="flex-grow: 1; min-width: 300px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px;">
                                        <div style="font-weight: bold; color: #2c3e50; font-size: 18px;">
                                            ${expense.meal_name || expense.expense_type} ‚Ä¢ ${expense.employee_name}
                                        </div>
                                        <div class="status-badge ${statusClass}">
                                            ${statusText}
                                        </div>
                                    </div>
                                    <div style="color: #666; font-size: 14px; margin-bottom: 12px;">
                                        <span style="color: #27ae60; font-size: 20px; font-weight: bold;">$${parseFloat(expense.amount).toFixed(2)}</span> ‚Ä¢ 
                                        üìÖ ${expense.date} ‚Ä¢ 
                                        üìç ${expense.location || 'No location'}
                                        ${expense.vendor ? ` ‚Ä¢ üè™ ${expense.vendor}` : ''}
                                    </div>
                                    ${expense.description ? `
                                        <div style="font-size: 13px; color: #666; margin-bottom: 12px; padding: 8px 12px; background: #f8f9fa; border-radius: 6px;">
                                            üìã ${expense.description}
                                        </div>
                                    ` : ''}
                                    ${expense.approval_comment ? `
                                        <div style="font-size: 13px; color: #155724; margin-bottom: 12px; padding: 8px 12px; background: #d4edda; border-radius: 6px;">
                                            ‚úÖ <strong>${expense.approved_by}:</strong> ${expense.approval_comment}
                                        </div>
                                    ` : ''}
                                    ${expense.rejection_reason ? `
                                        <div style="font-size: 13px; color: #721c24; margin-bottom: 12px; padding: 8px 12px; background: #f8d7da; border-radius: 6px;">
                                            ‚ùå <strong>${expense.approved_by}:</strong> ${expense.rejection_reason}
                                        </div>
                                    ` : ''}
                                    ${actionButtons ? `<div style="margin-top: 15px;">${actionButtons}</div>` : ''}
                                </div>
                                ${expense.receipt_photo ? `
                                    <div style="flex-shrink: 0;">
                                        <img src="${expense.receipt_photo}" alt="Receipt" style="max-width: 100px; max-height: 100px; border-radius: 8px; cursor: pointer; border: 2px solid #ddd;" onclick="viewReceipt('${expense.receipt_photo}')">
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('‚ùå Error loading expenses:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                            <h3>Error Loading Expenses</h3>
                            <p>Failed to load expenses: ${error.message}</p>
                            <button class="btn btn-primary" onclick="loadExpenses()" style="margin-top: 15px;">üîÑ Try Again</button>
                        </div>
                    </div>
                `;
            }
        }

        async function updateDashboardStats(expenses) {
            try {
                const totalAmount = expenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
                const approvedAmount = expenses.filter(exp => exp.status === 'approved')
                    .reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
                const pendingCount = expenses.filter(exp => exp.status === 'pending').length;
                
                let uniqueEmployees = 0;
                if (currentUserRole === 'supervisor' && currentSupervisorId) {
                    const employeesResponse = await fetch('/api/employees', {
                        headers: { 'Authorization': `Bearer ${sessionId}` }
                    });
                    const allEmployees = await employeesResponse.json();
                    uniqueEmployees = allEmployees.filter(emp => emp.supervisor_id == currentSupervisorId).length;
                } else if (currentUserRole === 'admin') {
                    const employeesResponse = await fetch('/api/employees', {
                        headers: { 'Authorization': `Bearer ${sessionId}` }
                    });
                    const allEmployees = await employeesResponse.json();
                    uniqueEmployees = allEmployees.length;
                }
                
                document.getElementById('total-expenses').textContent = expenses.length;
                document.getElementById('total-amount').textContent = `$${totalAmount.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
                document.getElementById('approved-amount').textContent = `$${approvedAmount.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
                document.getElementById('pending-count').textContent = pendingCount;
                document.getElementById('unique-employees').textContent = uniqueEmployees;
                
            } catch (error) {
                console.error('‚ùå Error updating dashboard stats:', error);
            }
        }

        async function loadEmployees() {
            const container = document.getElementById('employees-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading employees...</p></div>';
            
            try {
                const response = await fetch('/api/employees', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                if (!response.ok) throw new Error('Failed to load employees');
                
                const allEmployees = await response.json();
                console.log(`‚úÖ Loaded ${allEmployees.length} employees`);
                
                // Store employees globally for forms
                window.allEmployees = allEmployees;
                
                let employees = allEmployees;
                if (currentUserRole === 'supervisor' && currentSupervisorId) {
                    employees = allEmployees.filter(emp => emp.supervisor_id == currentSupervisorId);
                }
                
                if (employees.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üë•</div>
                                <h3>No Employees Found</h3>
                                <p>No employees in the directory yet.</p>
                                ${currentUserRole === 'admin' ? '<button class="btn btn-primary" onclick="showAddEmployeeForm()" style="margin-top: 15px;">‚ûï Add First Employee</button>' : ''}
                            </div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = employees.map(emp => {
                    let actionButtons = '';
                    if (currentUserRole === 'admin') {
                        actionButtons = `
                            <div style="margin-top: 8px;">
                                <button class="btn btn-warning" onclick="editEmployee(${emp.id})" style="margin-right: 5px;">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger" onclick="deleteEmployee(${emp.id}, '${emp.name}')">üóëÔ∏è Delete</button>
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="employee-item">
                            <div style="flex-grow: 1;">
                                <div style="font-weight: bold; color: #2c3e50; font-size: 16px;">${emp.name}</div>
                                <div style="color: #666; font-size: 14px; margin-top: 4px;">
                                    ${emp.position || 'No position'} ‚Ä¢ ${emp.department || 'No department'}
                                    ${emp.supervisor_name ? ` ‚Ä¢ Reports to: ${emp.supervisor_name}` : ' ‚Ä¢ Top Level Manager'}
                                </div>
                                ${actionButtons}
                            </div>
                            <div style="text-align: right;">
                                <span style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); color: #1976d2; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;">
                                    ${emp.employee_number || 'No ID'}
                                </span>
                                ${currentUserRole === 'admin' ? `<div style="color: #666; font-size: 12px; margin-top: 5px;">ID: ${emp.id}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('‚ùå Error loading employees:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                            <h3>Error Loading Employees</h3>
                            <p>Failed to load employees: ${error.message}</p>
                            <button class="btn btn-primary" onclick="loadEmployees()" style="margin-top: 15px;">üîÑ Try Again</button>
                        </div>
                    </div>
                `;
            }
        }

        // üë• Employee Management Functions

        function showAddEmployeeForm() {
            document.getElementById('add-employee-form').style.display = 'block';
            document.getElementById('edit-employee-form').style.display = 'none';
            populateSupervisorDropdown('new-employee-supervisor');
            document.getElementById('new-employee-name').focus();
        }

        function hideAddEmployeeForm() {
            document.getElementById('add-employee-form').style.display = 'none';
            // Clear form
            document.getElementById('new-employee-name').value = '';
            document.getElementById('new-employee-number').value = '';
            document.getElementById('new-employee-position').value = '';
            document.getElementById('new-employee-department').value = '';
            document.getElementById('new-employee-supervisor').value = '';
        }

        function editEmployee(employeeId) {
            const employee = window.allEmployees.find(emp => emp.id === employeeId);
            if (!employee) {
                showMessage('danger', '‚ùå Employee not found');
                return;
            }
            
            document.getElementById('edit-employee-form').style.display = 'block';
            document.getElementById('add-employee-form').style.display = 'none';
            
            // Populate form
            document.getElementById('edit-employee-id').value = employee.id;
            document.getElementById('edit-employee-name').value = employee.name;
            document.getElementById('edit-employee-number').value = employee.employee_number || '';
            document.getElementById('edit-employee-position').value = employee.position || '';
            document.getElementById('edit-employee-department').value = employee.department || '';
            
            populateSupervisorDropdown('edit-employee-supervisor', employeeId);
            document.getElementById('edit-employee-supervisor').value = employee.supervisor_id || '';
            
            document.getElementById('edit-employee-name').focus();
        }

        function hideEditEmployeeForm() {
            document.getElementById('edit-employee-form').style.display = 'none';
        }

        function populateSupervisorDropdown(selectId, excludeEmployeeId = null) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">No supervisor (Top Level)</option>';
            
            if (window.allEmployees) {
                window.allEmployees
                    .filter(emp => emp.id != excludeEmployeeId) // Don't let someone report to themselves
                    .forEach(emp => {
                        select.innerHTML += `<option value="${emp.id}">${emp.name} - ${emp.position || 'No Position'}</option>`;
                    });
            }
        }

        async function addEmployee() {
            const name = document.getElementById('new-employee-name').value.trim();
            const employeeNumber = document.getElementById('new-employee-number').value.trim();
            const position = document.getElementById('new-employee-position').value.trim();
            const department = document.getElementById('new-employee-department').value.trim();
            const supervisorId = document.getElementById('new-employee-supervisor').value;
            
            if (!name) {
                showMessage('danger', '‚ùå Employee name is required');
                document.getElementById('new-employee-name').focus();
                return;
            }
            
            if (!employeeNumber) {
                showMessage('danger', '‚ùå Employee number is required');
                document.getElementById('new-employee-number').focus();
                return;
            }
            
            try {
                const response = await fetch('/api/employees', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({
                        name,
                        employee_number: employeeNumber,
                        position: position || null,
                        department: department || null,
                        supervisor_id: supervisorId || null
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Employee added successfully!');
                    hideAddEmployeeForm();
                    loadEmployees();
                } else {
                    showMessage('danger', result.error || 'Failed to add employee');
                }
            } catch (error) {
                console.error('‚ùå Error adding employee:', error);
                showMessage('danger', '‚ùå Failed to add employee');
            }
        }

        async function updateEmployee() {
            const id = document.getElementById('edit-employee-id').value;
            const name = document.getElementById('edit-employee-name').value.trim();
            const employeeNumber = document.getElementById('edit-employee-number').value.trim();
            const position = document.getElementById('edit-employee-position').value.trim();
            const department = document.getElementById('edit-employee-department').value.trim();
            const supervisorId = document.getElementById('edit-employee-supervisor').value;
            
            if (!name) {
                showMessage('danger', '‚ùå Employee name is required');
                document.getElementById('edit-employee-name').focus();
                return;
            }
            
            if (!employeeNumber) {
                showMessage('danger', '‚ùå Employee number is required');
                document.getElementById('edit-employee-number').focus();
                return;
            }
            
            try {
                const response = await fetch(`/api/employees/${id}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({
                        name,
                        employee_number: employeeNumber,
                        position: position || null,
                        department: department || null,
                        supervisor_id: supervisorId || null
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Employee updated successfully!');
                    hideEditEmployeeForm();
                    loadEmployees();
                } else {
                    showMessage('danger', result.error || 'Failed to update employee');
                }
            } catch (error) {
                console.error('‚ùå Error updating employee:', error);
                showMessage('danger', '‚ùå Failed to update employee');
            }
        }

        async function deleteEmployee(employeeId, employeeName) {
            if (!confirm(`üóëÔ∏è Are you sure you want to delete "${employeeName}"?\n\nThis action cannot be undone.\n\nNote: Employees with expenses or direct reports cannot be deleted.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/employees/${employeeId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', `‚úÖ Employee "${employeeName}" deleted successfully`);
                    loadEmployees();
                } else {
                    showMessage('danger', result.error || 'Failed to delete employee');
                }
            } catch (error) {
                console.error('‚ùå Error deleting employee:', error);
                showMessage('danger', '‚ùå Failed to delete employee');
            }
        }

        async function loadOrganizationChart() {
            const container = document.getElementById('org-chart-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading organization chart...</p></div>';
            
            try {
                const response = await fetch('/api/employees', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                if (!response.ok) throw new Error('Failed to load employees');
                
                const employees = await response.json();
                
                // Recursive org chart renderer
                function renderNode(person, allEmps, depth) {
                    const reports = allEmps.filter(e => e.supervisor_id == person.id);
                    const colors = ['#3498db','#2ecc71','#e67e22','#9b59b6'];
                    const color = colors[Math.min(depth, 3)];
                    const icon = depth === 0 ? 'üë®‚Äçüíº' : reports.length > 0 ? 'üëî' : 'üë§';
                    const roleTag = person.role === 'admin' ? ' üîë Admin' : person.role === 'supervisor' ? ' üìã Supervisor' : '';
                    let html = `<div style="margin-bottom:${depth===0?20:8}px; margin-left:${depth*30}px; padding:${depth===0?18:10}px; background:linear-gradient(135deg,#fff 0%,#f8f9fa 100%); border-radius:${depth===0?12:8}px; border-left:${depth===0?5:3}px solid ${color};">
                        <div style="font-weight:bold; color:#2c3e50; font-size:${Math.max(14,18-depth*2)}px;">${icon} ${person.name} - ${person.position||'Employee'}${roleTag}</div>
                        <div style="color:#666; font-size:13px;">${person.department||''} ‚Ä¢ ${person.employee_number||''}${reports.length>0?' ‚Ä¢ '+reports.length+' direct report'+(reports.length>1?'s':''):''}</div>
                    </div>`;
                    reports.forEach(r => { html += renderNode(r, allEmps, depth+1); });
                    return html;
                }
                
                const roots = employees.filter(e => !e.supervisor_id);
                let treeHtml = '';
                roots.forEach(r => { treeHtml += renderNode(r, employees, 0); });
                
                container.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üè¢</div>
                            <h3 style="color: #2c3e50;">Organization Structure</h3>
                            <p style="color: #6c757d;">Showing ${employees.length} employees in organizational hierarchy</p>
                        </div>
                        <div style="max-width: 800px; margin: 0 auto;">
                            ${treeHtml}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('‚ùå Error loading organization chart:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                            <h3>Error Loading Organization Chart</h3>
                            <p>Failed to load chart: ${error.message}</p>
                            <button class="btn btn-primary" onclick="loadOrganizationChart()" style="margin-top: 15px;">üîÑ Try Again</button>
                        </div>
                    </div>
                `;
            }
        }

        async function approveExpense(expenseId) {
            // Add confirmation with more context
            const confirmMsg = 'Approve this expense?\n\nThis will:\n‚úÖ Mark it as approved\nüí∞ Make it available for payment processing\nüìß Notify the employee\n\nThis action cannot be undone.';
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/expenses/${expenseId}/approve`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({ 
                        comment: 'Approved for payment processing',
                        approver: currentUserRole === 'supervisor' ? currentSupervisorName : 'System Administrator'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Expense approved! Employee will be notified and expense is ready for payment.');
                    loadExpenses();
                } else {
                    showMessage('danger', result.error || 'Failed to approve expense - please try again');
                }
            } catch (error) {
                console.error('‚ùå Error approving expense:', error);
                showMessage('danger', '‚ùå Network error: Could not approve expense. Please check your connection.');
            }
        }

        async function rejectExpense(expenseId) {
            const reason = prompt(`üìù Rejection Reason (Required)\n\nPlease provide a clear, detailed reason why this expense cannot be approved.\n\nCommon reasons:\n‚Ä¢ Missing receipt or documentation\n‚Ä¢ Expense outside policy guidelines\n‚Ä¢ Incorrect amount or calculations\n‚Ä¢ Business purpose not clear\n\nEmployee will see this message:`);
            
            if (!reason || !reason.trim()) {
                showMessage('danger', '‚ö†Ô∏è Rejection reason is required for audit compliance and to help the employee understand the issue.');
                return;
            }
            
            if (reason.trim().length < 10) {
                showMessage('danger', '‚ö†Ô∏è Please provide a more detailed reason (at least 10 characters) to help the employee understand and resubmit correctly.');
                return;
            }

            try {
                const response = await fetch(`/api/expenses/${expenseId}/reject`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({ 
                        reason: reason.trim(),
                        approver: currentUserRole === 'supervisor' ? currentSupervisorName : 'System Administrator'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚ùå Expense rejected successfully');
                    loadExpenses();
                } else {
                    showMessage('danger', result.error || 'Failed to reject expense');
                }
            } catch (error) {
                console.error('‚ùå Error rejecting expense:', error);
                showMessage('danger', '‚ùå Failed to reject expense');
            }
        }

        async function deleteExpense(expenseId) {
            if (!confirm('üóëÔ∏è Are you sure you want to delete this expense?\n\nThis action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/expenses/${expenseId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Expense deleted successfully');
                    loadExpenses();
                } else {
                    showMessage('danger', result.error || 'Failed to delete expense');
                }
            } catch (error) {
                console.error('‚ùå Error deleting expense:', error);
                showMessage('danger', '‚ùå Failed to delete expense');
            }
        }

        function viewReceipt(receiptPath) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 2000;
                background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
                padding: 20px; cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = receiptPath;
            img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';
            
            modal.appendChild(img);
            modal.onclick = () => modal.remove();
            document.body.appendChild(modal);
        }

        function showMessage(type, message) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                padding: 15px 20px; border-radius: 10px; color: white; font-weight: 600;
                background: ${type === 'success' ? 'linear-gradient(135deg, #28a745 0%, #20c997 100%)' : 
                           type === 'danger' ? 'linear-gradient(135deg, #dc3545 0%, #e74c3c 100%)' : 
                           'linear-gradient(135deg, #17a2b8 0%, #20c997 100)'};
                max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                transform: translateX(400px); transition: transform 0.3s ease;
            `;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => messageDiv.style.transform = 'translateX(0)', 100);
            
            setTimeout(() => {
                messageDiv.style.transform = 'translateX(400px)';
                setTimeout(() => messageDiv.remove(), 300);
            }, 4000);
        }

        let sessionId = null;
        let currentUser = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            sessionId = localStorage.getItem('sessionId');
            currentUser = JSON.parse(localStorage.getItem('user') || 'null');
            
            if (!sessionId || !currentUser) {
                window.location.href = '/login';
                return;
            }
            
            if (currentUser.role !== 'admin' && currentUser.role !== 'supervisor') {
                alert('Access denied. This page is for supervisors and administrators only.');
                window.location.href = '/dashboard';
                return;
            }
            
            try {
                // Verify session
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                if (!response.ok) {
                    throw new Error('Session expired');
                }
                
                const user = await response.json();
                currentUser = user;
                localStorage.setItem('user', JSON.stringify(user));
                
                // Auto-select role and show dashboard
                document.getElementById('role-selector').value = user.role;
                // Governance: supervisors cannot switch roles or manage employees
                if (user.role === 'supervisor') {
                    document.querySelector('.role-selector').style.display = 'none';
                }
                if (user.role === 'supervisor') {
                    await changeRole(); // This will load supervisor options
                    document.getElementById('supervisor-employee-selector').value = user.id;
                    
                    // FIXED: Ensure name is available before calling selectSupervisor
                    currentSupervisorName = user.name; // Set name directly from user data
                    console.log(`üìã Setting supervisor name from user data: "${currentSupervisorName}"`);
                    
                    await selectSupervisor();
                } else {
                    await changeRole();
                }
                
            } catch (error) {
                console.error('Session validation failed:', error);
                localStorage.removeItem('sessionId');
                localStorage.removeItem('user');
                window.location.href = '/login';
            }
            
            console.log('üèõÔ∏è Admin Dashboard loaded and ready');
        });

        // CSV Export for admin
        function exportAdminCSV() {
            fetch('/api/expenses/export/csv', { headers: { 'Authorization': `Bearer ${sessionId}` } })
                .then(r => r.blob())
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'expenses-export.csv'; a.click();
                    URL.revokeObjectURL(url);
                })
                .catch(e => showMessage('danger', '‚ùå Export failed: ' + e.message));
        }

        // Add logout function
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            localStorage.removeItem('sessionId');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        // üí∞ SAGE 300 FUNCTIONALITY

        async function loadSage300Data() {
            if (currentUserRole !== 'admin') return;
            
            try {
                await loadGLAccounts();
                await loadCostCenters();
            } catch (error) {
                console.error('Error loading Sage 300 data:', error);
            }
        }

        async function loadGLAccounts() {
            try {
                const response = await fetch('/api/sage/gl-accounts', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    displayGLAccounts(data.data);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error loading GL accounts:', error);
                document.getElementById('gl-accounts-container').innerHTML = '<div class="alert alert-danger">Error loading GL accounts</div>';
            }
        }

        function displayGLAccounts(accounts) {
            const container = document.getElementById('gl-accounts-container');
            
            if (accounts.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No GL accounts found</div>';
                return;
            }
            
            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Expense Type</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">GL Code</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">GL Name</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Status</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            accounts.forEach(account => {
                html += `
                    <tr style="border-bottom: 1px solid #dee2e6;" data-id="${account.id}">
                        <td style="padding: 12px;">
                            <input type="text" value="${account.expense_type}" 
                                   class="form-input" data-field="expense_type" 
                                   style="width: 100%; border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                        </td>
                        <td style="padding: 12px;">
                            <input type="text" value="${account.gl_code}" 
                                   class="form-input" data-field="gl_code"
                                   style="width: 80px; border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                        </td>
                        <td style="padding: 12px;">
                            <input type="text" value="${account.gl_name}" 
                                   class="form-input" data-field="gl_name"
                                   style="width: 100%; border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                        </td>
                        <td style="padding: 12px;">
                            <select data-field="is_active" class="form-input" 
                                    style="border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                                <option value="1" ${account.is_active ? 'selected' : ''}>Active</option>
                                <option value="0" ${!account.is_active ? 'selected' : ''}>Inactive</option>
                            </select>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button class="btn btn-success" onclick="saveGLAccount(${account.id})" 
                                    style="padding: 6px 12px; margin-right: 5px;">üíæ Save</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }

        async function loadCostCenters() {
            try {
                const response = await fetch('/api/sage/cost-centers', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    displayCostCenters(data.data);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error loading cost centers:', error);
                document.getElementById('cost-centers-container').innerHTML = '<div class="alert alert-danger">Error loading cost centers</div>';
            }
        }

        function displayCostCenters(centers) {
            const container = document.getElementById('cost-centers-container');
            
            if (centers.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No cost centers found</div>';
                return;
            }
            
            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Department</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Cost Center Code</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Cost Center Name</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Status</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            centers.forEach(center => {
                html += `
                    <tr style="border-bottom: 1px solid #dee2e6;" data-id="${center.id}">
                        <td style="padding: 12px;">
                            <input type="text" value="${center.department}" 
                                   class="form-input" data-field="department"
                                   style="width: 100%; border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                        </td>
                        <td style="padding: 12px;">
                            <input type="text" value="${center.cost_center_code}" 
                                   class="form-input" data-field="cost_center_code"
                                   style="width: 100px; border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                        </td>
                        <td style="padding: 12px;">
                            <input type="text" value="${center.cost_center_name}" 
                                   class="form-input" data-field="cost_center_name"
                                   style="width: 100%; border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                        </td>
                        <td style="padding: 12px;">
                            <select data-field="is_active" class="form-input"
                                    style="border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                                <option value="1" ${center.is_active ? 'selected' : ''}>Active</option>
                                <option value="0" ${!center.is_active ? 'selected' : ''}>Inactive</option>
                            </select>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button class="btn btn-success" onclick="saveCostCenter(${center.id})" 
                                    style="padding: 6px 12px; margin-right: 5px;">üíæ Save</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }

        async function saveGLAccount(id) {
            const row = document.querySelector(`[data-id="${id}"]`);
            const data = {};
            
            row.querySelectorAll('.form-input').forEach(input => {
                data[input.getAttribute('data-field')] = input.value;
            });
            
            try {
                const response = await fetch(`/api/sage/gl-accounts/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('GL account updated successfully', 'success');
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                console.error('Error saving GL account:', error);
                showAlert('Error saving GL account', 'danger');
            }
        }

        async function saveCostCenter(id) {
            const row = document.querySelector(`[data-id="${id}"]`);
            const data = {};
            
            row.querySelectorAll('.form-input').forEach(input => {
                data[input.getAttribute('data-field')] = input.value;
            });
            
            try {
                const response = await fetch(`/api/sage/cost-centers/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('Cost center updated successfully', 'success');
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                console.error('Error saving cost center:', error);
                showAlert('Error saving cost center', 'danger');
            }
        }

        async function addGLAccount() {
            const expenseType = prompt('Enter expense type (e.g., meals, hotel, vehicle):');
            if (!expenseType) return;
            
            const glCode = prompt('Enter GL code (e.g., 5410):');
            if (!glCode) return;
            
            const glName = prompt('Enter GL name (e.g., Travel - Meals):');
            if (!glName) return;
            
            try {
                const response = await fetch('/api/sage/gl-accounts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({
                        expense_type: expenseType,
                        gl_code: glCode,
                        gl_name: glName
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('GL account added successfully', 'success');
                    await loadGLAccounts();
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                console.error('Error adding GL account:', error);
                showAlert('Error adding GL account', 'danger');
            }
        }

        async function addCostCenter() {
            const department = prompt('Enter department name:');
            if (!department) return;
            
            const costCenterCode = prompt('Enter cost center code (e.g., 100):');
            if (!costCenterCode) return;
            
            const costCenterName = prompt('Enter cost center name:');
            if (!costCenterName) return;
            
            try {
                const response = await fetch('/api/sage/cost-centers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({
                        department: department,
                        cost_center_code: costCenterCode,
                        cost_center_name: costCenterName
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('Cost center added successfully', 'success');
                    await loadCostCenters();
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                console.error('Error adding cost center:', error);
                showAlert('Error adding cost center', 'danger');
            }
        }

        async function previewSageExport() {
            try {
                const response = await fetch('/api/sage/export', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                if (response.headers.get('content-type').includes('text/csv')) {
                    const csvContent = await response.text();
                    const lines = csvContent.split('\n').slice(0, 10); // Show first 10 lines
                    const preview = lines.join('\n') + (csvContent.split('\n').length > 10 ? '\n... (showing first 10 rows)' : '');
                    
                    document.getElementById('export-preview-content').textContent = preview;
                    document.getElementById('export-preview-modal').style.display = 'block';
                } else {
                    showAlert('Error generating export preview', 'danger');
                }
            } catch (error) {
                console.error('Error previewing export:', error);
                showAlert('Error previewing export', 'danger');
            }
        }

        function closeExportPreview() {
            document.getElementById('export-preview-modal').style.display = 'none';
        }

        async function exportToSage() {
            try {
                const response = await fetch('/api/sage/export', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `sage300_expenses_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showAlert('Sage 300 export downloaded successfully', 'success');
                    closeExportPreview();
                } else {
                    showAlert('Error exporting data', 'danger');
                }
            } catch (error) {
                console.error('Error exporting to Sage:', error);
                showAlert('Error exporting to Sage', 'danger');
            }
        }
    </script>
</body>
</html>