<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ClaimFlow</title>
    <script src="/translations.js"></script>
    <style>
        /* Language toggle styles */
        .language-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            display: flex;
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            padding: 2px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .language-toggle button {
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: #333;
            cursor: pointer;
            border-radius: 16px;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 12px;
        }
        
        .language-toggle button.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .language-toggle button:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Segoe UI Emoji', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            padding: 20px; 
            color: #2c3e50;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { 
            background: linear-gradient(135deg, #1a237e 0%, #283593 50%, #3949ab 100%); 
            color: white; 
            padding: 30px 20px; 
            border-radius: 16px; 
            margin-bottom: 20px; 
            box-shadow: 0 8px 25px rgba(26, 35, 126, 0.25), 0 4px 10px rgba(0,0,0,0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            backdrop-filter: blur(10px);
        }
        .role-selector { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 5px solid #3498db; }
        .nav-tabs { margin: 20px 0; }
        .nav-tab { padding: 15px 25px; margin: 0 8px; background: white; border: 2px solid #e9ecef; cursor: pointer; border-radius: 25px; display: inline-block; transition: all 0.3s ease; font-weight: 600; }
        .nav-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .nav-tab:hover { background: #f8f9fa; border-color: #667eea; transform: translateY(-1px); }
        .nav-tab.active:hover { background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%); }
        .tab-content { display: none; padding: 25px; background: white; border-radius: 12px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { 
            padding: 25px; 
            background: linear-gradient(135deg, #ffffff 0%, #f8fcff 100%); 
            border-radius: 16px; 
            text-align: center; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.1); 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            border-left: 4px solid #4a90e2;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #4a90e2, #357abd, #1e3c72);
        }
        .stat-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(0,0,0,0.12), 0 4px 8px rgba(0,0,0,0.1);
        }
        .stat-value { font-size: 2.2em; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .stat-label { color: #6c757d; font-size: 0.95em; font-weight: 500; }
        .section-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 25px; margin: -25px -25px 25px -25px; border-radius: 12px 12px 0 0; font-size: 18px; font-weight: 600; }
        .expense-item { background: #f8fcff; padding: 20px; margin: 15px 0; border-radius: 12px; border-left: 5px solid #3498db; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .expense-item:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .employee-item { background: #f8fcff; padding: 15px 20px; margin: 12px 0; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; border-left: 4px solid #17a2b8; }
        .employee-item:hover { background: #e8f4fd; transform: translateY(-1px); }
        /* CONSISTENT BUTTON STYLES - Matching employee dashboard */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: 44px;
            position: relative;
            overflow: hidden;
            margin: 0 4px;
        }
        
        /* Consistent button colors - matching status badges */
        .btn-primary { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
            color: white; 
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.25);
        }
        .btn-success { 
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
            color: white; 
            box-shadow: 0 2px 6px rgba(34, 197, 94, 0.25);
        }
        .btn-danger { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            color: white; 
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.25);
        }
        .btn-warning { 
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); 
            color: white; 
            box-shadow: 0 2px 6px rgba(249, 115, 22, 0.25);
        }
        .btn-secondary { 
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); 
            color: white; 
            box-shadow: 0 2px 6px rgba(107, 114, 128, 0.25);
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Loading button state */
        .btn-loading {
            color: transparent;
        }
        
        .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
        }
        
        @keyframes button-loading-spinner {
            from { transform: rotate(0turn); }
            to { transform: rotate(1turn); }
        }
        .alert { padding: 20px; margin: 20px 0; border-radius: 10px; }
        .alert-info { background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); color: #0c5460; border-left: 5px solid #17a2b8; }
        .alert-success { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; border-left: 5px solid #28a745; }
        .alert-danger { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); color: #721c24; border-left: 5px solid #dc3545; }
        /* LOADING STATES - Enhanced loading feedback */
        .loading { 
            text-align: center; 
            padding: 60px 20px; 
            color: #6b7280; 
        }
        .loading .spinner { 
            border: 4px solid #e5e7eb; 
            border-top: 4px solid #3b82f6; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 15px; 
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: inherit;
            z-index: 10;
        }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            margin-left: 12px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .empty-state-description {
            font-size: 14px;
            margin-bottom: 24px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* MOBILE RESPONSIVE - Enhanced mobile experience */
        @media (max-width: 768px) {
            body { padding: 12px; }
            .container { max-width: 100%; border-radius: 15px; }
            
            .header { 
                padding: 20px 16px; 
                flex-direction: column; 
                gap: 12px; 
                text-align: center; 
            }
            .header h1 { font-size: 20px; }
            
            .role-selector { 
                padding: 16px; 
                border-radius: 12px;
                margin-bottom: 16px;
            }
            .role-selector > div { 
                flex-direction: column; 
                gap: 12px; 
            }
            
            .nav-tabs { 
                margin: 16px 0; 
                display: flex; 
                flex-wrap: wrap; 
                gap: 8px; 
                justify-content: center;
            }
            .nav-tab { 
                padding: 12px 16px; 
                margin: 0; 
                font-size: 13px; 
                flex: 1; 
                min-width: 100px; 
                text-align: center; 
                min-height: 44px; 
                border-radius: 20px;
            }
            
            .stats { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 12px; 
            }
            .stat-card { 
                padding: 16px 12px; 
                text-align: center;
            }
            .stat-value { font-size: 1.6em; }
            
            .tab-content { padding: 20px 16px; }
            
            .expense-item { 
                padding: 16px; 
                margin: 12px 0;
            }
            .expense-item > div { 
                flex-direction: column !important; 
                gap: 8px !important;
            }
            
            .employee-item {
                padding: 16px;
                margin: 12px 0;
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .form-control { 
                font-size: 16px; 
                min-height: 48px; 
                padding: 14px; 
                border-radius: 8px;
            }
            
            .btn { 
                min-height: 44px; 
                padding: 12px 16px; 
                font-size: 13px; 
                width: 100%;
                margin-bottom: 8px;
            }
            .btn-success, .btn-danger { min-width: 100px; }
            
            /* Mobile table scrolling */
            .table-responsive {
                overflow-x: auto;
                border-radius: 8px;
                margin: 16px 0;
            }
            
            table {
                min-width: 600px;
            }
        }
        
        @media (max-width: 480px) {
            body { padding: 8px; }
            .header { padding: 16px 12px; }
            .header h1 { font-size: 18px; }
            
            .role-selector { padding: 14px; }
            
            .nav-tabs { gap: 6px; }
            .nav-tab { 
                padding: 10px 12px; 
                font-size: 12px; 
                min-width: 90px;
                border-radius: 16px;
            }
            
            .stats { grid-template-columns: 1fr; gap: 10px; }
            .stat-card { padding: 14px 10px; }
            .stat-value { font-size: 1.4em; }
            
            .tab-content { padding: 16px 12px; }
            
            .btn { 
                padding: 10px 14px; 
                font-size: 12px; 
                width: 100%; 
                margin: 4px 0; 
            }
            
            .section-header { 
                padding: 15px 16px; 
                font-size: 16px; 
                margin: -16px -12px 20px -12px;
            }
            
            .employee-item { 
                padding: 14px; 
                flex-direction: column; 
                gap: 10px; 
                align-items: flex-start; 
            }
            
            .expense-item { 
                padding: 14px; 
            }
        }
        /* CONSISTENT STATUS BADGES - Matching employee dashboard */
        .status-badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Consistent status colors across all screens */
        .status-approved { 
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
            color: white; 
            box-shadow: 0 2px 6px rgba(34, 197, 94, 0.25);
        }
        .status-rejected { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            color: white; 
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.25);
        }
        .status-returned { 
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); 
            color: white; 
            box-shadow: 0 2px 6px rgba(249, 115, 22, 0.25);
        }
        .status-pending { 
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); 
            color: #92400e; 
            box-shadow: 0 2px 6px rgba(251, 191, 36, 0.25);
        }
        .status-submitted { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
            color: white; 
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.25);
        }
        .status-draft { 
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); 
            color: white; 
            box-shadow: 0 2px 6px rgba(107, 114, 128, 0.25);
        }
        .status-awaiting-signup {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); 
            color: white; 
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.25);
        }
        .status-active {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); 
            color: white; 
            box-shadow: 0 2px 6px rgba(6, 182, 212, 0.25);
        }
        .form-group { margin-bottom: 15px; }
        .form-control { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
        .form-control:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .back-link { color: #667eea; text-decoration: none; font-weight: 600; margin-bottom: 20px; display: inline-block; }
        .back-link:hover { color: #5a6fd8; text-decoration: underline; }
        
        /* TOAST NOTIFICATIONS - Enhanced feedback */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toast-success { 
            background: linear-gradient(135deg, #22c55e, #16a34a); 
        }
        .toast-error { 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
        }
        .toast-warning {
            background: linear-gradient(135deg, #f97316, #ea580c); 
        }
        .toast-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body>
<script>
// Governance: immediately hide role selector for supervisors before page renders
try {
    const u = JSON.parse(localStorage.getItem('user') || '{}');
    if (u.role === 'supervisor') {
        document.write('<style>.role-selector{display:none!important}</style>');
    }
} catch(e) {}
</script>
    <div class="language-toggle">
        <button id="lang-en" onclick="setLanguage('en')" data-i18n="english">EN</button>
        <button id="lang-fr" onclick="setLanguage('fr')" data-i18n="french">FR</button>
    </div>
    
    <div class="container">
        <div class="header">
            <div style="flex-grow: 1;">
                <h1 data-i18n="admin_title">üèõÔ∏è ClaimFlow</h1>
                <p data-i18n="admin_subtitle">Comprehensive expense tracking and approval dashboard</p>
            </div>
            <div style="text-align: right;">
                <button onclick="exportAdminCSV()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); margin-bottom: 10px;" data-i18n="export_csv">üì• Export CSV</button>
                <button onclick="logout()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); margin-bottom: 10px;" data-i18n="logout">üö™ Logout</button>
                <br>
                <a href="/dashboard" class="back-link" style="color: white; opacity: 0.9; font-size: 14px;" data-i18n="employee_portal">‚Üê Employee Portal</a>
            </div>
        </div>

        <div class="role-selector">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h4 style="color: #2c3e50; margin: 0 0 8px 0;" data-i18n="choose_dashboard_view">üë§ Choose Your Dashboard View</h4>
                    <p style="color: #7f8c8d; margin: 0; font-size: 14px;" data-i18n="dashboard_view_desc">Different roles see different data and have different capabilities</p>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;" data-i18n="role_descriptions">
                        üîß <strong>Admin:</strong> All employees, all expenses, full management
                        ‚Ä¢ üëî <strong>Supervisor:</strong> Your team only, approval powers
                    </div>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <select id="role-selector" onchange="changeRole()" class="form-control" style="width: auto; min-width: 180px;">
                        <option value="" data-i18n="select_role">Select Your Role...</option>
                        <option value="admin" data-i18n="system_administrator">üîß System Administrator</option>
                        <option value="supervisor" data-i18n="supervisor_manager">üëî Supervisor/Manager</option>
                    </select>
                    <div id="supervisor-selector" style="display: none;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;" data-i18n="choose_supervisor">Choose your name to see your team:</div>
                        <select id="supervisor-employee-selector" onchange="selectSupervisor()" class="form-control" style="width: auto; min-width: 200px;">
                            <option value="" data-i18n="select_name">Select Your Name...</option>
                        </select>
                    </div>
                    <div id="current-role" style="display: none; padding: 10px 16px; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-radius: 8px; color: #155724; font-weight: 600; font-size: 14px;"></div>
                </div>
            </div>
        </div>

        <div class="nav-tabs" id="nav-tabs" style="display: none;" role="tablist" aria-label="Dashboard sections">
            <button class="nav-tab active" onclick="showTab('expenses')" id="expenses-tab-btn" role="tab" aria-selected="true" 
                    aria-controls="expenses-tab" tabindex="0" data-i18n="expenses_tab">üìä Expenses Dashboard</button>
            <button class="nav-tab" onclick="showTab('employees')" id="employees-tab-btn" role="tab" aria-selected="false" 
                    aria-controls="employees-tab" tabindex="-1" data-i18n="employees_tab">üë• Employee Directory</button>
            <button class="nav-tab" onclick="showTab('chart')" id="chart-tab-btn" role="tab" aria-selected="false" 
                    aria-controls="chart-tab" tabindex="-1" data-i18n="org_chart">üè¢ Organization Chart</button>
            <button class="nav-tab" onclick="showTab('travel-auth')" id="travel-auth-tab-btn" role="tab" aria-selected="false" 
                    aria-controls="travel-auth-tab" tabindex="-1">‚úàÔ∏è Travel Auth</button>
            <button class="nav-tab" onclick="showTab('sage300')" id="sage300-tab-btn" style="display: none;" role="tab" 
                    aria-selected="false" aria-controls="sage300-tab" tabindex="-1" data-i18n="sage_tab">üí∞ Sage 300</button>
            <button class="nav-tab" onclick="showTab('njc-rates')" id="njc-rates-tab-btn" style="display: none;" role="tab" 
                    aria-selected="false" aria-controls="njc-rates-tab" tabindex="-1" data-i18n="njc_tab">üìã NJC Rates</button>
        </div>

        <div class="stats" id="dashboard-stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="total-expenses">-</div>
                <div class="stat-label" data-i18n="total_expenses">Total Expenses</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-amount">-</div>
                <div class="stat-label" data-i18n="total_amount">Total Amount</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="approved-amount">-</div>
                <div class="stat-label" data-i18n="approved_amount">Approved Amount</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pending-count">-</div>
                <div class="stat-label" data-i18n="pending_approval">Pending Approval</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="unique-employees">-</div>
                <div class="stat-label" id="employees-stat-label" data-i18n="total_employees">Total Employees</div>
            </div>
        </div>

        <div id="expenses-tab" class="tab-content active" role="tabpanel" aria-labelledby="expenses-tab-btn">
            <div class="section-header">
                <span id="expenses-section-title">üìä All Expenses (Admin View)</span>
            </div>
            
            <!-- Search/Filter Box -->
            <div style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <label for="expense-search" style="font-weight: 500; color: #495057;" data-i18n="search_label">üîç Search:</label>
                    <input type="text" 
                           id="expense-search" 
                           placeholder="Filter by employee name, expense type, status, or vendor..." data-i18n="search_expenses_placeholder"
                           style="flex: 1; min-width: 300px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;"
                           autocomplete="off"
                           aria-describedby="search-help"
                           oninput="debounceSearch()">
                    <button type="button" 
                            id="clear-search" 
                            style="padding: 8px 15px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;"
                            title="Clear search filter">
                        Clear
                    </button>
                </div>
                <div style="margin-top: 8px; font-size: 13px; color: #6c757d;">
                    Search across employee names, expense types (meal types), approval status, vendors, and amounts
                </div>
            </div>

            <!-- Bulk Actions Bar (Supervisors Only) -->
            <div id="bulk-actions-bar" style="display: none; margin-bottom: 20px; background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); padding: 15px; border-radius: 8px; border: 2px solid #4caf50;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div style="font-weight: 600; color: #2e7d32;">
                        <input type="checkbox" id="select-all-expenses" onchange="toggleAllExpenseSelection()" style="margin-right: 8px;">
                        <label for="select-all-expenses" style="cursor: pointer;">Select All Pending</label>
                    </div>
                    <div style="color: #2e7d32; font-size: 14px;">
                        <span id="selected-count">0</span> expenses selected
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="bulk-approve-btn" onclick="bulkApproveExpenses()" 
                                style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: none;">
                            ‚úÖ Bulk Approve (<span id="approve-count">0</span>)
                        </button>
                        <button id="bulk-reject-btn" onclick="bulkRejectExpenses()" 
                                style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: none;">
                            ‚ùå Bulk Reject (<span id="reject-count">0</span>)
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="expenses-container" aria-live="polite" aria-label="Expenses list">
                <div class="loading">
                    <div class="spinner" role="status" aria-label="Loading expenses"></div>
                    <p data-i18n="loading_expenses">Loading expenses...</p>
                </div>
            </div>
        </div>

        <div id="employees-tab" class="tab-content">
            <div class="section-header">
                <span id="employees-section-title">üë• Employee Directory</span>
                <div style="float: right;" id="employee-actions">
                    <button class="btn btn-primary" onclick="showAddEmployeeForm()" id="add-employee-btn" style="display: none;" title="Add a new employee to the system" data-i18n="add_new_employee">‚ûï Add New Employee</button>
                </div>
            </div>
            <div style="background: #f8f9ff; padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;" id="employee-help">
                <div style="font-size: 14px; color: #2c3e50; margin-bottom: 6px;">
                    <strong data-i18n="managing_employees">üí° Managing Employees</strong>
                </div>
                <div style="font-size: 13px; color: #666; line-height: 1.4;">
                    <span id="employee-help-text" data-i18n="admin_help_text">View and manage employee information. Admins can add, edit, and organize reporting structure.</span>
                </div>
            </div>
            
            <!-- Add Employee Form (Hidden by default) -->
            <div id="add-employee-form" style="display: none; background: linear-gradient(135deg, #f8fcff 0%, #e8f4fd 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                <h4 style="margin-bottom: 15px; color: #2c3e50;" data-i18n="add_new_employee">‚ûï Add New Employee</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label for="new-employee-name" data-i18n="full_name">Full Name *</label>
                        <input type="text" id="new-employee-name" class="form-control" placeholder="John Smith" required>
                    </div>
                    <div class="form-group">
                        <label for="new-employee-number" data-i18n="employee_number">Employee Number *</label>
                        <input type="text" id="new-employee-number" class="form-control" placeholder="EMP001" required>
                    </div>
                    <div class="form-group">
                        <label for="new-employee-email" data-i18n="email">Email Address *</label>
                        <input type="email" id="new-employee-email" class="form-control" placeholder="john.smith@company.com" required>
                    </div>
                    <div class="form-group">
                        <label for="new-employee-position" data-i18n="position">Position</label>
                        <input type="text" id="new-employee-position" class="form-control" placeholder="Financial Analyst">
                    </div>
                    <div class="form-group">
                        <label for="new-employee-department" data-i18n="department">Department</label>
                        <input type="text" id="new-employee-department" class="form-control" placeholder="Finance">
                    </div>
                    <div class="form-group">
                        <label for="new-employee-supervisor" data-i18n="reports_to">Reports To</label>
                        <select id="new-employee-supervisor" class="form-control">
                            <option value="">No supervisor (Top Level)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="new-employee-cost-center">Cost Center</label>
                        <select id="new-employee-cost-center" class="form-control">
                            <option value="">Select Cost Center</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-success" onclick="addEmployee()">‚úÖ Add Employee</button>
                    <button class="btn btn-danger" onclick="hideAddEmployeeForm()">‚ùå Cancel</button>
                </div>
            </div>
            
            <!-- Edit Employee Form (Hidden by default) -->
            <div id="edit-employee-form" style="display: none; background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <h4 style="margin-bottom: 15px; color: #2c3e50;">‚úèÔ∏è Edit Employee</h4>
                <input type="hidden" id="edit-employee-id">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label for="edit-employee-name">Full Name *</label>
                        <input type="text" id="edit-employee-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-employee-number">Employee Number *</label>
                        <input type="text" id="edit-employee-number" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-employee-position">Position</label>
                        <input type="text" id="edit-employee-position" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="edit-employee-department">Department</label>
                        <input type="text" id="edit-employee-department" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="edit-employee-supervisor">Reports To</label>
                        <select id="edit-employee-supervisor" class="form-control">
                            <option value="">No supervisor (Top Level)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-employee-cost-center">Cost Center</label>
                        <select id="edit-employee-cost-center" class="form-control">
                            <option value="">Select Cost Center</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-success" onclick="updateEmployee()">‚úÖ Save Changes</button>
                    <button class="btn btn-danger" onclick="hideEditEmployeeForm()">‚ùå Cancel</button>
                </div>
            </div>
            
            <!-- üìã Employee Change History Section (Admin Only) -->
            <div id="employee-audit-section" style="display: none; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #0891b2;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; cursor: pointer;" onclick="toggleEmployeeAuditHistory()">
                    <h4 style="margin: 0; color: #2c3e50; display: flex; align-items: center;">
                        üìã <span style="margin-left: 10px;">Employee Change History</span>
                        <span id="audit-toggle-icon" style="margin-left: auto; font-size: 1.2em;">‚ñº</span>
                    </h4>
                </div>
                <div id="employee-audit-content" style="display: none;">
                    <div style="background: #f8f9ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                        <div style="font-size: 14px; color: #2c3e50; margin-bottom: 6px;">
                            <strong>üìä Governance & Audit Compliance</strong>
                        </div>
                        <div style="font-size: 13px; color: #666; line-height: 1.4;">
                            All employee changes are tracked for audit compliance. This log shows who made changes, when, and what was modified for governance oversight.
                        </div>
                    </div>
                    
                    <!-- Filter Options -->
                    <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div>
                            <label style="font-weight: 600; margin-right: 8px;">Filter by Employee:</label>
                            <select id="audit-employee-filter" onchange="loadEmployeeAuditLog()" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; min-width: 200px;">
                                <option value="">All Employees</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; margin-right: 8px;">Show:</label>
                            <select id="audit-limit" onchange="loadEmployeeAuditLog()" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="50">Last 50 changes</option>
                                <option value="100">Last 100 changes</option>
                                <option value="200">Last 200 changes</option>
                            </select>
                        </div>
                        <button onclick="loadEmployeeAuditLog()" class="btn btn-primary" style="padding: 6px 16px;">üîÑ Refresh</button>
                    </div>
                    
                    <!-- Audit Log Container -->
                    <div id="employee-audit-log-container">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading employee change history...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="employees-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p data-i18n="loading_employees">Loading employees...</p>
                </div>
            </div>
        </div>

        <div id="chart-tab" class="tab-content">
            <div class="section-header">
                <span id="chart-section-title">üè¢ Organization Chart</span>
            </div>
            <div id="org-chart-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading organization chart...</p>
                </div>
            </div>
        </div>

        <!-- ‚úàÔ∏è TRAVEL AUTH TAB -->
        <div id="travel-auth-tab" class="tab-content">
            <div class="section-header">
                <span>‚úàÔ∏è Travel Authorization Approvals</span>
            </div>
            <div id="travel-auth-container" style="margin-top: 15px;">
                <div style="text-align: center; padding: 40px; color: #6c757d;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚úàÔ∏è</div>
                    <p>Loading travel authorizations...</p>
                </div>
            </div>
        </div>

        <!-- üí∞ SAGE 300 TAB (Admin Only) -->
        <div id="sage300-tab" class="tab-content">
            <div class="section-header">
                <span>üí∞ Sage 300 GL Account Mapping</span>
            </div>
            
            <!-- GL Account Mapping Section -->
            <div style="margin-bottom: 40px;">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">üìä GL Account Mapping</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="addGLAccount()">+ Add GL Account</button>
                    <button class="btn btn-warning" onclick="previewSageExport()">üëÅÔ∏è Preview Export</button>
                    <button class="btn btn-success" onclick="exportToSage()">üì• Export to Sage 300</button>
                </div>
                <div id="gl-accounts-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading GL accounts...</p>
                    </div>
                </div>
            </div>
            
            <!-- Cost Center Mapping Section -->
            <div>
                <h3 style="margin-bottom: 20px; color: #2c3e50;">üè¢ Department Cost Centers</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="addCostCenter()">+ Add Cost Center</button>
                </div>
                <div id="cost-centers-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading cost centers...</p>
                    </div>
                </div>
            </div>
            
            <!-- Export Preview Modal -->
            <div id="export-preview-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 80%; overflow: auto;">
                    <h3 style="margin-bottom: 20px;">üìã Sage 300 Export Preview</h3>
                    <div id="export-preview-content" style="font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 400px; overflow: auto; white-space: pre-wrap;"></div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-primary" onclick="closeExportPreview()">Close</button>
                        <button class="btn btn-success" onclick="exportToSage()">Download CSV</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Signup Link Modal -->
        <div id="signup-link-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                <h3 style="margin-bottom: 20px; color: #28a745;">üîó Employee Invitation Created</h3>
                <p style="margin-bottom: 15px;">
                    <strong id="signup-employee-name"></strong> has been added to the system. 
                    Share this signup link with them to complete their account setup:
                </p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #dee2e6;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="text" id="signup-url" readonly style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 12px;" />
                        <button class="btn btn-primary" onclick="copySignupUrl()" style="white-space: nowrap;">üìã Copy</button>
                    </div>
                </div>
                <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; border: 1px solid #b3d9ff; margin: 15px 0;">
                    <p style="margin: 0; font-size: 14px; color: #0066cc;">
                        üí° <strong>Note:</strong> This link expires in 48 hours. The employee must use it to set their password before they can log in.
                    </p>
                </div>
                <div style="margin-top: 20px; text-align: right; gap: 10px; display: flex; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeSignupModal()">Close</button>
                    <button class="btn btn-primary" onclick="copyAndClose()">üìã Copy & Close</button>
                </div>
            </div>
        </div>

        <!-- üìã NJC RATES MANAGEMENT TAB -->
        <div id="njc-rates-tab" class="tab-content">
            <div class="section-header">
                <span>üìã National Joint Council (NJC) Rates Management</span>
            </div>
            
            <!-- Current Rates Overview -->
            <div style="margin-bottom: 40px;">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">üí∞ Current Effective Rates</h3>
                <div id="current-rates-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading current rates...</p>
                    </div>
                </div>
            </div>

            <!-- Add New Rate Form -->
            <div style="margin-bottom: 40px; background: #f8fcff; padding: 25px; border-radius: 12px; border-left: 5px solid #17a2b8;">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">‚ûï Add New Rate Revision</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Rate Type</label>
                        <select id="new-rate-type" class="form-control" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px;">
                            <option value="">Select rate type</option>
                            <option value="breakfast">ü•ê Breakfast</option>
                            <option value="lunch">ü•ó Lunch</option>
                            <option value="dinner">üçΩÔ∏è Dinner</option>
                            <option value="incidentals">üì± Incidentals</option>
                            <option value="private_vehicle">üöó Private Vehicle (per km)</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">New Amount ($)</label>
                        <input type="number" id="new-rate-amount" step="0.01" min="0.01" max="1000" 
                               class="form-control" placeholder="0.00" 
                               style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Effective Date</label>
                        <input type="date" id="new-rate-effective-date" 
                               class="form-control" 
                               style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Province</label>
                        <select id="new-rate-province" class="form-control" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px;">
                            <option value="QC">Quebec (QC)</option>
                            <option value="ON">Ontario (ON)</option>
                            <option value="BC">British Columbia (BC)</option>
                            <option value="AB">Alberta (AB)</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Notes (Optional)</label>
                    <textarea id="new-rate-notes" rows="2" placeholder="Optional notes about this rate revision..."
                              class="form-control" 
                              style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; resize: vertical;"></textarea>
                </div>
                <div id="rate-replacement-preview" style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107; display: none;">
                    <p style="margin: 0; font-weight: 600; color: #856404;">‚ö†Ô∏è This will replace the current rate</p>
                    <p id="replacement-details" style="margin: 5px 0 0 0; color: #856404;"></p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="addNewRate()" id="add-rate-btn">
                        ‚ûï Add New Rate
                    </button>
                    <button class="btn btn-secondary" onclick="clearNewRateForm()">
                        üîÑ Clear Form
                    </button>
                </div>
            </div>

            <!-- Rate History Timeline -->
            <div>
                <h3 style="margin-bottom: 20px; color: #2c3e50;">üìà Rate History Timeline</h3>
                <p style="color: #6c757d; margin-bottom: 20px;">
                    Historical rates are read-only for audit compliance. Only current/future rates can be modified.
                </p>
                <div id="rate-history-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading rate history...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUserRole = '';
        let currentSupervisorId = null;
        let currentSupervisorName = '';
        let searchTimeout = null;

        // Input sanitization utilities
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input.trim().replace(/[<>]/g, '').slice(0, 500);
        }
        
        function sanitizeForDisplay(input) {
            if (typeof input !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }
        
        // Debounced search for better performance
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filterExpenses();
            }, 300);
        }
        
        // Show loading spinner
        function showLoadingSpinner(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="loading" style="text-align: center; padding: 40px;">
                        <div class="spinner" role="status" aria-label="Loading..."></div>
                        <p>Loading...</p>
                    </div>
                `;
            }
        }
        
        // Show better error messages
        function showErrorMessage(containerId, title, message, actionButton = null) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                            <h3>${title}</h3>
                            <p>${message}</p>
                            ${actionButton || ''}
                        </div>
                    </div>
                `;
            }
        }

        // Role management
        async function changeRole() {
            const roleSelector = document.getElementById('role-selector');
            const supervisorSelector = document.getElementById('supervisor-selector');
            const currentRoleDiv = document.getElementById('current-role');
            const role = roleSelector.value;
            
            currentUserRole = role;

            if (role === 'supervisor') {
                supervisorSelector.style.display = 'block';
                currentRoleDiv.style.display = 'none';
                await loadSupervisorOptions();
            } else if (role === 'admin') {
                supervisorSelector.style.display = 'none';
                currentRoleDiv.style.display = 'block';
                currentRoleDiv.textContent = 'üîß System Administrator';
                currentSupervisorId = null;
                currentSupervisorName = '';
                showDashboard();
            } else {
                supervisorSelector.style.display = 'none';
                currentRoleDiv.style.display = 'none';
                currentSupervisorId = null;
                currentSupervisorName = '';
                hideDashboard();
            }
        }

        async function selectSupervisor() {
            const supervisorSelect = document.getElementById('supervisor-employee-selector');
            const currentRoleDiv = document.getElementById('current-role');
            
            currentSupervisorId = supervisorSelect.value;
            
            // FIXED: Better name retrieval with fallback options
            if (supervisorSelect.selectedOptions[0]) {
                const selectedOption = supervisorSelect.selectedOptions[0];
                currentSupervisorName = selectedOption.dataset.name || selectedOption.getAttribute('data-name') || '';
                
                // If still no name, extract from option text (fallback)
                if (!currentSupervisorName) {
                    const optionText = selectedOption.textContent || selectedOption.innerText || '';
                    currentSupervisorName = optionText.split(' (')[0]; // Get name before " (X direct reports)"
                }

            } else {
                currentSupervisorName = '';
            }
            
            if (currentSupervisorId && currentSupervisorName) {
                currentRoleDiv.style.display = 'block';
                currentRoleDiv.textContent = `üë®‚Äçüíº ${currentSupervisorName} (Manager)`;
                showDashboard();
            } else {
                currentRoleDiv.style.display = 'none';
                hideDashboard();
            }
        }

        async function loadSupervisorOptions() {
            try {
                const response = await fetch('/api/employees', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                if (!response.ok) throw new Error('Failed to load employees');
                
                const employees = await response.json();
                
                const supervisorSelect = document.getElementById('supervisor-employee-selector');
                supervisorSelect.innerHTML = '<option value="">Select Your Name...</option>';
                
                // Find employees who have direct reports (are supervisors)
                const supervisors = employees.filter(emp => 
                    employees.some(other => other.supervisor_id == emp.id)
                );
                
                supervisors.forEach(emp => {
                    const directReports = employees.filter(e => e.supervisor_id == emp.id).length;
                    supervisorSelect.innerHTML += `<option value="${emp.id}" data-name="${emp.name}">${emp.name} (${directReports} direct reports)</option>`;
                });
                
            } catch (error) {
                console.error('‚ùå Error loading supervisor options:', error);
                showMessage('danger', '‚ùå Failed to load supervisor options');
            }
        }

        function showDashboard() {
            document.getElementById('nav-tabs').style.display = 'block';
            document.getElementById('dashboard-stats').style.display = 'grid';
            
            updateTabLabels();
            showTab('expenses');
        }

        function hideDashboard() {
            document.getElementById('nav-tabs').style.display = 'none';
            document.getElementById('dashboard-stats').style.display = 'none';
        }

        function updateTabLabels() {
            const expensesBtn = document.getElementById('expenses-tab-btn');
            const employeesBtn = document.getElementById('employees-tab-btn');
            const chartBtn = document.getElementById('chart-tab-btn');
            const sage300Btn = document.getElementById('sage300-tab-btn');
            const addEmployeeBtn = document.getElementById('add-employee-btn');
            
            if (currentUserRole === 'admin') {
                expensesBtn.innerHTML = 'üìä All Expenses';
                employeesBtn.innerHTML = 'üë• Employee Directory';
                chartBtn.innerHTML = 'üè¢ Organization Chart';
                sage300Btn.style.display = 'inline-block';
                document.getElementById('njc-rates-tab-btn').style.display = 'inline-block';
                addEmployeeBtn.style.display = 'inline-block';
                
                document.getElementById('expenses-section-title').textContent = 'üìä All System Expenses (Admin View)';
                document.getElementById('employees-section-title').textContent = 'üë• Complete Employee Directory';
                document.getElementById('chart-section-title').textContent = 'üè¢ Full Organization Chart';
                document.getElementById('employees-stat-label').textContent = 'Total Employees';
                
            } else if (currentUserRole === 'supervisor' && currentSupervisorId) {
                expensesBtn.innerHTML = 'üìä Team Approvals';
                employeesBtn.innerHTML = 'üë• My Team';
                chartBtn.innerHTML = 'üè¢ Team Structure';
                sage300Btn.style.display = 'none'; // Supervisors cannot access Sage 300
                addEmployeeBtn.style.display = 'none'; // Supervisors cannot manage employees
                
                // FIXED: Use fallback text if name is not available
                const supervisorDisplayName = currentSupervisorName || 'Supervisor';

                document.getElementById('expenses-section-title').textContent = `üë®‚Äçüíº ${supervisorDisplayName}'s Team Expenses`;
                document.getElementById('employees-section-title').textContent = `üë• ${supervisorDisplayName}'s Direct Reports`;
                document.getElementById('chart-section-title').textContent = `üè¢ ${supervisorDisplayName}'s Team Structure`;
                document.getElementById('employees-stat-label').textContent = 'Direct Reports';
            }
        }

        function showTab(tabName) {
            // Hide all tab contents and update ARIA
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs and update ARIA
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
                tab.setAttribute('tabindex', '-1');
            });
            
            // Show selected tab and update ARIA
            const activeTab = document.getElementById(tabName + '-tab');
            const activeButton = document.getElementById(tabName + '-tab-btn');
            
            if (activeTab && activeButton) {
                activeTab.classList.add('active');
                activeButton.classList.add('active');
                activeButton.setAttribute('aria-selected', 'true');
                activeButton.setAttribute('tabindex', '0');
            }
            
            // Load tab-specific data
            if (tabName === 'expenses') {
                loadExpensesWithSearch();
            } else if (tabName === 'employees') {
                loadEmployees();
            } else if (tabName === 'chart') {
                loadOrganizationChart();
            } else if (tabName === 'travel-auth') {
                loadTravelAuthApprovals();
            } else if (tabName === 'sage300') {
                loadSage300Data();
            } else if (tabName === 'njc-rates') {
                loadNJCRatesData();
            }
        }

        async function loadExpenses() {
            const container = document.getElementById('expenses-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p data-i18n="loading_expenses">Loading expenses...</p></div>';
            
            try {
                const response = await fetch('/api/expenses', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                
                const allExpenses = await response.json();

                // API already filters by role (supervisor sees team only, admin sees all)
                // Filter out estimate expenses ‚Äî those are travel auth estimates, not actual expenses
                let expenses = allExpenses.filter(e => e.status !== 'estimate');

                await updateDashboardStats(expenses);
                
                if (expenses.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
                                <h3>No Expenses Found</h3>
                                <p>${currentUserRole === 'supervisor' ? 'Your team has not submitted any expenses yet.' : 'No expenses have been submitted to the system yet.'}</p>
                                <a href="/" class="btn btn-primary" style="margin-top: 15px; text-decoration: none;">‚ûï Submit First Expense</a>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Group expenses by trip (or "ungrouped" for non-trip expenses)
                const groups = {};
                expenses.forEach(exp => {
                    const key = exp.trip_id ? `trip-${exp.trip_id}` : 'no-trip';
                    if (!groups[key]) {
                        groups[key] = {
                            tripId: exp.trip_id,
                            tripName: exp.trip_name || null,
                            tripStart: exp.trip_start,
                            tripEnd: exp.trip_end,
                            tripDestination: exp.trip_destination,
                            employeeName: exp.employee_name || exp.employee_name_from_db,
                            expenses: []
                        };
                    }
                    groups[key].expenses.push(exp);
                });

                let html = '';
                // Render trip groups first (pending trips on top)
                const sortedKeys = Object.keys(groups).sort((a, b) => {
                    if (a === 'no-trip') return 1;
                    if (b === 'no-trip') return -1;
                    const aPending = groups[a].expenses.filter(e => e.status === 'pending').length;
                    const bPending = groups[b].expenses.filter(e => e.status === 'pending').length;
                    return bPending - aPending;
                });

                for (const key of sortedKeys) {
                    const group = groups[key];
                    const total = group.expenses.reduce((s, e) => s + parseFloat(e.amount), 0);
                    const pendingExps = group.expenses.filter(e => e.status === 'pending');
                    const approvedExps = group.expenses.filter(e => e.status === 'approved');
                    const rejectedExps = group.expenses.filter(e => e.status === 'rejected');

                    if (group.tripId) {
                        // === TRIP GROUP CARD ===
                        const pendingIds = pendingExps.map(e => e.id);
                        html += `
                        <div style="background: white; border-radius: 12px; border: 2px solid ${pendingExps.length > 0 ? '#f0ad4e' : '#27ae60'}; margin-bottom: 20px; overflow: hidden;">
                            <!-- Trip Header -->
                            <div style="background: linear-gradient(135deg, #2c3e50, #3498db); color: white; padding: 16px 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                    <div>
                                        <div style="font-size: 20px; font-weight: bold;">‚úàÔ∏è ${group.tripName || 'Trip #' + group.tripId}</div>
                                        <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;">
                                            üë§ ${group.employeeName} ¬∑ üìç ${group.tripDestination || 'N/A'} ¬∑ üìÖ ${group.tripStart} ‚Üí ${group.tripEnd}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 24px; font-weight: bold;">$${total.toFixed(2)}</div>
                                        <div style="font-size: 12px; opacity: 0.8;">${group.expenses.length} expenses</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Status Summary -->
                            <div style="display: flex; gap: 12px; padding: 12px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; flex-wrap: wrap;">
                                ${pendingExps.length > 0 ? `<span style="background: #fff3cd; color: #856404; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">‚è≥ ${pendingExps.length} Pending</span>` : ''}
                                ${approvedExps.length > 0 ? `<span style="background: #d4edda; color: #155724; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">‚úÖ ${approvedExps.length} Approved</span>` : ''}
                                ${rejectedExps.length > 0 ? `<span style="background: #f8d7da; color: #721c24; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">‚ùå ${rejectedExps.length} Rejected</span>` : ''}
                            </div>
                            ${pendingExps.length > 0 && currentUserRole === 'supervisor' ? `
                            <!-- Bulk Actions -->
                            <div style="padding: 12px 20px; background: #fff8e1; border-bottom: 1px solid #eee; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <button class="btn btn-success" onclick="bulkApproveTrip([${pendingIds.join(',')}])" style="font-size: 15px; padding: 8px 20px;">
                                    ‚úÖ Approve All ${pendingExps.length} Expenses
                                </button>
                                <button class="btn btn-danger" onclick="bulkRejectTrip([${pendingIds.join(',')}])" style="font-size: 13px; padding: 6px 14px;">
                                    ‚ùå Reject All
                                </button>
                            </div>
                            ` : ''}
                            <!-- Expense Breakdown Table -->
                            <div style="padding: 12px 20px;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid #dee2e6; text-align: left;">
                                            <th style="padding: 8px 4px;">Date</th>
                                            <th style="padding: 8px 4px;">Type</th>
                                            <th style="padding: 8px 4px; text-align: right;">Amount</th>
                                            <th style="padding: 8px 4px; text-align: center;">Status</th>
                                            ${currentUserRole === 'supervisor' ? '<th style="padding: 8px 4px; text-align: center;">Action</th>' : ''}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${group.expenses.sort((a, b) => a.date.localeCompare(b.date) || a.expense_type.localeCompare(b.expense_type)).map(exp => {
                                            const sClass = exp.status === 'approved' ? '#27ae60' : exp.status === 'rejected' ? '#dc3545' : '#f0ad4e';
                                            const sIcon = exp.status === 'approved' ? '‚úÖ' : exp.status === 'rejected' ? '‚ùå' : '‚è≥';
                                            const typeEmoji = {breakfast:'ü•ê',lunch:'ü•ó',dinner:'üçΩÔ∏è',incidentals:'üì±',hotel:'üè®',mileage:'üöó',other:'üìã'}[exp.expense_type] || 'üìã';
                                            return `<tr style="border-bottom: 1px solid #f0f0f0;">
                                                <td style="padding: 8px 4px;">${exp.date}</td>
                                                <td style="padding: 8px 4px;">${typeEmoji} ${exp.meal_name || exp.expense_type}</td>
                                                <td style="padding: 8px 4px; text-align: right; font-weight: 600;">$${parseFloat(exp.amount).toFixed(2)}</td>
                                                <td style="padding: 8px 4px; text-align: center;"><span style="color: ${sClass}; font-weight: 600;">${sIcon}</span></td>
                                                ${currentUserRole === 'supervisor' && exp.status === 'pending' ? `
                                                <td style="padding: 8px 4px; text-align: center;">
                                                    <button onclick="approveExpense(${exp.id})" style="background: #27ae60; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 4px;">‚úÖ</button>
                                                    <button onclick="rejectExpense(${exp.id})" style="background: #dc3545; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚ùå</button>
                                                </td>` : currentUserRole === 'supervisor' ? '<td></td>' : ''}
                                            </tr>`;
                                        }).join('')}
                                        <tr style="border-top: 2px solid #dee2e6; font-weight: bold;">
                                            <td style="padding: 8px 4px;" colspan="2">Total</td>
                                            <td style="padding: 8px 4px; text-align: right; font-size: 16px; color: #27ae60;">$${total.toFixed(2)}</td>
                                            <td></td>
                                            ${currentUserRole === 'supervisor' ? '<td></td>' : ''}
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                    } else {
                        // === NON-TRIP EXPENSES (original flat cards) ===
                        group.expenses.forEach(expense => {
                            const statusClass = expense.status === 'approved' ? 'status-approved' : 
                                              expense.status === 'rejected' ? 'status-rejected' : 
                                              expense.status === 'returned' ? 'status-returned' : 'status-pending';
                            const statusText = expense.status === 'approved' ? '‚úÖ Approved' :
                                             expense.status === 'rejected' ? '‚ùå Rejected' :
                                             expense.status === 'returned' ? '‚Ü©Ô∏è Returned for Correction' : '‚è≥ Pending';
                            let actionButtons = '';
                            if (expense.status === 'pending') {
                                if (currentUserRole === 'supervisor') {
                                    actionButtons = `
                                        <button class="btn btn-success" onclick="approveExpense(${expense.id})">‚úÖ Approve</button>
                                        <button class="btn btn-warning" onclick="returnExpense(${expense.id})" style="background: #fd7e14; color: white;">‚Ü©Ô∏è Return</button>
                                        <button class="btn btn-danger" onclick="rejectExpense(${expense.id})">‚ùå Reject</button>
                                    `;
                                } else if (currentUserRole === 'admin') {
                                    actionButtons = `<button class="btn btn-warning" onclick="deleteExpense(${expense.id})">üóëÔ∏è Delete</button>`;
                                }
                            }
                            html += `
                            <div class="expense-item">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; flex-wrap: wrap;">
                                    <div style="flex-grow: 1;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px;">
                                            <div style="font-weight: bold; color: #2c3e50; font-size: 18px;">
                                                ${expense.meal_name || expense.expense_type} ‚Ä¢ ${expense.employee_name}
                                            </div>
                                            <div class="status-badge ${statusClass}">${statusText}</div>
                                        </div>
                                        <div style="color: #666; font-size: 14px; margin-bottom: 12px;">
                                            <span style="color: #27ae60; font-size: 20px; font-weight: bold;">$${parseFloat(expense.amount).toFixed(2)}</span> ‚Ä¢ 
                                            üìÖ ${expense.date} ‚Ä¢ üìç ${expense.location || 'N/A'}
                                        </div>
                                        ${actionButtons ? `<div style="margin-top: 10px;">${actionButtons}</div>` : ''}
                                    </div>
                                    ${expense.receipt_photo ? `<img src="${expense.receipt_photo}" alt="Receipt" style="max-width: 80px; border-radius: 8px; cursor: pointer; border: 2px solid #ddd;" onclick="viewReceipt('${expense.receipt_photo}')">` : ''}
                                </div>
                            </div>`;
                        });
                    }
                }
                container.innerHTML = html;
                
            } catch (error) {
                console.error('‚ùå Error loading expenses:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                            <h3>Error Loading Expenses</h3>
                            <p>Failed to load expenses: ${error.message}</p>
                            <button class="btn btn-primary" onclick="loadExpensesWithSearch()" style="margin-top: 15px;">üîÑ Try Again</button>
                        </div>
                    </div>
                `;
            }
        }

        // Global expenses array for filtering
        let allLoadedExpenses = [];

        function filterExpenses() {
            const searchTerm = document.getElementById('expense-search')?.value.toLowerCase().trim() || '';
            
            if (!searchTerm) {
                displayFilteredExpenses(allLoadedExpenses);
                return;
            }
            
            const filtered = allLoadedExpenses.filter(expense => {
                const searchableText = [
                    expense.employee_name || '',
                    expense.meal_name || '',
                    expense.expense_type || '',
                    expense.status || '',
                    expense.vendor || '',
                    expense.location || '',
                    expense.description || '',
                    expense.amount?.toString() || ''
                ].join(' ').toLowerCase();
                
                return searchableText.includes(searchTerm);
            });

            displayFilteredExpenses(filtered);
        }

        function clearSearch() {
            const searchInput = document.getElementById('expense-search');
            if (searchInput) {
                searchInput.value = '';
                displayFilteredExpenses(allLoadedExpenses);
            }
        }

        function displayFilteredExpenses(expenses) {
            const container = document.getElementById('expenses-container');
            
            if (expenses.length === 0) {
                const searchTerm = document.getElementById('expense-search')?.value || '';
                if (searchTerm.trim()) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
                                <h3>No Results Found</h3>
                                <p>No expenses match your search criteria: "<strong>${searchTerm}</strong>"</p>
                                <button class="btn btn-secondary" onclick="clearSearch()" style="margin-top: 15px;">Clear Search</button>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
                                <h3>No Expenses Found</h3>
                                <p>${currentUserRole === 'supervisor' ? 'Your team has not submitted any expenses yet.' : 'No expenses have been submitted to the system yet.'}</p>
                                <a href="/" class="btn btn-primary" style="margin-top: 15px; text-decoration: none;">‚ûï Submit First Expense</a>
                            </div>
                        </div>
                    `;
                }
                return;
            }
            
            container.innerHTML = expenses.map(expense => {
                const statusClass = expense.status === 'approved' ? 'status-approved' : 
                                  expense.status === 'rejected' ? 'status-rejected' : 'status-pending';
                const statusText = expense.status === 'approved' ? '‚úÖ Approved' :
                                 expense.status === 'rejected' ? '‚ùå Rejected' : '‚è≥ Pending';
                
                let actionButtons = '';
                if (expense.status === 'pending') {
                    if (currentUserRole === 'supervisor') {
                        actionButtons = `
                            <button class="btn btn-success" onclick="approveExpense(${expense.id})">‚úÖ Approve</button>
                            <button class="btn btn-danger" onclick="rejectExpense(${expense.id})">‚ùå Reject</button>
                        `;
                    } else if (currentUserRole === 'admin') {
                        actionButtons = `
                            <div style="color: #6c757d; font-size: 12px; margin-bottom: 5px;">‚ö†Ô∏è Admin role: System management only</div>
                            <button class="btn btn-warning" onclick="deleteExpense(${expense.id})">üóëÔ∏è Delete</button>
                        `;
                    }
                }
                
                return `
                    <div class="expense-item">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; flex-wrap: wrap;">
                            <div style="flex-grow: 1; min-width: 300px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px;">
                                    <div style="font-weight: bold; color: #2c3e50; font-size: 18px;">
                                        ${expense.meal_name || expense.expense_type} ‚Ä¢ ${expense.employee_name}
                                    </div>
                                    <div class="status-badge ${statusClass}">
                                        ${statusText}
                                    </div>
                                </div>
                                <div style="color: #666; font-size: 14px; margin-bottom: 12px;">
                                    <span style="color: #27ae60; font-size: 20px; font-weight: bold;">$${parseFloat(expense.amount).toFixed(2)}</span> ‚Ä¢ 
                                    üìÖ ${expense.date} ‚Ä¢ 
                                    üìç ${expense.location || 'No location'}
                                    ${expense.vendor ? ` ‚Ä¢ üè™ ${expense.vendor}` : ''}
                                </div>
                                ${expense.description ? `
                                    <div style="font-size: 13px; color: #666; margin-bottom: 12px; padding: 8px 12px; background: #f8f9fa; border-radius: 6px;">
                                        üìã ${expense.description}
                                    </div>
                                ` : ''}
                                ${expense.receipt_path ? `
                                    <button class="btn btn-secondary" onclick="viewReceipt('${expense.receipt_path}')" style="font-size: 12px;">
                                        üìé View Receipt
                                    </button>
                                ` : ''}
                            </div>
                            ${actionButtons ? `
                                <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
                                    ${actionButtons}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadExpensesWithSearch() {
            const container = document.getElementById('expenses-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p data-i18n="loading_expenses">Loading expenses...</p></div>';
            
            try {
                const response = await fetch('/api/expenses', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                
                const rawExpenses = await response.json();
                // Filter out estimate expenses ‚Äî those are travel auth estimates, not actual expenses
                allLoadedExpenses = rawExpenses.filter(e => e.status !== 'estimate');

                await updateDashboardStats(allLoadedExpenses);
                displayFilteredExpenses(allLoadedExpenses);
                
                // Show bulk actions bar for supervisors with pending expenses
                if (currentUserRole === 'supervisor') {
                    setTimeout(() => {
                        const pendingExpenses = document.querySelectorAll('.expense-checkbox');
                        const bulkActionsBar = document.getElementById('bulk-actions-bar');
                        if (pendingExpenses.length > 0) {
                            bulkActionsBar.style.display = 'block';
                        } else {
                            bulkActionsBar.style.display = 'none';
                        }
                    }, 100);
                }
                
                // Setup search event listeners (only once)
                setupSearchListeners();
                
            } catch (error) {
                console.error('‚ùå Error loading expenses:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                            <h3>Error Loading Expenses</h3>
                            <p>Failed to load expenses: ${error.message}</p>
                            <button class="btn btn-primary" onclick="loadExpensesWithSearch()" style="margin-top: 15px;">üîÑ Try Again</button>
                        </div>
                    </div>
                `;
            }
        }

        function setupSearchListeners() {
            const searchInput = document.getElementById('expense-search');
            const clearButton = document.getElementById('clear-search');
            
            if (searchInput && !searchInput.hasAttribute('data-listeners-attached')) {
                searchInput.addEventListener('input', filterExpenses);
                searchInput.addEventListener('keyup', filterExpenses);
                searchInput.setAttribute('data-listeners-attached', 'true');

            }
            
            if (clearButton && !clearButton.hasAttribute('data-listeners-attached')) {
                clearButton.addEventListener('click', clearSearch);
                clearButton.setAttribute('data-listeners-attached', 'true');

            }
        }

        function toggleAllExpenseSelection() {
            const selectAll = document.getElementById('select-all-expenses');
            const checkboxes = document.querySelectorAll('.expense-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateBulkActionButtons();
        }

        function updateBulkActionButtons() {
            const checkedBoxes = document.querySelectorAll('.expense-checkbox:checked');
            const selectedCount = checkedBoxes.length;
            
            document.getElementById('selected-count').textContent = selectedCount;
            document.getElementById('approve-count').textContent = selectedCount;
            document.getElementById('reject-count').textContent = selectedCount;
            
            const bulkApproveBtn = document.getElementById('bulk-approve-btn');
            const bulkRejectBtn = document.getElementById('bulk-reject-btn');
            
            if (selectedCount > 0) {
                bulkApproveBtn.style.display = 'inline-block';
                bulkRejectBtn.style.display = 'inline-block';
            } else {
                bulkApproveBtn.style.display = 'none';
                bulkRejectBtn.style.display = 'none';
            }
            
            // Update "Select All" checkbox state
            const totalCheckboxes = document.querySelectorAll('.expense-checkbox');
            const selectAllCheckbox = document.getElementById('select-all-expenses');
            
            if (selectedCount === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (selectedCount === totalCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }

        async function bulkApproveExpenses() {
            const checkedBoxes = document.querySelectorAll('.expense-checkbox:checked');
            const expenseIds = Array.from(checkedBoxes).map(cb => cb.dataset.expenseId);
            
            if (expenseIds.length === 0) {
                showMessage('warning', '‚ö†Ô∏è Please select expenses to approve');
                return;
            }
            
            const confirmMsg = `üöÄ Bulk Approve ${expenseIds.length} Expenses?\n\nThis will:\n‚úÖ Mark all selected expenses as approved\nüí∞ Make them available for payment processing\nüìß Notify all employees\n\nThis action cannot be undone.`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            let successCount = 0;
            let errorCount = 0;
            
            showMessage('info', `‚è≥ Processing ${expenseIds.length} expenses...`);
            
            for (const expenseId of expenseIds) {
                try {
                    const response = await fetch(`/api/expenses/${expenseId}/approve`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${sessionId}`
                        },
                        body: JSON.stringify({ 
                            comment: 'Bulk approved for payment processing',
                            approver: currentSupervisorName
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                    console.error(`Error approving expense ${expenseId}:`, error);
                }
            }
            
            if (successCount > 0) {
                showMessage('success', `‚úÖ Successfully approved ${successCount} expenses!`);
            }
            if (errorCount > 0) {
                showMessage('warning', `‚ö†Ô∏è ${errorCount} expenses failed to approve. Please try individually.`);
            }
            
            // Refresh the list and reset selections
            await loadExpensesWithSearch();
        }

        async function bulkRejectExpenses() {
            const checkedBoxes = document.querySelectorAll('.expense-checkbox:checked');
            const expenseIds = Array.from(checkedBoxes).map(cb => cb.dataset.expenseId);
            
            if (expenseIds.length === 0) {
                showMessage('warning', '‚ö†Ô∏è Please select expenses to reject');
                return;
            }
            
            const reason = prompt(`üìù Bulk Rejection Reason (Required)\n\nYou are rejecting ${expenseIds.length} expenses.\nPlease provide a clear reason that applies to all selected expenses:\n\nEmployee(s) will see this message:`);
            
            if (!reason || !reason.trim()) {
                showMessage('danger', '‚ö†Ô∏è Rejection reason is required for audit compliance.');
                return;
            }
            
            if (reason.trim().length < 10) {
                showMessage('danger', '‚ö†Ô∏è Please provide a more detailed reason (at least 10 characters).');
                return;
            }
            
            let successCount = 0;
            let errorCount = 0;
            
            showMessage('info', `‚è≥ Processing ${expenseIds.length} rejections...`);
            
            for (const expenseId of expenseIds) {
                try {
                    const response = await fetch(`/api/expenses/${expenseId}/reject`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${sessionId}`
                        },
                        body: JSON.stringify({ 
                            reason: reason.trim(),
                            approver: currentSupervisorName
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                    console.error(`Error rejecting expense ${expenseId}:`, error);
                }
            }
            
            if (successCount > 0) {
                showMessage('success', `‚ùå Successfully rejected ${successCount} expenses`);
            }
            if (errorCount > 0) {
                showMessage('warning', `‚ö†Ô∏è ${errorCount} expenses failed to reject. Please try individually.`);
            }
            
            // Refresh the list and reset selections
            await loadExpensesWithSearch();
        }

        async function updateDashboardStats(expenses) {
            try {
                const totalAmount = expenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
                const approvedAmount = expenses.filter(exp => exp.status === 'approved')
                    .reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
                const pendingCount = expenses.filter(exp => exp.status === 'pending').length;
                
                let uniqueEmployees = 0;
                if (currentUserRole === 'supervisor' && currentSupervisorId) {
                    const employeesResponse = await fetch('/api/employees', {
                        headers: { 'Authorization': `Bearer ${sessionId}` }
                    });
                    const allEmployees = await employeesResponse.json();
                    uniqueEmployees = allEmployees.filter(emp => emp.supervisor_id == currentSupervisorId).length;
                } else if (currentUserRole === 'admin') {
                    const employeesResponse = await fetch('/api/employees', {
                        headers: { 'Authorization': `Bearer ${sessionId}` }
                    });
                    const allEmployees = await employeesResponse.json();
                    uniqueEmployees = allEmployees.length;
                }
                
                document.getElementById('total-expenses').textContent = expenses.length;
                document.getElementById('total-amount').textContent = `$${totalAmount.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
                document.getElementById('approved-amount').textContent = `$${approvedAmount.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
                document.getElementById('pending-count').textContent = pendingCount;
                document.getElementById('unique-employees').textContent = uniqueEmployees;
                
            } catch (error) {
                console.error('‚ùå Error updating dashboard stats:', error);
            }
        }

        async function loadEmployees() {
            const container = document.getElementById('employees-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p data-i18n="loading_employees">Loading employees...</p></div>';
            
            try {
                const response = await fetch('/api/employees', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                if (!response.ok) throw new Error('Failed to load employees');
                
                const allEmployees = await response.json();

                // Store employees globally for forms
                window.allEmployees = allEmployees;
                
                // Show audit section for admins
                if (currentUserRole === 'admin') {
                    document.getElementById('employee-audit-section').style.display = 'block';
                    populateAuditEmployeeFilter(allEmployees);
                } else {
                    document.getElementById('employee-audit-section').style.display = 'none';
                }
                
                let employees = allEmployees;
                if (currentUserRole === 'supervisor' && currentSupervisorId) {
                    employees = allEmployees.filter(emp => emp.supervisor_id == currentSupervisorId);
                }
                
                if (employees.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üë•</div>
                                <h3>No Employees Found</h3>
                                <p>No employees in the directory yet.</p>
                                ${currentUserRole === 'admin' ? '<button class="btn btn-primary" onclick="showAddEmployeeForm()" style="margin-top: 15px;">‚ûï Add First Employee</button>' : ''}
                            </div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = employees.map(emp => {
                    let actionButtons = '';
                    if (currentUserRole === 'admin') {
                        let resendButton = '';
                        if (!emp.password_hash || emp.is_active === 0) {
                            resendButton = `<button class="btn btn-info" onclick="resendInvite(${emp.id}, '${emp.name}')" style="margin-right: 5px;">üîó Resend Invite</button>`;
                        }
                        
                        actionButtons = `
                            <div style="margin-top: 8px;">
                                ${resendButton}
                                <button class="btn btn-warning" onclick="editEmployee(${emp.id})" style="margin-right: 5px;">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger" onclick="deleteEmployee(${emp.id}, '${emp.name}')">üóëÔ∏è Delete</button>
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="employee-item">
                            <div style="flex-grow: 1;">
                                <div style="font-weight: bold; color: #2c3e50; font-size: 16px;">${emp.name}</div>
                                <div style="color: #666; font-size: 14px; margin-top: 4px;">
                                    ${emp.position || 'No position'} ‚Ä¢ ${emp.department || 'No department'}
                                    ${emp.supervisor_name ? ` ‚Ä¢ Reports to: ${emp.supervisor_name}` : ' ‚Ä¢ Top Level Manager'}
                                </div>
                                ${actionButtons}
                            </div>
                            <div style="text-align: right;">
                                <span style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); color: #1976d2; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;">
                                    ${emp.employee_number || 'No ID'}
                                </span>
                                ${(!emp.password_hash || emp.is_active === 0) ? 
                                    `<div style="background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 6px; font-size: 11px; margin-top: 4px; border: 1px solid #ffeaa7;">
                                        ‚è≥ Awaiting Signup
                                    </div>` : 
                                    `<div style="background: #d1e7dd; color: #0f5132; padding: 4px 8px; border-radius: 6px; font-size: 11px; margin-top: 4px; border: 1px solid #a3cfbb;">
                                        ‚úÖ Active
                                    </div>`
                                }
                                ${currentUserRole === 'admin' ? `<div style="color: #666; font-size: 12px; margin-top: 5px;">ID: ${emp.id}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('‚ùå Error loading employees:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                            <h3>Error Loading Employees</h3>
                            <p>Failed to load employees: ${error.message}</p>
                            <button class="btn btn-primary" onclick="loadEmployees()" style="margin-top: 15px;">üîÑ Try Again</button>
                        </div>
                    </div>
                `;
            }
        }

        // üë• Employee Management Functions

        function showAddEmployeeForm() {
            document.getElementById('add-employee-form').style.display = 'block';
            document.getElementById('edit-employee-form').style.display = 'none';
            populateSupervisorDropdown('new-employee-supervisor');
            populateCostCenterDropdown('new-employee-cost-center');
            document.getElementById('new-employee-name').focus();
        }

        function hideAddEmployeeForm() {
            document.getElementById('add-employee-form').style.display = 'none';
            // Clear form
            document.getElementById('new-employee-name').value = '';
            document.getElementById('new-employee-number').value = '';
            document.getElementById('new-employee-email').value = '';
            document.getElementById('new-employee-position').value = '';
            document.getElementById('new-employee-department').value = '';
            document.getElementById('new-employee-supervisor').value = '';
            document.getElementById('new-employee-cost-center').value = '';
        }

        async function editEmployee(employeeId) {
            const employee = window.allEmployees.find(emp => emp.id === employeeId);
            if (!employee) {
                showMessage('danger', '‚ùå Employee not found');
                return;
            }
            
            document.getElementById('edit-employee-form').style.display = 'block';
            document.getElementById('add-employee-form').style.display = 'none';
            
            // Populate form
            document.getElementById('edit-employee-id').value = employee.id;
            document.getElementById('edit-employee-name').value = employee.name;
            document.getElementById('edit-employee-number').value = employee.employee_number || '';
            document.getElementById('edit-employee-position').value = employee.position || '';
            document.getElementById('edit-employee-department').value = employee.department || '';
            
            populateSupervisorDropdown('edit-employee-supervisor', employeeId);
            document.getElementById('edit-employee-supervisor').value = employee.supervisor_id || '';
            
            await populateCostCenterDropdown('edit-employee-cost-center');
            document.getElementById('edit-employee-cost-center').value = employee.cost_center_id || '';
            
            document.getElementById('edit-employee-name').focus();
        }

        function hideEditEmployeeForm() {
            document.getElementById('edit-employee-form').style.display = 'none';
        }

        function populateSupervisorDropdown(selectId, excludeEmployeeId = null) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">No supervisor (Top Level)</option>';
            
            if (window.allEmployees) {
                window.allEmployees
                    .filter(emp => emp.id != excludeEmployeeId) // Don't let someone report to themselves
                    .forEach(emp => {
                        select.innerHTML += `<option value="${emp.id}">${emp.name} - ${emp.position || 'No Position'}</option>`;
                    });
            }
        }

        async function populateCostCenterDropdown(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select Cost Center</option>';
            
            try {
                const response = await fetch('/api/sage/cost-centers', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                const result = await response.json();
                const centers = result.success ? result.data : (Array.isArray(result) ? result : []);
                
                centers.filter(cc => cc.is_active).forEach(cc => {
                    select.innerHTML += `<option value="${cc.id}">${cc.cost_center_code} - ${cc.cost_center_name} (${cc.department})</option>`;
                });
            } catch (error) {
                console.error('Error loading cost centers:', error);
            }
        }

        async function addEmployee() {
            const name = document.getElementById('new-employee-name').value.trim();
            const employeeNumber = document.getElementById('new-employee-number').value.trim();
            const email = document.getElementById('new-employee-email').value.trim();
            const position = document.getElementById('new-employee-position').value.trim();
            const department = document.getElementById('new-employee-department').value.trim();
            const supervisorId = document.getElementById('new-employee-supervisor').value;
            const costCenterId = document.getElementById('new-employee-cost-center').value;
            
            if (!name) {
                showMessage('danger', '‚ùå Employee name is required');
                document.getElementById('new-employee-name').focus();
                return;
            }
            
            if (!employeeNumber) {
                showMessage('danger', '‚ùå Employee number is required');
                document.getElementById('new-employee-number').focus();
                return;
            }
            
            if (!email || !email.includes('@')) {
                showMessage('danger', '‚ùå Valid email address is required');
                document.getElementById('new-employee-email').focus();
                return;
            }
            
            try {
                const response = await fetch('/api/employees', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({
                        name,
                        employee_number: employeeNumber,
                        email,
                        position: position || null,
                        department: department || null,
                        supervisor_id: supervisorId || null,
                        cost_center_id: costCenterId || null
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Employee added successfully!');
                    hideAddEmployeeForm();
                    loadEmployees();
                    // Show signup link modal
                    showSignupLinkModal(result.signupUrl, name);
                } else {
                    showMessage('danger', result.error || 'Failed to add employee');
                }
            } catch (error) {
                console.error('‚ùå Error adding employee:', error);
                showMessage('danger', '‚ùå Failed to add employee');
            }
        }

        async function updateEmployee() {
            const id = document.getElementById('edit-employee-id').value;
            const name = document.getElementById('edit-employee-name').value.trim();
            const employeeNumber = document.getElementById('edit-employee-number').value.trim();
            const position = document.getElementById('edit-employee-position').value.trim();
            const department = document.getElementById('edit-employee-department').value.trim();
            const supervisorId = document.getElementById('edit-employee-supervisor').value;
            const costCenterId = document.getElementById('edit-employee-cost-center').value;
            
            if (!name) {
                showMessage('danger', '‚ùå Employee name is required');
                document.getElementById('edit-employee-name').focus();
                return;
            }
            
            if (!employeeNumber) {
                showMessage('danger', '‚ùå Employee number is required');
                document.getElementById('edit-employee-number').focus();
                return;
            }
            
            try {
                const response = await fetch(`/api/employees/${id}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({
                        name,
                        employee_number: employeeNumber,
                        position: position || null,
                        department: department || null,
                        supervisor_id: supervisorId || null,
                        cost_center_id: costCenterId || null
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Employee updated successfully!');
                    hideEditEmployeeForm();
                    loadEmployees();
                } else {
                    showMessage('danger', result.error || 'Failed to update employee');
                }
            } catch (error) {
                console.error('‚ùå Error updating employee:', error);
                showMessage('danger', '‚ùå Failed to update employee');
            }
        }

        async function deleteEmployee(employeeId, employeeName) {
            if (!confirm(`üóëÔ∏è Are you sure you want to delete "${employeeName}"?\n\nThis action cannot be undone.\n\nNote: Employees with expenses or direct reports cannot be deleted.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/employees/${employeeId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', `‚úÖ Employee "${employeeName}" deleted successfully`);
                    loadEmployees();
                } else {
                    showMessage('danger', result.error || 'Failed to delete employee');
                }
            } catch (error) {
                console.error('‚ùå Error deleting employee:', error);
                showMessage('danger', '‚ùå Failed to delete employee');
            }
        }

        async function loadOrganizationChart() {
            const container = document.getElementById('org-chart-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading organization chart...</p></div>';
            
            try {
                const response = await fetch('/api/employees', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                if (!response.ok) throw new Error('Failed to load employees');
                
                const employees = await response.json();
                
                // Recursive org chart renderer
                function renderNode(person, allEmps, depth) {
                    const reports = allEmps.filter(e => e.supervisor_id == person.id);
                    const colors = ['#3498db','#2ecc71','#e67e22','#9b59b6'];
                    const color = colors[Math.min(depth, 3)];
                    const icon = depth === 0 ? 'üë®‚Äçüíº' : reports.length > 0 ? 'üëî' : 'üë§';
                    const roleTag = person.role === 'admin' ? ' üîë Admin' : person.role === 'supervisor' ? ' üìã Supervisor' : '';
                    let html = `<div style="margin-bottom:${depth===0?20:8}px; margin-left:${depth*30}px; padding:${depth===0?18:10}px; background:linear-gradient(135deg,#fff 0%,#f8f9fa 100%); border-radius:${depth===0?12:8}px; border-left:${depth===0?5:3}px solid ${color};">
                        <div style="font-weight:bold; color:#2c3e50; font-size:${Math.max(14,18-depth*2)}px;">${icon} ${person.name} - ${person.position||'Employee'}${roleTag}</div>
                        <div style="color:#666; font-size:13px;">${person.department||''} ‚Ä¢ ${person.employee_number||''}${reports.length>0?' ‚Ä¢ '+reports.length+' direct report'+(reports.length>1?'s':''):''}</div>
                    </div>`;
                    reports.forEach(r => { html += renderNode(r, allEmps, depth+1); });
                    return html;
                }
                
                const roots = employees.filter(e => !e.supervisor_id);
                let treeHtml = '';
                roots.forEach(r => { treeHtml += renderNode(r, employees, 0); });
                
                container.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üè¢</div>
                            <h3 style="color: #2c3e50;">Organization Structure</h3>
                            <p style="color: #6c757d;">Showing ${employees.length} employees in organizational hierarchy</p>
                        </div>
                        <div style="max-width: 800px; margin: 0 auto;">
                            ${treeHtml}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('‚ùå Error loading organization chart:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                            <h3>Error Loading Organization Chart</h3>
                            <p>Failed to load chart: ${error.message}</p>
                            <button class="btn btn-primary" onclick="loadOrganizationChart()" style="margin-top: 15px;">üîÑ Try Again</button>
                        </div>
                    </div>
                `;
            }
        }

        async function bulkApproveTrip(expenseIds) {
            if (!confirm(`Approve all ${expenseIds.length} expenses?`)) return;
            let success = 0, fail = 0;
            for (const id of expenseIds) {
                try {
                    const r = await fetch(`/api/expenses/${id}/approve`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${sessionId}` },
                        body: JSON.stringify({ comment: 'Bulk approved' })
                    });
                    if (r.ok) success++; else fail++;
                } catch(e) { fail++; }
            }
            alert(`‚úÖ ${success} approved${fail > 0 ? `, ‚ùå ${fail} failed` : ''}`);
            loadExpenses();
        }

        async function bulkRejectTrip(expenseIds) {
            const reason = prompt('Rejection reason for all expenses:');
            if (!reason) return;
            let success = 0, fail = 0;
            for (const id of expenseIds) {
                try {
                    const r = await fetch(`/api/expenses/${id}/reject`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${sessionId}` },
                        body: JSON.stringify({ reason })
                    });
                    if (r.ok) success++; else fail++;
                } catch(e) { fail++; }
            }
            alert(`‚ùå ${success} rejected${fail > 0 ? `, ‚ö†Ô∏è ${fail} failed` : ''}`);
            loadExpenses();
        }

        async function approveExpense(expenseId) {
            try {
                const response = await fetch(`/api/expenses/${expenseId}/approve`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({ 
                        comment: 'Approved for payment processing',
                        approver: currentUserRole === 'supervisor' ? currentSupervisorName : 'System Administrator'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Expense approved! Employee will be notified and expense is ready for payment.');
                    loadExpensesWithSearch();
                } else {
                    showMessage('danger', result.error || 'Failed to approve expense - please try again');
                }
            } catch (error) {
                console.error('‚ùå Error approving expense:', error);
                showMessage('danger', '‚ùå Network error: Could not approve expense. Please check your connection.');
            }
        }

        async function rejectExpense(expenseId) {
            const reason = prompt(`üìù Rejection Reason (Required)\n\nPlease provide a clear, detailed reason why this expense cannot be approved.\n\nCommon reasons:\n‚Ä¢ Missing receipt or documentation\n‚Ä¢ Expense outside policy guidelines\n‚Ä¢ Incorrect amount or calculations\n‚Ä¢ Business purpose not clear\n\nEmployee will see this message:`);
            
            if (!reason || !reason.trim()) {
                showMessage('danger', '‚ö†Ô∏è Rejection reason is required for audit compliance and to help the employee understand the issue.');
                return;
            }
            
            if (reason.trim().length < 10) {
                showMessage('danger', '‚ö†Ô∏è Please provide a more detailed reason (at least 10 characters) to help the employee understand and resubmit correctly.');
                return;
            }

            try {
                const response = await fetch(`/api/expenses/${expenseId}/reject`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({ 
                        reason: reason.trim(),
                        approver: currentUserRole === 'supervisor' ? currentSupervisorName : 'System Administrator'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚ùå Expense rejected successfully');
                    loadExpensesWithSearch();
                } else {
                    showMessage('danger', result.error || 'Failed to reject expense');
                }
            } catch (error) {
                console.error('‚ùå Error rejecting expense:', error);
                showMessage('danger', '‚ùå Failed to reject expense');
            }
        }

        // CONCUR ENHANCEMENT: Return expense for correction
        async function returnExpense(expenseId) {
            const reason = prompt(`‚Ü©Ô∏è Return for Correction (Required)\n\nThis is a positive action that asks the employee to make corrections and resubmit.\n\nPlease provide specific guidance on what needs to be corrected:\n\nCommon corrections needed:\n‚Ä¢ Add missing receipt photo\n‚Ä¢ Correct expense date or amount\n‚Ä¢ Add business purpose description\n‚Ä¢ Fix expense category\n\nEmployee will see this message and can resubmit:`);
            
            if (!reason || !reason.trim()) {
                showMessage('danger', '‚ö†Ô∏è Correction guidance is required to help the employee fix the issue.');
                return;
            }
            
            if (reason.trim().length < 10) {
                showMessage('danger', '‚ö†Ô∏è Please provide detailed guidance (at least 10 characters) so the employee knows what to fix.');
                return;
            }

            try {
                const response = await fetch(`/api/expenses/${expenseId}/return`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({ 
                        reason: reason.trim(),
                        approver: currentUserRole === 'supervisor' ? currentSupervisorName : 'System Administrator'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚Ü©Ô∏è Expense returned for correction. Employee will be notified with guidance on what to fix.');
                    loadExpensesWithSearch();
                } else {
                    showMessage('danger', result.error || 'Failed to return expense for correction');
                }
            } catch (error) {
                console.error('‚ùå Error returning expense:', error);
                showMessage('danger', '‚ùå Failed to return expense for correction');
            }
        }

        async function deleteExpense(expenseId) {
            if (!confirm('üóëÔ∏è Are you sure you want to delete this expense?\n\nThis action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/expenses/${expenseId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Expense deleted successfully');
                    loadExpensesWithSearch();
                } else {
                    showMessage('danger', result.error || 'Failed to delete expense');
                }
            } catch (error) {
                console.error('‚ùå Error deleting expense:', error);
                showMessage('danger', '‚ùå Failed to delete expense');
            }
        }

        function viewReceipt(receiptPath) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 2000;
                background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
                padding: 20px; cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = receiptPath;
            img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';
            
            modal.appendChild(img);
            modal.onclick = () => modal.remove();
            document.body.appendChild(modal);
        }

        function showMessage(type, message) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                padding: 15px 20px; border-radius: 10px; color: white; font-weight: 600;
                background: ${type === 'success' ? 'linear-gradient(135deg, #28a745 0%, #20c997 100%)' : 
                           type === 'danger' ? 'linear-gradient(135deg, #dc3545 0%, #e74c3c 100%)' : 
                           'linear-gradient(135deg, #17a2b8 0%, #20c997 100)'};
                max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                transform: translateX(400px); transition: transform 0.3s ease;
            `;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => messageDiv.style.transform = 'translateX(0)', 100);
            
            setTimeout(() => {
                messageDiv.style.transform = 'translateX(400px)';
                setTimeout(() => messageDiv.remove(), 300);
            }, 4000);
        }

        let sessionId = null;
        let currentUser = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            sessionId = localStorage.getItem('sessionId');
            currentUser = JSON.parse(localStorage.getItem('user') || 'null');
            
            if (!sessionId || !currentUser) {
                window.location.href = '/login';
                return;
            }
            
            if (currentUser.role !== 'admin' && currentUser.role !== 'supervisor') {
                alert('Access denied. This page is for supervisors and administrators only.');
                window.location.href = '/dashboard';
                return;
            }
            
            try {
                // Verify session
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                if (!response.ok) {
                    throw new Error('Session expired');
                }
                
                const user = await response.json();
                currentUser = user;
                localStorage.setItem('user', JSON.stringify(user));
                
                // Auto-select role and show dashboard
                document.getElementById('role-selector').value = user.role;
                // Governance: supervisors see ONLY their own team ‚Äî no role switching, no impersonation
                if (user.role === 'supervisor') {
                    // REMOVE role selector from DOM entirely ‚Äî not just hide
                    const roleSelectorDiv = document.querySelector('.role-selector');
                    if (roleSelectorDiv) roleSelectorDiv.remove();
                    // REMOVE supervisor name dropdown ‚Äî they can only see their own team
                    const supervisorSelector = document.getElementById('supervisor-selector');
                    if (supervisorSelector) supervisorSelector.remove();
                    // Set supervisor context directly ‚Äî no dropdown, no options to switch
                    currentUserRole = 'supervisor';
                    currentSupervisorId = user.id;
                    currentSupervisorName = user.name;
                    // Show their name badge directly
                    const currentRoleDiv = document.getElementById('current-role');
                    if (currentRoleDiv) {
                        currentRoleDiv.style.display = 'block';
                        currentRoleDiv.textContent = 'üë§ ' + user.name + ' (Supervisor)';
                    }
                    showDashboard();
                } else if (user.role === 'admin') {
                    // Admin: remove entire role selector ‚Äî admin is the only role, no switching
                    const roleSelectorDiv = document.querySelector('.role-selector');
                    if (roleSelectorDiv) roleSelectorDiv.remove();
                    currentUserRole = 'admin';
                    showDashboard();
                } else {
                    await changeRole();
                }
                
            } catch (error) {
                console.error('Session validation failed:', error);
                localStorage.removeItem('sessionId');
                localStorage.removeItem('user');
                window.location.href = '/login';
            }
            
        });

        // CSV Export for admin
        function exportAdminCSV() {
            fetch('/api/expenses/export/csv', { headers: { 'Authorization': `Bearer ${sessionId}` } })
                .then(r => r.blob())
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'expenses-export.csv'; a.click();
                    URL.revokeObjectURL(url);
                })
                .catch(e => showMessage('danger', '‚ùå Export failed: ' + e.message));
        }

        // Add logout function
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            localStorage.removeItem('sessionId');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        // ‚úàÔ∏è TRAVEL AUTHORIZATION APPROVAL FUNCTIONALITY
        async function loadTravelAuthApprovals() {
            const container = document.getElementById('travel-auth-container');
            try {
                const response = await fetch('/api/travel-auth?view=team', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                if (!response.ok) throw new Error('Failed to load');
                const auths = await response.json();
                
                if (auths.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6c757d;">
                            <div style="font-size: 48px; margin-bottom: 15px;">‚úàÔ∏è</div>
                            <p>No travel authorizations to review.</p>
                        </div>`;
                    return;
                }
                
                // Sort: pending first, then by date
                auths.sort((a, b) => {
                    if (a.status === 'pending' && b.status !== 'pending') return -1;
                    if (b.status === 'pending' && a.status !== 'pending') return 1;
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                
                let html = '';
                const pending = auths.filter(a => a.status === 'pending');
                if (pending.length > 0) {
                    html += `<div style="background: #fff3cd; padding: 12px 16px; border-radius: 8px; margin-bottom: 15px; font-weight: 600; color: #856404;">
                        ‚ö†Ô∏è ${pending.length} authorization(s) awaiting your approval
                    </div>`;
                }
                
                html += auths.map(auth => {
                    const statusMap = {
                        'pending': { cls: 'status-pending', text: '‚è≥ Pending', color: '#f0ad4e' },
                        'approved': { cls: 'status-approved', text: '‚úÖ Approved', color: '#27ae60' },
                        'rejected': { cls: 'status-rejected', text: '‚ùå Rejected', color: '#dc3545' },
                        'draft': { cls: 'status-pending', text: 'üìù Draft', color: '#6c757d' }
                    };
                    const s = statusMap[auth.status] || statusMap['pending'];
                    
                    // Parse details for cost breakdown
                    let costBreakdown = '';
                    if (auth.est_total > 0) {
                        costBreakdown = `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                ${auth.est_transport > 0 ? `<div>üöó Transport: <strong>$${parseFloat(auth.est_transport).toFixed(2)}</strong></div>` : ''}
                                ${auth.est_lodging > 0 ? `<div>üè® Lodging: <strong>$${parseFloat(auth.est_lodging).toFixed(2)}</strong></div>` : ''}
                                ${auth.est_meals > 0 ? `<div>üçΩÔ∏è Meals: <strong>$${parseFloat(auth.est_meals).toFixed(2)}</strong></div>` : ''}
                                ${auth.est_other > 0 ? `<div>üìã Other: <strong>$${parseFloat(auth.est_other).toFixed(2)}</strong></div>` : ''}
                                <div style="font-weight: bold; color: #2c3e50;">üí∞ Total: <strong>$${parseFloat(auth.est_total).toFixed(2)}</strong></div>
                            </div>`;
                    }
                    
                    const actions = auth.status === 'pending' ? `
                        <div style="display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap;">
                            <button onclick="approveTravelAuth(${auth.id})" class="btn btn-success" style="min-height: 44px; padding: 10px 20px; font-size: 14px;">‚úÖ Approve</button>
                            <button onclick="rejectTravelAuth(${auth.id})" class="btn btn-danger" style="min-height: 44px; padding: 10px 20px; font-size: 14px;">‚ùå Reject</button>
                        </div>` : '';
                    
                    return `
                        <div style="background: white; border: 2px solid ${auth.status === 'pending' ? '#f0ad4e' : '#e9ecef'}; border-radius: 12px; padding: 20px; margin-bottom: 15px; ${auth.status === 'pending' ? 'box-shadow: 0 2px 8px rgba(240,173,78,0.2);' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <strong style="font-size: 16px; color: #2c3e50;">${auth.name || auth.destination || 'Travel Authorization'}</strong>
                                    <div style="font-size: 13px; color: #666; margin-top: 4px;">
                                        üë§ ${auth.employee_name || 'Unknown'} ‚Ä¢ üìç ${auth.destination || 'N/A'} ‚Ä¢ üìÖ ${auth.start_date || ''} to ${auth.end_date || ''}
                                    </div>
                                    ${auth.purpose ? `<div style="font-size: 13px; color: #888; margin-top: 4px;">üìã ${auth.purpose}</div>` : ''}
                                </div>
                                <span class="${s.cls}" style="padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600;">${s.text}</span>
                            </div>
                            ${costBreakdown}
                            ${auth.rejection_reason ? `<div style="margin-top: 10px; padding: 8px 12px; background: #f8d7da; border-radius: 6px; font-size: 13px; color: #721c24;">‚ùå Rejected: ${auth.rejection_reason}</div>` : ''}
                            ${actions}
                        </div>`;
                }).join('');
                
                container.innerHTML = html;
            } catch (error) {
                console.error('‚ùå Error loading travel authorizations:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <p>‚ùå Failed to load travel authorizations.</p>
                        <button onclick="loadTravelAuthApprovals()" class="btn" style="margin-top: 10px; background: #667eea; color: white;">üîÑ Retry</button>
                    </div>`;
            }
        }
        
        async function approveTravelAuth(id) {
            try {
                const response = await fetch(`/api/travel-auth/${id}/approve`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (response.ok) {
                    showMessage('success', '‚úÖ Travel authorization approved!');
                    loadTravelAuthApprovals();
                } else {
                    showMessage('error', data.error || 'Failed to approve');
                }
            } catch (error) {
                showMessage('error', '‚ùå Network error. Please try again.');
            }
        }
        
        async function rejectTravelAuth(id) {
            const reason = prompt('Please provide a reason for rejection:');
            if (!reason || reason.trim() === '') return;
            
            try {
                const response = await fetch(`/api/travel-auth/${id}/reject`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rejection_reason: reason.trim() })
                });
                
                const data = await response.json();
                if (response.ok) {
                    showMessage('success', '‚ùå Travel authorization rejected.');
                    loadTravelAuthApprovals();
                } else {
                    showMessage('error', data.error || 'Failed to reject');
                }
            } catch (error) {
                showMessage('error', '‚ùå Network error. Please try again.');
            }
        }

        // üí∞ SAGE 300 FUNCTIONALITY

        async function loadSage300Data() {
            if (currentUserRole !== 'admin') return;
            
            try {
                await loadGLAccounts();
                await loadCostCenters();
            } catch (error) {
                console.error('Error loading Sage 300 data:', error);
            }
        }

        async function loadGLAccounts() {
            try {
                const response = await fetch('/api/sage/gl-accounts', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    displayGLAccounts(data.data);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error loading GL accounts:', error);
                document.getElementById('gl-accounts-container').innerHTML = '<div class="alert alert-danger">Error loading GL accounts</div>';
            }
        }

        function displayGLAccounts(accounts) {
            const container = document.getElementById('gl-accounts-container');
            
            if (accounts.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No GL accounts found</div>';
                return;
            }
            
            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Expense Type</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">GL Code</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">GL Name</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Status</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            accounts.forEach(account => {
                html += `
                    <tr style="border-bottom: 1px solid #dee2e6;" data-id="${account.id}">
                        <td style="padding: 12px;">
                            <input type="text" value="${account.expense_type}" 
                                   class="form-input" data-field="expense_type" 
                                   style="width: 100%; border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                        </td>
                        <td style="padding: 12px;">
                            <input type="text" value="${account.gl_code}" 
                                   class="form-input" data-field="gl_code"
                                   style="width: 80px; border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                        </td>
                        <td style="padding: 12px;">
                            <input type="text" value="${account.gl_name}" 
                                   class="form-input" data-field="gl_name"
                                   style="width: 100%; border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                        </td>
                        <td style="padding: 12px;">
                            <select data-field="is_active" class="form-input" 
                                    style="border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                                <option value="1" ${account.is_active ? 'selected' : ''}>Active</option>
                                <option value="0" ${!account.is_active ? 'selected' : ''}>Inactive</option>
                            </select>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button class="btn btn-success" onclick="saveGLAccount(${account.id})" 
                                    style="padding: 6px 12px; margin-right: 5px;">üíæ Save</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }

        async function loadCostCenters() {
            try {
                const response = await fetch('/api/sage/cost-centers', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    displayCostCenters(data.data);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error loading cost centers:', error);
                document.getElementById('cost-centers-container').innerHTML = '<div class="alert alert-danger">Error loading cost centers</div>';
            }
        }

        function displayCostCenters(centers) {
            const container = document.getElementById('cost-centers-container');
            
            if (centers.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No cost centers found</div>';
                return;
            }
            
            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Department</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Cost Center Code</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Cost Center Name</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Status</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            centers.forEach(center => {
                html += `
                    <tr style="border-bottom: 1px solid #dee2e6;" data-id="${center.id}">
                        <td style="padding: 12px;">
                            <input type="text" value="${center.department}" 
                                   class="form-input" data-field="department"
                                   style="width: 100%; border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                        </td>
                        <td style="padding: 12px;">
                            <input type="text" value="${center.cost_center_code}" 
                                   class="form-input" data-field="cost_center_code"
                                   style="width: 100px; border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                        </td>
                        <td style="padding: 12px;">
                            <input type="text" value="${center.cost_center_name}" 
                                   class="form-input" data-field="cost_center_name"
                                   style="width: 100%; border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                        </td>
                        <td style="padding: 12px;">
                            <select data-field="is_active" class="form-input"
                                    style="border: 1px solid #ddd; padding: 6px; border-radius: 4px;">
                                <option value="1" ${center.is_active ? 'selected' : ''}>Active</option>
                                <option value="0" ${!center.is_active ? 'selected' : ''}>Inactive</option>
                            </select>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button class="btn btn-success" onclick="saveCostCenter(${center.id})" 
                                    style="padding: 6px 12px; margin-right: 5px;">üíæ Save</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }

        async function saveGLAccount(id) {
            const row = document.querySelector(`[data-id="${id}"]`);
            const data = {};
            
            row.querySelectorAll('.form-input').forEach(input => {
                data[input.getAttribute('data-field')] = input.value;
            });
            
            try {
                const response = await fetch(`/api/sage/gl-accounts/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage('success', '‚úÖ GL account updated successfully');
                } else {
                    showMessage('danger', '‚ùå ' + (result.error || 'Failed to update GL account'));
                }
            } catch (error) {
                console.error('Error saving GL account:', error);
                showMessage('danger', '‚ùå Error saving GL account');
            }
        }

        async function saveCostCenter(id) {
            const row = document.querySelector(`[data-id="${id}"]`);
            const data = {};
            
            row.querySelectorAll('.form-input').forEach(input => {
                data[input.getAttribute('data-field')] = input.value;
            });
            
            try {
                const response = await fetch(`/api/sage/cost-centers/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage('success', '‚úÖ Cost center updated successfully');
                } else {
                    showMessage('danger', '‚ùå ' + (result.error || 'Failed to update cost center'));
                }
            } catch (error) {
                console.error('Error saving cost center:', error);
                showMessage('danger', '‚ùå Error saving cost center');
            }
        }

        async function addGLAccount() {
            const expenseType = prompt('Enter expense type (e.g., meals, hotel, vehicle):');
            if (!expenseType) return;
            
            const glCode = prompt('Enter GL code (e.g., 5410):');
            if (!glCode) return;
            
            const glName = prompt('Enter GL name (e.g., Travel - Meals):');
            if (!glName) return;
            
            try {
                const response = await fetch('/api/sage/gl-accounts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({
                        expense_type: expenseType,
                        gl_code: glCode,
                        gl_name: glName
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage('success', '‚úÖ GL account added successfully');
                    await loadGLAccounts();
                } else {
                    showMessage('danger', '‚ùå ' + (result.error || 'Failed to add GL account'));
                }
            } catch (error) {
                console.error('Error adding GL account:', error);
                showMessage('danger', '‚ùå Error adding GL account');
            }
        }

        async function addCostCenter() {
            const department = prompt('Enter department name:');
            if (!department) return;
            
            const costCenterCode = prompt('Enter cost center code (e.g., 100):');
            if (!costCenterCode) return;
            
            const costCenterName = prompt('Enter cost center name:');
            if (!costCenterName) return;
            
            try {
                const response = await fetch('/api/sage/cost-centers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({
                        department: department,
                        cost_center_code: costCenterCode,
                        cost_center_name: costCenterName
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage('success', '‚úÖ Cost center added successfully');
                    await loadCostCenters();
                } else {
                    showMessage('danger', '‚ùå ' + (result.error || 'Failed to add cost center'));
                }
            } catch (error) {
                console.error('Error adding cost center:', error);
                showMessage('danger', '‚ùå Error adding cost center');
            }
        }

        async function previewSageExport() {
            try {
                const response = await fetch('/api/sage/export', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                if (response.headers.get('content-type').includes('text/csv')) {
                    const csvContent = await response.text();
                    const lines = csvContent.split('\n').slice(0, 10); // Show first 10 lines
                    const preview = lines.join('\n') + (csvContent.split('\n').length > 10 ? '\n... (showing first 10 rows)' : '');
                    
                    document.getElementById('export-preview-content').textContent = preview;
                    document.getElementById('export-preview-modal').style.display = 'block';
                } else {
                    showMessage('danger', '‚ùå Error generating export preview');
                }
            } catch (error) {
                console.error('Error previewing export:', error);
                showMessage('danger', '‚ùå Error previewing export');
            }
        }

        function closeExportPreview() {
            document.getElementById('export-preview-modal').style.display = 'none';
        }

        async function exportToSage() {
            try {
                // First check how many approved expenses will be exported
                const countResponse = await fetch('/api/sage/export-count', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                let expenseCount = 0;
                if (countResponse.ok) {
                    const countResult = await countResponse.json();
                    expenseCount = countResult.count || 0;
                }
                
                // Show confirmation dialog
                const confirmMessage = expenseCount > 0 
                    ? `Are you sure you want to export ${expenseCount} approved expenses to Sage 300?`
                    : 'Are you sure you want to export approved expenses to Sage 300? (No approved expenses found)';
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                const response = await fetch('/api/sage/export', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `sage300_expenses_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showMessage('success', `‚úÖ Sage 300 export downloaded successfully (${expenseCount} expenses)`);
                    closeExportPreview();
                } else {
                    showMessage('danger', '‚ùå Error exporting data');
                }
            } catch (error) {
                console.error('Error exporting to Sage:', error);
                showMessage('danger', '‚ùå Error exporting to Sage');
            }
        }

        // Show messages using toast-style notifications
        function showMessage(type, message) {
            // Remove existing messages
            const existingMessages = document.querySelectorAll('.toast-message');
            existingMessages.forEach(msg => msg.remove());
            
            // Create toast message
            const toast = document.createElement('div');
            toast.className = `toast-message toast-${type}`;
            
            // Style based on message type
            const styles = {
                success: { background: '#28a745', color: 'white' },
                danger: { background: '#dc3545', color: 'white' },
                warning: { background: '#ffc107', color: '#212529' },
                info: { background: '#17a2b8', color: 'white' }
            };
            
            const style = styles[type] || styles.info;
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                padding: 16px 24px;
                border-radius: 12px;
                background: ${style.background};
                color: ${style.color};
                font-weight: 600;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease, fadeOut 0.3s ease 4.7s;
                max-width: 400px;
                word-wrap: break-word;
            `;
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }

        // Add CSS animation styles for toast
        if (!document.querySelector('#toast-styles')) {
            const style = document.createElement('style');
            style.id = 'toast-styles';
            style.textContent = `
                @keyframes slideIn { 
                    from { transform: translateX(100%); opacity: 0; } 
                    to { transform: translateX(0); opacity: 1; } 
                }
                @keyframes fadeOut { 
                    from { opacity: 1; } 
                    to { opacity: 0; } 
                }
            `;
            document.head.appendChild(style);
        }

        // Logout function
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            localStorage.removeItem('sessionId');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        // Export admin CSV
        function exportAdminCSV() {
            window.location.href = `/api/expenses/export/csv?token=${sessionId}`;
        }

        // ===== NJC RATES MANAGEMENT FUNCTIONS =====

        async function loadNJCRatesData() {
            await Promise.all([
                loadCurrentRates(),
                loadRateHistory(),
                setupRateFormHandlers()
            ]);
        }

        async function loadCurrentRates() {
            const container = document.getElementById('current-rates-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading current rates...</p></div>';

            try {
                const response = await fetch('/api/njc-rates/current', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const rates = data.rates;
                    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">';
                    
                    const rateIcons = {
                        'breakfast': 'ü•ê',
                        'lunch': 'ü•ó', 
                        'dinner': 'üçΩÔ∏è',
                        'incidentals': 'üì±',
                        'private_vehicle': 'üöó'
                    };
                    
                    rates.forEach(rate => {
                        const icon = rateIcons[rate.rate_type] || 'üìã';
                        const unit = rate.rate_type === 'private_vehicle' ? '/km' : '';
                        html += `
                            <div class="stat-card" style="text-align: left;">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <span style="font-size: 2em; margin-right: 10px;">${icon}</span>
                                    <div>
                                        <h4 style="margin: 0; color: #2c3e50; text-transform: capitalize;">${rate.rate_type.replace('_', ' ')}</h4>
                                        <p style="margin: 0; color: #6c757d; font-size: 0.9em;">Effective ${rate.effective_date}</p>
                                    </div>
                                </div>
                                <div class="stat-value" style="font-size: 1.8em; margin-bottom: 5px;">$${rate.amount.toFixed(2)}${unit}</div>
                                ${rate.notes ? `<p style="color: #6c757d; font-size: 0.85em; margin: 0;">${rate.notes}</p>` : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="alert alert-danger">Error loading current rates</div>';
                }
            } catch (error) {
                console.error('Error loading current rates:', error);
                container.innerHTML = '<div class="alert alert-danger">Failed to load current rates</div>';
            }
        }

        async function loadRateHistory() {
            const container = document.getElementById('rate-history-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading rate history...</p></div>';

            try {
                const response = await fetch('/api/njc-rates/all', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const ratesGrouped = data.rates;
                    let html = '';
                    
                    const rateTypes = ['breakfast', 'lunch', 'dinner', 'incidentals', 'private_vehicle'];
                    const rateIcons = {
                        'breakfast': 'ü•ê',
                        'lunch': 'ü•ó', 
                        'dinner': 'üçΩÔ∏è',
                        'incidentals': 'üì±',
                        'private_vehicle': 'üöó'
                    };
                    
                    rateTypes.forEach(rateType => {
                        if (ratesGrouped[rateType] && ratesGrouped[rateType].length > 0) {
                            const rates = ratesGrouped[rateType];
                            const icon = rateIcons[rateType] || 'üìã';
                            const unit = rateType === 'private_vehicle' ? '/km' : '';
                            
                            html += `
                                <div style="margin-bottom: 30px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; cursor: pointer;" 
                                         onclick="toggleRateHistory('${rateType}')">
                                        <h4 style="margin: 0; display: flex; align-items: center;">
                                            ${icon} <span style="margin-left: 10px; text-transform: capitalize;">${rateType.replace('_', ' ')} Rate History</span>
                                            <span id="toggle-${rateType}" style="margin-left: auto;">‚ñº</span>
                                        </h4>
                                    </div>
                                    <div id="history-${rateType}" style="padding: 20px; display: none;">
                                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            `;
                            
                            rates.forEach((rate, index) => {
                                const isCurrentRate = !rate.end_date;
                                const statusBadge = isCurrentRate 
                                    ? '<span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8em; font-weight: 600;">CURRENT</span>'
                                    : '<span style="background: #6c757d; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8em; font-weight: 600;">HISTORICAL</span>';
                                
                                html += `
                                    <div style="display: flex; justify-content: between; align-items: center; padding: 15px; background: ${isCurrentRate ? '#f8fcff' : '#f8f9fa'}; border-radius: 8px; border-left: 4px solid ${isCurrentRate ? '#28a745' : '#6c757d'};">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 8px;">
                                                <span style="font-size: 1.3em; font-weight: 600; color: #2c3e50;">$${rate.amount.toFixed(2)}${unit}</span>
                                                ${statusBadge}
                                            </div>
                                            <p style="margin: 0; color: #6c757d; font-size: 0.9em;">
                                                <strong>Effective:</strong> ${rate.effective_date} 
                                                ${rate.end_date ? ` ‚Üí ${rate.end_date}` : ' ‚Üí Present'}
                                            </p>
                                            ${rate.notes ? `<p style="margin: 5px 0 0 0; color: #6c757d; font-size: 0.85em;"><em>${rate.notes}</em></p>` : ''}
                                        </div>
                                    </div>
                                `;
                            });
                            
                            html += `
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="alert alert-danger">Error loading rate history</div>';
                }
            } catch (error) {
                console.error('Error loading rate history:', error);
                container.innerHTML = '<div class="alert alert-danger">Failed to load rate history</div>';
            }
        }

        function toggleRateHistory(rateType) {
            const historyDiv = document.getElementById(`history-${rateType}`);
            const toggleIcon = document.getElementById(`toggle-${rateType}`);
            
            if (historyDiv.style.display === 'none') {
                historyDiv.style.display = 'block';
                toggleIcon.textContent = '‚ñ≤';
            } else {
                historyDiv.style.display = 'none';
                toggleIcon.textContent = '‚ñº';
            }
        }

        function setupRateFormHandlers() {
            // Set minimum date to today
            const dateInput = document.getElementById('new-rate-effective-date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
            dateInput.value = today;
            
            // Add change handlers for form preview
            document.getElementById('new-rate-type').addEventListener('change', updateRatePreview);
            document.getElementById('new-rate-amount').addEventListener('input', updateRatePreview);
            document.getElementById('new-rate-effective-date').addEventListener('change', updateRatePreview);
        }

        async function updateRatePreview() {
            const rateType = document.getElementById('new-rate-type').value;
            const amount = document.getElementById('new-rate-amount').value;
            const effectiveDate = document.getElementById('new-rate-effective-date').value;
            const previewDiv = document.getElementById('rate-replacement-preview');
            const detailsP = document.getElementById('replacement-details');
            
            if (!rateType || !amount) {
                previewDiv.style.display = 'none';
                return;
            }
            
            try {
                // Get current rate for this type
                const response = await fetch(`/api/njc-rates/${rateType}`, {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const currentRate = data.rate.toFixed(2);
                        const newRate = parseFloat(amount).toFixed(2);
                        const unit = rateType === 'private_vehicle' ? '/km' : '';
                        
                        detailsP.innerHTML = `Current ${rateType.replace('_', ' ')} rate: <strong>$${currentRate}${unit}</strong> ‚Üí New rate: <strong>$${newRate}${unit}</strong> (effective ${effectiveDate})`;
                        previewDiv.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error updating preview:', error);
            }
        }

        async function addNewRate() {
            const rateType = document.getElementById('new-rate-type').value;
            const amount = document.getElementById('new-rate-amount').value;
            const effectiveDate = document.getElementById('new-rate-effective-date').value;
            const province = document.getElementById('new-rate-province').value;
            const notes = document.getElementById('new-rate-notes').value;
            
            if (!rateType || !amount || !effectiveDate) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (parseFloat(amount) <= 0) {
                alert('Amount must be greater than 0');
                return;
            }
            
            const confirmMessage = `Are you sure you want to add a new ${rateType.replace('_', ' ')} rate of $${parseFloat(amount).toFixed(2)} effective ${effectiveDate}?\n\nThis will replace the current rate for audit purposes.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            const btn = document.getElementById('add-rate-btn');
            btn.disabled = true;
            btn.textContent = 'Adding Rate...';
            
            try {
                const response = await fetch('/api/njc-rates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({
                        rate_type: rateType,
                        amount: parseFloat(amount),
                        effective_date: effectiveDate,
                        province: province,
                        notes: notes
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('New rate added successfully!');
                    clearNewRateForm();
                    await loadNJCRatesData(); // Reload all data
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error adding rate:', error);
                alert('Failed to add new rate. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ûï Add New Rate';
            }
        }

        function clearNewRateForm() {
            document.getElementById('new-rate-type').value = '';
            document.getElementById('new-rate-amount').value = '';
            const dateInput = document.getElementById('new-rate-effective-date');
            dateInput.value = new Date().toISOString().split('T')[0];
            document.getElementById('new-rate-province').value = 'QC';
            document.getElementById('new-rate-notes').value = '';
            document.getElementById('rate-replacement-preview').style.display = 'none';
        }

        // ===== EMPLOYEE AUDIT TRAIL FUNCTIONS =====

        function toggleEmployeeAuditHistory() {
            const content = document.getElementById('employee-audit-content');
            const icon = document.getElementById('audit-toggle-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
                // Load audit log if it's the first time opening
                if (!content.getAttribute('data-loaded')) {
                    loadEmployeeAuditLog();
                    content.setAttribute('data-loaded', 'true');
                }
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function populateAuditEmployeeFilter(employees) {
            const select = document.getElementById('audit-employee-filter');
            select.innerHTML = '<option value="">All Employees</option>';
            
            employees.forEach(emp => {
                select.innerHTML += `<option value="${emp.id}">${emp.name} (${emp.employee_number || 'No ID'})</option>`;
            });
        }

        async function loadEmployeeAuditLog() {
            if (currentUserRole !== 'admin') return;
            
            const container = document.getElementById('employee-audit-log-container');
            const employeeFilter = document.getElementById('audit-employee-filter').value;
            const limit = document.getElementById('audit-limit').value;
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading change history...</p></div>';
            
            try {
                let url = `/api/employee-audit-log?limit=${limit}&offset=0`;
                if (employeeFilter) {
                    url += `&employee_id=${employeeFilter}`;
                }
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load audit log');
                }
                
                const auditLog = data.employee_audit_log;
                
                if (auditLog.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
                                <h3>No Changes Found</h3>
                                <p>No employee changes have been recorded yet.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Group by employee and date for better readability
                const groupedLogs = groupAuditLogsByEmployee(auditLog);
                
                container.innerHTML = displayGroupedAuditLog(groupedLogs, data.pagination);
                
            } catch (error) {
                console.error('‚ùå Error loading employee audit log:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                            <h3>Error Loading Change History</h3>
                            <p>Failed to load audit log: ${error.message}</p>
                            <button class="btn btn-primary" onclick="loadEmployeeAuditLog()" style="margin-top: 15px;">üîÑ Try Again</button>
                        </div>
                    </div>
                `;
            }
        }

        function groupAuditLogsByEmployee(auditLog) {
            const grouped = {};
            
            auditLog.forEach(log => {
                const key = `${log.employee_id}-${log.performed_at.split(' ')[0]}`; // Group by employee and date
                
                if (!grouped[key]) {
                    grouped[key] = {
                        employee_id: log.employee_id,
                        employee_name: log.employee_name || 'Unknown Employee',
                        employee_number: log.employee_number,
                        date: log.performed_at.split(' ')[0],
                        performed_by_name: log.performed_by_name || 'Unknown User',
                        logs: []
                    };
                }
                
                grouped[key].logs.push(log);
            });
            
            return Object.values(grouped);
        }

        function displayGroupedAuditLog(groupedLogs, pagination) {
            let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';
            
            groupedLogs.forEach(group => {
                const actionIcons = {
                    'created': '‚ûï',
                    'updated': '‚úèÔ∏è',
                    'deleted': 'üóëÔ∏è'
                };
                
                const actionColors = {
                    'created': '#28a745',
                    'updated': '#ffc107',
                    'deleted': '#dc3545'
                };
                
                // Group by action type
                const actionGroups = {};
                group.logs.forEach(log => {
                    if (!actionGroups[log.action]) {
                        actionGroups[log.action] = [];
                    }
                    actionGroups[log.action].push(log);
                });
                
                html += `
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 4px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0; color: #2c3e50;">
                                    üë§ ${group.employee_name} ${group.employee_number ? `(${group.employee_number})` : ''}
                                </h4>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                                    üìÖ ${group.date} ‚Ä¢ By: ${group.performed_by_name}
                                </p>
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                `;
                
                Object.keys(actionGroups).forEach(action => {
                    const logs = actionGroups[action];
                    const icon = actionIcons[action] || 'üìù';
                    const color = actionColors[action] || '#6c757d';
                    
                    // Get the main action log (without field_changed)
                    const mainLog = logs.find(log => !log.field_changed) || logs[0];
                    const fieldLogs = logs.filter(log => log.field_changed);
                    
                    html += `
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid ${color};">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 1.1em; margin-right: 8px;">${icon}</span>
                                <strong style="color: ${color}; text-transform: capitalize;">${action} Employee Record</strong>
                                <span style="margin-left: 10px; color: #666; font-size: 12px;">
                                    ${formatTimeAgo(mainLog.performed_at)}
                                </span>
                            </div>
                    `;
                    
                    if (fieldLogs.length > 0) {
                        html += '<div style="margin-left: 20px; font-size: 13px;">';
                        
                        fieldLogs.forEach(fieldLog => {
                            const fieldName = fieldLog.field_changed.replace('_', ' ');
                            
                            if (action === 'created') {
                                html += `<div style="color: #666; margin-bottom: 4px;">‚Ä¢ <strong>${fieldName}:</strong> "${fieldLog.new_value || 'Not set'}"</div>`;
                            } else if (action === 'updated') {
                                html += `<div style="color: #666; margin-bottom: 4px;">‚Ä¢ <strong>${fieldName}:</strong> "${fieldLog.old_value || 'Not set'}" ‚Üí "${fieldLog.new_value || 'Not set'}"</div>`;
                            } else if (action === 'deleted') {
                                html += `<div style="color: #666; margin-bottom: 4px;">‚Ä¢ <strong>${fieldName}:</strong> "${fieldLog.old_value || 'Not set'}" (removed)</div>`;
                            }
                        });
                        
                        html += '</div>';
                    }
                    
                    html += '</div>';
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Add pagination info
            if (pagination.total > pagination.limit) {
                html += `
                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <p style="color: #666; margin: 0;">
                            Showing ${Math.min(pagination.limit, pagination.total)} of ${pagination.total} changes
                            ${pagination.has_more ? ' ‚Ä¢ Use filters above to narrow results' : ''}
                        </p>
                    </div>
                `;
            }
            
            return html;
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins !== 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString();
        }
        
        // Signup modal functions
        function showSignupLinkModal(signupUrl, employeeName) {
            document.getElementById('signup-employee-name').textContent = employeeName;
            document.getElementById('signup-url').value = signupUrl;
            document.getElementById('signup-link-modal').style.display = 'block';
        }
        
        function closeSignupModal() {
            document.getElementById('signup-link-modal').style.display = 'none';
        }
        
        function copySignupUrl() {
            const urlInput = document.getElementById('signup-url');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999); // For mobile devices
            navigator.clipboard.writeText(urlInput.value).then(() => {
                showMessage('success', 'üìã Signup link copied to clipboard!');
            }).catch(() => {
                // Fallback for browsers that don't support clipboard API
                document.execCommand('copy');
                showMessage('success', 'üìã Signup link copied to clipboard!');
            });
        }
        
        function copyAndClose() {
            copySignupUrl();
            setTimeout(() => {
                closeSignupModal();
            }, 1000);
        }
        
        // Resend signup invite for inactive employees
        async function resendInvite(employeeId, employeeName) {
            try {
                const response = await fetch(`/api/employees/${employeeId}/resend-invite`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionId}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Signup invite resent successfully!');
                    // Show the signup link modal
                    showSignupLinkModal(result.signupUrl, employeeName);
                } else {
                    showMessage('danger', result.error || 'Failed to resend invite');
                }
            } catch (error) {
                console.error('‚ùå Error resending invite:', error);
                showMessage('danger', '‚ùå Failed to resend invite');
            }
        }

    </script>
</body>
</html>