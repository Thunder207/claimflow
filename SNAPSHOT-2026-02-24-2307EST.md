# ClaimFlow Snapshot ‚Äî February 24, 2026, 11:07 PM EST

## Current State
- **Latest commit**: `adadf00` ‚Äî Fix variance: compute AT estimates from actual AT expenses
- **Working tree**: Clean (no uncommitted changes)
- **Branch**: main
- **Live URL**: https://claimflow-e0za.onrender.com
- **Repo**: https://github.com/Thunder207/claimflow.git

## File Sizes
- `app.js`: 4,871 lines (backend)
- `employee-dashboard.html`: 7,435 lines (employee frontend)
- `admin.html`: 4,167 lines (admin frontend)
- **Total**: 16,473 lines

## Git Tags (newest ‚Üí oldest)
| Tag | Description |
|-----|-------------|
| `v6.0-variance-view-2026-02-24` | Variance view feature (AT vs Trip comparison) |
| `v5.1-ux-optimized-2026-02-24-VERIFIED` | **üèÜ GOLDEN ROLLBACK** ‚Äî User verified "best working app" |
| `v5.1-ux-optimized-2026-02-24` | UX optimizations (5 improvements) |
| `v5.1-pre-variance-backup-2026-02-24` | Pre-variance backup |
| `v5.0-transport-e2e-verified-2026-02-23` | Smart transport E2E verified |
| `v4.0-governance-validated-2026-02-21-1612EST` | Governance roles |

## Recent Commits (post v6.0 tag, NOT yet tagged)
1. `adadf00` ‚Äî Fix variance: compute AT estimates from actual AT expenses instead of inaccurate summary fields
2. `697b736` ‚Äî CRITICAL: Fix 3 bugs breaking transport populate (updateTransportTotal undefined, currentTrip undefined, race condition)
3. `4816bba` ‚Äî CRITICAL FIX: API returns row directly, not {success,authorization} wrapper
4. `9f02efa` ‚Äî Show transport data on submitted/pending ATs
5. `27a7767` ‚Äî Save transport details to AT on submit
6. `5392b05` ‚Äî Client-side variance actuals from tdpState
7. `ee585a2` ‚Äî Custom confirmation modal replacing browser confirm()
8. `465c0a6` ‚Äî Toast duration 5s‚Üí10s

## Transport Data Audit ‚Äî Bugs Found & Fixed
| Bug | Description | Status | Fix |
|-----|-------------|--------|-----|
| #1 | Frontend assumed `{success, authorization}` wrapper but API returns flat row | ‚úÖ FIXED | Check `authDetails.id` and `authDetails.details` directly |
| #2 | Transport populate ran BEFORE `dpBuildGrid()` (grid rebuild wipes values) | ‚úÖ FIXED | Moved populate AFTER `loadAuthExpenses()`, removed setTimeout |
| #3 | `dpToggleTransport()` called undefined `updateTransportTotal()` | ‚úÖ FIXED | Changed to `dpRecalcTotal()` |
| #4 | `currentTrip is not defined` in `dpToggleTransport()` | ‚úÖ FIXED | Fixed in commit `697b736` |

## Features Deployed (v6.0+)
### Variance View
- Admin: configurable thresholds (default 10% / $100), audit trail
- Supervisor: variance table on Travel Auth + Team Approvals tabs
- Employee: budget comparison above submit button
- 10 categories: Meals, Incidentals, Hotel, Kilometric, Flight, Train, Bus, Rental, Other, Unplanned
- 5 statuses: üî¥ Red (both thresholds), ‚ö†Ô∏è Yellow (one), ‚úÖ Green, üÜï Unplanned, ‚ûñ Not claimed
- AND rule: Red ONLY when BOTH % and $ thresholds exceeded

### Custom Confirmation Modal
- Replaced browser `confirm()` which was auto-dismissing
- `showConfirmModal(message, onYes)` ‚Äî in-page modal, can't be dismissed by external events

### Transport Data Persistence
- Transport details saved to AT `details` field on submit (step 5b in `dpDoSubmit()`)
- Transport shown for pending/approved ATs (removed `canEdit` guard)
- AT‚ÜíTrip auto-populate working

## Pending / Next Steps
1. ~~Fix Bug #4~~ ‚Äî Fixed in `697b736`
2. Run 5 complete E2E transport tests to verify full workflow
3. Deploy verified fixes to Render
4. Tag as new verified version
5. Fix `est_transport` $0 in supervisor AT detail view (cosmetic)

## Demo Accounts
- Employee: anna.lee@company.com / anna123
- Supervisor: lisa.brown@company.com / lisa123
- Admin: john.smith@company.com / manager123

## Key Documentation
- `ARCHITECTURE.md` ‚Äî Full developer guide
- `CONTINUITY.md` ‚Äî Continuity & rollback info
- `BACKUP-2026-02-24-1703EST.md` ‚Äî Pre-variance backup details

## Database
- SQLite (ephemeral on Render ‚Äî resets on each deploy)
- Tables: `app_settings` (key/value), `settings_audit_log` (audit trail)
- All new fields nullable/have defaults for backward compatibility
