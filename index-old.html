<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <title>Government Expense Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .admin-link {
            position: absolute;
            top: 15px;
            right: 15px;
            color: white;
            text-decoration: none;
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .admin-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .form-section {
            padding: 30px 20px;
        }
        
        .expense-card {
            border: 2px solid #e8f4fd;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            background: linear-gradient(135deg, #f8fcff 0%, #e8f4fd 100%);
            transition: all 0.3s ease;
        }
        
        .expense-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.1);
        }
        
        .expense-type {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .expense-type h3 {
            color: #2c3e50;
            margin-left: 10px;
            font-size: 18px;
        }
        
        .per-diem-info {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            padding: 12px 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #155724;
            border-left: 4px solid #28a745;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        .photo-section {
            border: 3px dashed #bdc3c7;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafbfc;
        }
        
        .photo-section:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%);
            transform: translateY(-2px);
        }
        
        .photo-section.has-photo {
            border-color: #27ae60;
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
        }
        
        .camera-icon {
            font-size: 48px;
            color: #bdc3c7;
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }
        
        .photo-section:hover .camera-icon {
            color: #667eea;
        }
        
        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .submit-btn:active {
            transform: translateY(-1px);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .expense-list {
            margin-top: 30px;
        }
        
        .expense-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .expense-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        
        .expense-date {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .expense-amount {
            color: #27ae60;
            font-weight: 600;
            font-size: 18px;
        }
        
        .expense-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 10px;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        #file-input {
            display: none;
        }
        
        .success-message {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            border-left: 5px solid #28a745;
            font-weight: 600;
        }
        
        .error-message {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            border-left: 5px solid #dc3545;
            font-weight: 600;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* üì± Mobile Responsive Enhancements */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { border-radius: 15px; }
            .header { padding: 20px 15px; }
            .form-section { padding: 20px 15px; }
            .expense-card { padding: 20px; }
            input, select, textarea { font-size: 16px; } /* Prevent zoom on iOS */
            .photo-section { padding: 20px; }
            .submit-btn { padding: 16px; font-size: 16px; }
        }
        
        @media (max-width: 480px) {
            .header h1 { font-size: 20px; }
            .expense-card { margin-bottom: 20px; padding: 15px; }
            .stats { grid-template-columns: 1fr 1fr; gap: 10px; }
            .form-group { margin-bottom: 15px; }
        }
        
        .trip-mode {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .trip-checkbox {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        .status-section {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            border-left: 5px solid #ff9800;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            float: right;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/admin" class="admin-link">üìä Admin</a>
            <h1>üí∞ Expense Tracker</h1>
            <p>Government Employee Portal - NJC Compliant</p>
        </div>
        
        <div class="form-section">
            <div class="success-message" id="success-message">
                ‚úÖ Expense submitted successfully and sent for approval!
            </div>
            
            <div class="error-message" id="error-message">
                ‚ùå <span id="error-text">Something went wrong</span>
            </div>
            
            <div class="loading-spinner" id="loading-spinner">
                <div class="spinner"></div>
                <p>Submitting your expense...</p>
            </div>
            
            <form id="expense-form">
                <div class="expense-card">
                    <div class="trip-mode">
                        <label style="display: flex; align-items: center; margin: 0; cursor: pointer;">
                            <input type="checkbox" id="trip-mode" class="trip-checkbox" onchange="toggleTripMode()">
                            ‚úàÔ∏è Trip Mode (Add multiple expenses for a day/trip)
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label for="employee-name">Employee Name *</label>
                        <input type="text" id="employee-name" name="employee_name" placeholder="Enter your full name" required>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                            üí° This integrates with your employee directory
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="expense-type">Expense Type *</label>
                        <select id="expense-type" name="expense_type" required onchange="updatePerDiemRate()">
                            <option value="">Select expense type...</option>
                            <optgroup label="üèõÔ∏è Government Per Diem (NJC Fixed Rates - One per day)">
                                <option value="breakfast">ü•ê Breakfast - $23.45</option>
                                <option value="lunch">ü•ó Lunch - $29.75</option>
                                <option value="dinner">üçΩÔ∏è Dinner - $47.05</option>
                                <option value="incidentals">üì± Incidentals - $32.08</option>
                            </optgroup>
                            <optgroup label="üöó Travel & Accommodation">
                                <option value="vehicle_km">üöó Vehicle (per km) - $0.68</option>
                                <option value="hotel">üè® Hotel (Receipt Required) - Max $200.00</option>
                            </optgroup>
                            <optgroup label="üìù Other Business Expenses">
                                <option value="other">üìù Other Expense (Custom Amount)</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="per-diem-info" id="per-diem-display">
                        üí∞ Select expense type to see NJC rate
                    </div>
                    
                    <div class="form-group">
                        <label for="expense-date">Date *</label>
                        <input type="date" id="expense-date" name="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" name="location" placeholder="e.g., Ottawa, ON" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount">Amount Paid *</label>
                        <input type="number" id="amount" name="amount" step="0.01" placeholder="25.50" required>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                            üí° Enter the actual amount you paid
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="vendor">Vendor/Details *</label>
                        <input type="text" id="vendor" name="vendor" placeholder="e.g., Tim Hortons, Hotel Name, Distance in KM" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description (Optional)</label>
                        <textarea id="description" name="description" rows="3" placeholder="Business lunch with client, conference travel, etc..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Receipt Photo</label>
                        <div class="photo-section" onclick="document.getElementById('file-input').click()">
                            <div class="camera-icon">üì∑</div>
                            <div><strong>Tap to capture or upload receipt</strong></div>
                            <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Supports: JPG, PNG, GIF, WebP (Max 10MB)</div>
                            <img id="photo-preview" class="photo-preview" style="display: none;">
                        </div>
                        <input type="file" id="file-input" accept="image/*" capture="environment">
                    </div>
                </div>
                
                <button type="submit" class="submit-btn" id="submit-btn">
                    Submit Expense for Approval
                </button>
            </form>
            
            <div class="status-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #2c3e50; margin: 0;">üìã My Expense Status</h3>
                    <button class="refresh-btn" onclick="loadMyExpenses()">üîÑ Refresh</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="name-lookup" placeholder="Enter your employee name to see your submissions..." 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;"
                           onkeyup="if(event.key==='Enter') loadMyExpenses()">
                </div>
                <div id="employee-expenses">
                    <div style="text-align: center; color: #6c757d; padding: 20px;">
                        üëÜ Enter your name above to see your submission history and approval status
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // NJC rates (loaded from server)
        // Official NJC rates (updated 2026)
        let njcRates = {
            breakfast: { rate: 23.45, icon: 'ü•ê', name: 'Breakfast' },
            lunch: { rate: 29.75, icon: 'ü•ó', name: 'Lunch' },
            dinner: { rate: 47.05, icon: 'üçΩÔ∏è', name: 'Dinner' },
            incidentals: { rate: 32.08, icon: 'üì±', name: 'Incidentals' },
            vehicle_km: { rate: 0.68, icon: 'üöó', name: 'Vehicle (per KM)' },
            hotel: { rate: 200.00, icon: 'üè®', name: 'Hotel' }
        };
        
        // Load NJC rates from server
        async function loadNJCRates() {
            try {
                const response = await fetch('/api/njc-rates');
                if (response.ok) {
                    const rates = await response.json();
                    rates.forEach(rate => {
                        if (njcRates[rate.meal_type]) {
                            njcRates[rate.meal_type].rate = rate.rate;
                        }
                    });
                    console.log('‚úÖ Loaded NJC rates from server');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Using default NJC rates');
            }
        }
        
        // Update per diem rate display with field locking
        function updatePerDiemRate() {
            const selectedType = document.getElementById('expense-type').value;
            const display = document.getElementById('per-diem-display');
            const amountField = document.getElementById('amount');
            
            console.log('üîç updatePerDiemRate called with:', selectedType);
            
            // Reset field state
            if (amountField) {
                amountField.readOnly = false;
                amountField.style.backgroundColor = '';
                amountField.style.border = '';
                amountField.style.fontWeight = '';
                amountField.style.color = '';
                amountField.style.cursor = '';
                amountField.title = '';
            }
            
            if (!selectedType || selectedType === 'other') {
                display.innerHTML = 'üí∞ Select expense type to see NJC rate';
                display.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
                display.style.color = '#6c757d';
                return;
            }
            
            // Handle fixed rates with field locking
            const fixedRates = {
                'breakfast': { rate: 23.45, fixed: true, description: 'NJC Standard Breakfast Rate' },
                'lunch': { rate: 29.75, fixed: true, description: 'NJC Standard Lunch Rate' },
                'dinner': { rate: 47.05, fixed: true, description: 'NJC Standard Dinner Rate' },
                'incidentals': { rate: 32.08, fixed: true, description: 'NJC Incidental Allowance (Daily)' },
                'vehicle_km': { rate: 0.68, fixed: true, description: 'NJC Vehicle Allowance per Kilometre' },
                'hotel': { rate: 200.00, fixed: false, max_amount: 200.00, description: 'Hotel/Accommodation (Receipt Required)' }
            };
            
            if (fixedRates[selectedType]) {
                const rateData = fixedRates[selectedType];
                console.log('üìä Using fixed rate data:', rateData);
                
                // Update display
                const rateText = selectedType === 'vehicle_km' ? `$${rateData.rate}/km` : `$${rateData.rate}`;
                display.innerHTML = `
                    üèõÔ∏è <strong>Official NJC Rate:</strong> ${rateText}<br>
                    <small style="opacity: 0.8;">${rateData.description}</small>
                `;
                display.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
                display.style.color = '#0d47a1';
                
                // Handle field locking for fixed rates
                if (amountField && rateData.fixed && selectedType !== 'vehicle_km') {
                    console.log('üîí Applying fixed rate lock for:', selectedType);
                    amountField.value = rateData.rate.toFixed(2);
                    amountField.readOnly = true;
                    amountField.style.backgroundColor = '#e3f2fd';
                    amountField.style.border = '2px solid #2196f3';
                    amountField.style.fontWeight = 'bold';
                    amountField.style.color = '#0d47a1';
                    amountField.style.cursor = 'not-allowed';
                    amountField.title = 'This is an official NJC per diem rate and cannot be changed';
                    console.log('‚úÖ Field locked successfully');
                } else if (selectedType === 'hotel' && amountField) {
                    amountField.placeholder = `Max $${rateData.max_amount}`;
                    console.log('üè® Hotel selected - receipt required');
                }
            } else {
                // Fallback to old njcRates if available
                if (njcRates[selectedType]) {
                    const rate = njcRates[selectedType];
                    let rateText = selectedType === 'mileage' ? `$${rate.rate}/km` : `$${rate.rate} CAD`;
                    display.innerHTML = `üí∞ <strong>NJC Rate:</strong> ${rateText} per ${rate.name.toLowerCase()}`;
                    display.style.background = 'linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%)';
                    display.style.color = '#155724';
                } else {
                    console.log('‚ùå No rate found for:', selectedType);
                    display.innerHTML = '‚ö†Ô∏è Rate not found - please try again';
                    display.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%)';
                    display.style.color = '#856404';
                }
            }
        }
        
        // Toggle trip mode
        function toggleTripMode() {
            const tripMode = document.getElementById('trip-mode').checked;
            const submitBtn = document.getElementById('submit-btn');
            
            if (tripMode) {
                submitBtn.textContent = 'Add to Trip & Continue';
                showMessage('info', '‚úàÔ∏è Trip mode enabled! You can add multiple expenses.');
            } else {
                submitBtn.textContent = 'Submit Expense for Approval';
            }
        }
        
        // Set today's date as default
        document.getElementById('expense-date').valueAsDate = new Date();
        
        // Photo handling
        const fileInput = document.getElementById('file-input');
        const photoSection = document.querySelector('.photo-section');
        const photoPreview = document.getElementById('photo-preview');
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 10 * 1024 * 1024) {
                    showMessage('error', '‚ùå File size too large. Maximum size is 10MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.src = e.target.result;
                    photoPreview.style.display = 'block';
                    photoSection.classList.add('has-photo');
                    photoSection.innerHTML = '<div style="color: #27ae60; font-weight: 600;">‚úÖ Receipt captured successfully!</div>' + 
                                           '<img id="photo-preview" class="photo-preview" src="' + e.target.result + '">';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Form submission
        document.getElementById('expense-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            const loadingSpinner = document.getElementById('loading-spinner');
            const expenseType = document.getElementById('expense-type').value;
            const employeeName = document.getElementById('employee-name').value.trim();
            const amount = document.getElementById('amount').value;
            
            // Validation
            if (!employeeName) {
                showMessage('error', '‚ùå Please enter your employee name');
                document.getElementById('employee-name').focus();
                return;
            }
            
            if (!expenseType) {
                showMessage('error', '‚ùå Please select an expense type');
                document.getElementById('expense-type').focus();
                return;
            }
            
            if (!amount || parseFloat(amount) <= 0) {
                showMessage('error', '‚ùå Please enter a valid amount');
                document.getElementById('amount').focus();
                return;
            }
            
            // Show loading
            submitBtn.disabled = true;
            loadingSpinner.style.display = 'block';
            hideMessages();
            
            try {
                // Prepare form data
                const formData = new FormData();
                formData.append('employee_name', employeeName);
                formData.append('expense_type', expenseType);
                formData.append('meal_name', njcRates[expenseType]?.name || expenseType);
                formData.append('date', document.getElementById('expense-date').value);
                formData.append('location', document.getElementById('location').value);
                formData.append('amount', amount);
                formData.append('vendor', document.getElementById('vendor').value);
                formData.append('description', document.getElementById('description').value);
                
                // Add receipt photo if present
                if (fileInput.files[0]) {
                    formData.append('receipt', fileInput.files[0]);
                }
                
                // Submit to server
                const response = await fetch('/api/expenses', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const tripMode = document.getElementById('trip-mode').checked;
                    
                    showMessage('success', `‚úÖ ${result.message} ${tripMode ? 'Add another expense or change to single mode when done.' : ''}`);
                    
                    if (!tripMode) {
                        // Reset form completely
                        this.reset();
                        resetPhotoSection();
                        document.getElementById('expense-date').valueAsDate = new Date();
                        updatePerDiemRate();
                    } else {
                        // Keep employee name and date, reset other fields
                        document.getElementById('expense-type').value = '';
                        document.getElementById('amount').value = '';
                        document.getElementById('vendor').value = '';
                        document.getElementById('description').value = '';
                        resetPhotoSection();
                        updatePerDiemRate();
                    }
                    
                    // Auto-refresh their expense status if name is filled
                    if (document.getElementById('name-lookup').value) {
                        setTimeout(() => loadMyExpenses(), 1000);
                    } else {
                        document.getElementById('name-lookup').value = employeeName;
                        setTimeout(() => loadMyExpenses(), 1000);
                    }
                    
                } else {
                    showMessage('error', result.error || 'Failed to submit expense');
                }
                
            } catch (error) {
                console.error('‚ùå Error submitting expense:', error);
                showMessage('error', '‚ùå Network error. Please check your connection and try again.');
            } finally {
                // Hide loading
                submitBtn.disabled = false;
                loadingSpinner.style.display = 'none';
            }
        });
        
        // Reset photo section
        function resetPhotoSection() {
            const photoSection = document.querySelector('.photo-section');
            photoSection.classList.remove('has-photo');
            photoSection.innerHTML = `
                <div class="camera-icon">üì∑</div>
                <div><strong>Tap to capture or upload receipt</strong></div>
                <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Supports: JPG, PNG, GIF, WebP (Max 10MB)</div>
                <img id="photo-preview" class="photo-preview" style="display: none;">
            `;
            fileInput.value = '';
        }
        
        // Load employee's own expenses
        async function loadMyExpenses() {
            const employeeName = document.getElementById('name-lookup').value.trim();
            const container = document.getElementById('employee-expenses');
            
            if (!employeeName) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 20px;">
                        üëÜ Enter your name above to see your submission history and approval status
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner" style="width: 30px; height: 30px; border-width: 3px;"></div>
                    <p style="color: #6c757d; margin-top: 10px;">Loading your expenses...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`/api/expenses/employee/${encodeURIComponent(employeeName)}`);
                if (!response.ok) throw new Error('Failed to load expenses');
                
                const expenses = await response.json();
                
                if (expenses.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                            <div style="font-size: 32px; margin-bottom: 10px;">üìã</div>
                            <h4>No Expenses Found</h4>
                            <p>You haven't submitted any expenses yet.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = expenses.map(expense => {
                    const statusClass = expense.status === 'approved' ? 'status-approved' : 
                                      expense.status === 'rejected' ? 'status-rejected' : 'status-pending';
                    const statusText = expense.status === 'approved' ? '‚úÖ Approved' :
                                     expense.status === 'rejected' ? '‚ùå Rejected' : '‚è≥ Pending';
                    
                    return `
                        <div class="expense-item">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div class="expense-date">
                                    ${njcRates[expense.expense_type]?.icon || 'üí∞'} ${expense.meal_name || expense.expense_type} - ${new Date(expense.date).toLocaleDateString()}
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <div class="expense-amount">$${parseFloat(expense.amount).toFixed(2)}</div>
                                    <span class="expense-status ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                            <div style="color: #7f8c8d; font-size: 14px;">
                                üìç ${expense.location} ‚Ä¢ üè™ ${expense.vendor}
                            </div>
                            ${expense.approval_comment ? `
                                <div style="margin-top: 8px; padding: 8px 12px; background: #d4edda; border-radius: 6px; font-size: 13px; color: #155724;">
                                    ‚úÖ <strong>${expense.approved_by}:</strong> ${expense.approval_comment}
                                </div>
                            ` : ''}
                            ${expense.rejection_reason ? `
                                <div style="margin-top: 8px; padding: 8px 12px; background: #f8d7da; border-radius: 6px; font-size: 13px; color: #721c24;">
                                    ‚ùå <strong>${expense.approved_by}:</strong> ${expense.rejection_reason}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('‚ùå Error loading employee expenses:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc3545;">
                        <div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div>
                        <h4>Error Loading Expenses</h4>
                        <p>${error.message}</p>
                        <button onclick="loadMyExpenses()" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">üîÑ Try Again</button>
                    </div>
                `;
            }
        }
        
        // Auto-fill employee name on lookup change
        document.getElementById('name-lookup').addEventListener('change', function() {
            const name = this.value.trim();
            if (name && !document.getElementById('employee-name').value) {
                document.getElementById('employee-name').value = name;
            }
        });
        
        // Message handling
        function showMessage(type, message) {
            hideMessages();
            
            const messageElement = document.getElementById(type + '-message');
            if (messageElement) {
                if (type === 'error') {
                    document.getElementById('error-text').textContent = message;
                } else {
                    messageElement.textContent = message;
                }
                messageElement.style.display = 'block';
                messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 5000);
            }
        }
        
        function hideMessages() {
            document.getElementById('success-message').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üí∞ Government Expense Tracker loaded');
            loadNJCRates();
            updatePerDiemRate();
        });
    </script>
</body>
</html>