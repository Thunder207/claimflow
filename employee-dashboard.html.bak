<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>Employee Dashboard - Government Expense Tracker</title>
    
    <!-- 
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                 GOVERNMENT EXPENSE TRACKER                   â•‘
    â•‘                    Employee Dashboard                        â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘ Purpose: Main interface for employees to submit expenses     â•‘
    â•‘ Features: Individual expenses, trip expenses, draft system   â•‘
    â•‘ Compliance: NJC per diem rates, receipt requirements        â•‘
    â•‘ Security: Role-based access, session authentication         â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .header-info h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header-info p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529; }
        .btn-light { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .nav-tab {
            padding: 15px 25px;
            background: white;
            border: 2px solid #e9ecef;
            cursor: pointer;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .nav-tab:hover {
            border-color: #667eea;
            transform: translateY(-1px);
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8fcff 0%, #e8f4fd 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #3498db;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        .expense-form {
            background: linear-gradient(135deg, #f8fcff 0%, #e8f4fd 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 4px solid #3498db;
        }
        
        .photo-section {
            border: 3px dashed #bdc3c7;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafbfc;
            margin: 15px 0;
        }
        
        .photo-section:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%);
        }
        
        .photo-section.has-photo {
            border-color: #27ae60;
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
        }
        
        .camera-icon {
            font-size: 48px;
            color: #bdc3c7;
            margin-bottom: 10px;
        }
        
        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .expense-item {
            background: #f8fcff;
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            border-left: 5px solid #3498db;
            transition: all 0.3s ease;
        }
        
        .expense-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-approved { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
        
        .per-diem-info {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            padding: 12px 18px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 14px;
            color: #155724;
            border-left: 4px solid #28a745;
            font-weight: 600;
        }
        
        .success-message, .error-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
            font-weight: 600;
        }
        
        .success-message {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .error-message {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { padding: 20px; flex-direction: column; gap: 15px; }
            .nav-tabs { flex-wrap: wrap; }
            .nav-tab { padding: 12px 20px; font-size: 14px; }
            .tab-content { padding: 20px; }
            .stats { grid-template-columns: repeat(2, 1fr); }
            input, select, textarea { font-size: 16px; }
        }
        
        @media (max-width: 480px) {
            .stats { grid-template-columns: 1fr; }
            .nav-tab { padding: 10px 16px; font-size: 12px; }
        }
        
        #file-input { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-info">
                <h1 id="welcome-text">ğŸ‘¤ Employee Dashboard</h1>
                <p id="user-info">Loading...</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-light" onclick="logout()">ğŸšª Logout</button>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="total-expenses">-</div>
                <div class="stat-label">My Expenses</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-amount">-</div>
                <div class="stat-label">Total Amount</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="approved-amount">-</div>
                <div class="stat-label">Approved</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pending-count">-</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('submit')">ğŸ“ Submit Expense</button>
            <button class="nav-tab" onclick="showTab('history')">ğŸ“‹ My Expenses</button>
        </div>
        
        <div id="submit-tab" class="tab-content active">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ“ Submit New Expense</h3>
            
            <div class="success-message" id="success-message">
                âœ… <span id="success-text">Expense submitted successfully!</span>
            </div>
            
            <div class="error-message" id="error-message">
                âŒ <span id="error-text">Something went wrong</span>
            </div>
            
            <form id="expense-form" class="expense-form">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="form-group">
                        <label for="expense-type">Expense Type *</label>
                        <select id="expense-type" name="expense_type" required onchange="updatePerDiemRate()">
                            <option value="">Select expense type...</option>
                            <optgroup label="ğŸ›ï¸ Government Per Diem (NJC Fixed Rates - One per day)">
                                <option value="breakfast">ğŸ¥ Breakfast - $23.45</option>
                                <option value="lunch">ğŸ¥— Lunch - $29.75</option>
                                <option value="dinner">ğŸ½ï¸ Dinner - $47.05</option>
                                <option value="incidentals">ğŸ“± Incidentals - $32.08</option>
                            </optgroup>
                            <optgroup label="ğŸš— Travel & Accommodation">
                                <option value="vehicle_km">ğŸš— Vehicle (per km) - $0.68</option>
                                <option value="hotel">ğŸ¨ Hotel (Receipt Required) - No Limit</option>
                            </optgroup>
                            <optgroup label="ğŸ“ Other Business Expenses">
                                <option value="other">ğŸ“ Other Expense (Custom Amount)</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="expense-date">Date *</label>
                        <input type="date" id="expense-date" name="date" required>
                    </div>
                </div>
                
                <!-- Hotel Date Range (hidden by default) -->
                <div id="hotel-date-range" style="display: none; margin: 20px 0; padding: 20px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px;">
                    <h4 style="color: #856404; margin-bottom: 15px;">ğŸ¨ Hotel Stay Details</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="hotel-checkin">Check-in Date *</label>
                            <input type="date" id="hotel-checkin" onchange="calculateHotelNights()" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="hotel-checkout">Check-out Date *</label>
                            <input type="date" id="hotel-checkout" onchange="calculateHotelNights()" required>
                        </div>
                    </div>
                    <div id="hotel-nights-display" style="margin: 15px 0; padding: 15px; background: #fff; border: 1px solid #ffc107; border-radius: 8px; font-weight: bold; color: #856404; text-align: center;"></div>
                </div>
                
                <div class="form-group" style="margin: 20px 0;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <label for="trip-select" style="margin: 0; flex: 1;">ğŸ§³ Select Trip *</label>
                        <button type="button" id="trip-lock-btn" onclick="toggleTripLock()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; display: none;">
                            ğŸ”“ Unlocked
                        </button>
                    </div>
                    <select id="trip-select" name="trip_id" style="margin-bottom: 10px;" onchange="handleTripSelection()">
                        <option value="">-- Select a trip (required) --</option>
                    </select>
                    <div id="trip-info" style="margin-top: 10px; padding: 10px; border-radius: 8px; display: none;"></div>
                    <div style="margin-top: 10px;">
                        <button type="button" onclick="showNewTripModal()" class="btn" style="background: #28a745; padding: 8px 16px; font-size: 14px;">
                            â• Create New Trip
                        </button>
                        <button type="button" onclick="loadTrips()" class="btn" style="background: #17a2b8; padding: 8px 16px; font-size: 14px; margin-left: 10px;">
                            ğŸ”„ Refresh Trips
                        </button>
                        <button type="button" onclick="clearTripSelection()" class="btn" style="background: #6c757d; padding: 8px 16px; font-size: 14px; margin-left: 10px;">
                            ğŸš« Clear Trip
                        </button>
                    </div>
                </div>
                
                <div class="per-diem-info" id="per-diem-display">
                    ğŸ’° Select expense type to see NJC rate
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="form-group">
                        <label for="location">Location *</label>
                        <input type="text" id="location" name="location" placeholder="e.g., Ottawa, ON" required>
                    </div>
                    
                    <div class="form-group" id="vehicle-km-group" style="display: none;">
                        <label for="kilometers">Kilometers Traveled *</label>
                        <input type="number" id="kilometers" name="kilometers" step="0.1" placeholder="150.5" onchange="calculateVehicleAmount()">
                        <small style="color: #666; font-size: 12px;">NJC rate: $0.68 per kilometer</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount" id="amount-label">Amount Paid *</label>
                        <input type="number" id="amount" name="amount" step="0.01" placeholder="25.50" required>
                        <div id="amount-info" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="vendor">Vendor/Details *</label>
                    <input type="text" id="vendor" name="vendor" placeholder="e.g., Tim Hortons, Hotel Name, Distance in KM" required>
                </div>
                
                <div class="form-group">
                    <label for="description">Description (Optional)</label>
                    <textarea id="description" name="description" rows="3" placeholder="Business lunch with client, conference travel, etc..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Receipt Photo</label>
                    <div class="photo-section" onclick="document.getElementById('file-input').click()">
                        <div class="camera-icon">ğŸ“·</div>
                        <div><strong>Tap to capture or upload receipt</strong></div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Supports: JPG, PNG, GIF, WebP (Max 10MB)</div>
                        <img id="photo-preview" class="photo-preview" style="display: none;">
                    </div>
                    <input type="file" id="file-input" accept="image/*" capture="environment">
                </div>
                
                <!-- Single button - all expenses must be associated with a trip -->
                <div style="margin-top: 20px;">
                    <button type="button" onclick="addExpenseToTrip()" class="btn btn-success" style="padding: 18px; font-size: 16px; width: 100%;">
                        ğŸ§³ Add Expense to Trip
                    </button>
                </div>
                
                <!-- Individual expenses draft list -->
                <div id="individual-draft-section" style="display: none; margin-top: 30px; padding: 20px; background: #f0f8ff; border-radius: 12px;">
                    <h4 style="color: #007bff; margin-bottom: 15px;">ğŸ’° Individual Expenses (Draft)</h4>
                    <div id="draft-individual-list">
                        <p style="text-align: center; color: #6c757d; padding: 20px;">
                            No individual expenses added yet.<br>
                            <small>Click "Add Individual Expense" to start building your expense batch.</small>
                        </p>
                    </div>
                    <div id="individual-submit-section" style="margin-top: 20px; text-align: center; display: none;">
                        <button type="button" onclick="submitIndividualExpensesForApproval()" class="btn btn-primary" style="padding: 15px 30px; font-size: 16px;">
                            ğŸ“¤ Submit All Individual Expenses
                        </button>
                        <button type="button" onclick="clearIndividualDraft()" class="btn" style="background: #dc3545; color: white; padding: 15px 30px; font-size: 16px; margin-left: 15px;">
                            ğŸ—‘ï¸ Clear Individual Draft
                        </button>
                    </div>
                </div>

                <!-- Trip expenses draft list -->
                <div id="trip-draft-section" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 12px;">
                    <h4 style="color: #28a745; margin-bottom: 15px;">ğŸ§³ Trip Expenses (Draft)</h4>
                    <div id="draft-expenses-list">
                        <p style="text-align: center; color: #6c757d; padding: 20px;">
                            No expenses added to trip yet.<br>
                            <small>Select a trip and click "Add to Trip" to start building your expense report.</small>
                        </p>
                    </div>
                    <div id="trip-submit-section" style="margin-top: 20px; text-align: center; display: none;">
                        <button type="button" onclick="submitTripForApproval()" class="btn btn-success" style="padding: 15px 30px; font-size: 16px;">
                            ğŸ“¤ Submit Trip for Approval
                        </button>
                        <button type="button" onclick="clearTripDraft()" class="btn" style="background: #dc3545; color: white; padding: 15px 30px; font-size: 16px; margin-left: 15px;">
                            ğŸ—‘ï¸ Clear Trip Draft
                        </button>
                    </div>
                </div>
            </form>
        </div>
        
        <div id="history-tab" class="tab-content">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ“‹ My Expense History</h3>
            <div id="expenses-container">
                <div style="text-align: center; padding: 40px; color: #6c757d;">
                    <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“Š</div>
                    <p>Loading your expenses...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ§³ New Trip Modal -->
    <div id="new-trip-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90%; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ§³ Create New Trip</h3>
            
            <form id="new-trip-form" onsubmit="createNewTrip(event)">
                <div class="form-group">
                    <label for="trip-name">Trip Name *</label>
                    <input type="text" id="trip-name" placeholder="e.g., Montreal to Toronto Training" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="trip-start-date">Start Date *</label>
                        <input type="date" id="trip-start-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="trip-end-date">End Date *</label>
                        <input type="date" id="trip-end-date" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="trip-destination">Destination</label>
                    <input type="text" id="trip-destination" placeholder="e.g., Toronto, ON">
                </div>
                
                <div class="form-group">
                    <label for="trip-purpose">Purpose</label>
                    <textarea id="trip-purpose" placeholder="e.g., Annual training conference, business meetings" rows="3"></textarea>
                </div>
                
                <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: flex-end;">
                    <button type="button" onclick="hideNewTripModal()" class="btn" style="background: #6c757d;">
                        âŒ Cancel
                    </button>
                    <button type="submit" class="btn" style="background: #28a745;">
                        âœ… Create Trip
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        /* 
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘                         EMPLOYEE DASHBOARD JAVASCRIPT                        â•‘
        â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        â•‘ SECTION 1: Global Variables & Configuration                                  â•‘
        â•‘ SECTION 2: Authentication & User Management                                  â•‘  
        â•‘ SECTION 3: Individual Expense Management                                     â•‘
        â•‘ SECTION 4: Trip Expense Management                                           â•‘
        â•‘ SECTION 5: Hotel Date Range & Per Diem Logic                                â•‘
        â•‘ SECTION 6: UI Helper Functions                                               â•‘
        â•‘ SECTION 7: Data Loading & Validation                                         â•‘
        â•‘ SECTION 8: Initialization & Event Listeners                                  â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        */

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECTION 1: GLOBAL VARIABLES & CONFIGURATION  
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Authentication & user session
        let currentUser = null;
        let sessionId = null;
        
        // Official NJC rates (updated 2026)
        const njcRates = {
            breakfast: { rate: 23.45, icon: 'ğŸ¥', name: 'Breakfast' },
            lunch: { rate: 29.75, icon: 'ğŸ¥—', name: 'Lunch' },
            dinner: { rate: 47.05, icon: 'ğŸ½ï¸', name: 'Dinner' },
            incidentals: { rate: 32.08, icon: 'ğŸ“±', name: 'Incidentals' },
            vehicle_km: { rate: 0.68, icon: 'ğŸš—', name: 'Vehicle (per KM)' },
            hotel: { rate: null, icon: 'ğŸ¨', name: 'Hotel', no_limit: true }
        };
        
        // Trip draft expenses (stored locally until trip submission)
        let draftTripExpenses = [];
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DRAFT PERSISTENCE - Save/Load drafts to localStorage
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Drafts survive page refresh, logout, and browser close
        
        function saveDrafts() {
            try {
                const userId = currentUser ? currentUser.id : 'unknown';
                localStorage.setItem(`drafts_individual_${userId}`, JSON.stringify(draftIndividualExpenses));
                localStorage.setItem(`drafts_trip_${userId}`, JSON.stringify(draftTripExpenses));
                console.log(`ğŸ’¾ Drafts saved: ${draftIndividualExpenses.length} individual, ${draftTripExpenses.length} trip`);
            } catch (e) {
                console.error('âŒ Failed to save drafts:', e);
            }
        }
        
        function loadDrafts() {
            try {
                const userId = currentUser ? currentUser.id : 'unknown';
                const savedIndividual = localStorage.getItem(`drafts_individual_${userId}`);
                const savedTrip = localStorage.getItem(`drafts_trip_${userId}`);
                
                // Load trip drafts
                if (savedTrip) {
                    draftTripExpenses = JSON.parse(savedTrip);
                    console.log(`ğŸ“‚ Loaded ${draftTripExpenses.length} trip drafts from storage`);
                }
                
                // Migrate any old individual drafts into trip drafts
                if (savedIndividual) {
                    const oldIndividual = JSON.parse(savedIndividual);
                    if (oldIndividual.length > 0) {
                        console.log(`ğŸ“‚ Found ${oldIndividual.length} old individual drafts â€” migrating to trip drafts`);
                        
                        // Move individual drafts into trip drafts (they'll need a trip assigned)
                        for (const expense of oldIndividual) {
                            if (!expense.trip_id) {
                                expense.trip_name = 'âš ï¸ Needs trip assignment';
                            }
                            draftTripExpenses.push(expense);
                        }
                        
                        // Clear old individual drafts
                        draftIndividualExpenses = [];
                        localStorage.removeItem(`drafts_individual_${userId}`);
                        saveDrafts();
                        
                        showMessage('info', `ğŸ“‚ ${oldIndividual.length} draft expense(s) migrated. Please assign them to a trip before submitting.`);
                    }
                }
                
                // Update UI
                updateDraftExpensesList();
                
                // Notify user if drafts were restored
                if (draftTripExpenses.length > 0) {
                    showMessage('info', `ğŸ“‚ Restored ${draftTripExpenses.length} draft expense(s) from your previous session.`);
                }
            } catch (e) {
                console.error('âŒ Failed to load drafts:', e);
            }
        }
        
        // Individual draft expenses (stored locally until batch submission)
        let draftIndividualExpenses = [];
        
        // Trip locking state
        let isTripLocked = false;
        let lockedTripId = null;
        let lockedTripName = '';
        
        // Trip location auto-fill (remembers last location used per trip)
        let tripLocationMemory = {}; // { tripId: "lastLocationUsed" }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECTION 3: INDIVIDUAL EXPENSE MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Purpose: Handle standalone expenses not associated with trips
        // Features: Draft system, batch submission, validation
        // Business Logic: No trip selection required, per diem validation applies
        
        /**
         * Add Individual Expense to Draft List
         * Handles standalone expenses that are not part of a business trip
         * Validates hotel requirements (receipt + date range) and per diem limits
         * Stores in local draftIndividualExpenses array until batch submission
         */
        async function addIndividualExpenseFixed() {
            // FIXED FUNCTION: This should definitely work now
            console.log('ğŸ”¥ FIXED INDIVIDUAL EXPENSE BUTTON CLICKED');
            console.log('ğŸ’° addIndividualExpenseFixed() called - NO TRIP NEEDED');
            console.log('ğŸ’° Current individual draft count:', draftIndividualExpenses.length);
            
            // Function now works correctly - removed debug alert
            
            try {
                const form = document.getElementById('expense-form');
                if (!form.checkValidity()) {
                    console.log('âŒ Form validation failed');
                    form.reportValidity();
                    return;
                }
                console.log('âœ… Form validation passed');
                
                const expenseType = document.getElementById('expense-type').value;
                const fileInput = document.getElementById('file-input');
                
                // Validate hotel receipt and date requirements
                if (expenseType === 'hotel') {
                    if (!fileInput.files[0]) {
                        showMessage('error', 'ğŸ“· Hotel expenses require a receipt photo. Please scroll down and capture/upload your receipt.');
                        document.querySelector('.photo-section').scrollIntoView({ behavior: 'smooth' });
                        return;
                    }
                    
                    const checkinDate = document.getElementById('hotel-checkin').value;
                    const checkoutDate = document.getElementById('hotel-checkout').value;
                    
                    if (!checkinDate || !checkoutDate) {
                        showMessage('error', 'ğŸ“… Hotel expenses require check-in and check-out dates. Please fill in the hotel stay details.');
                        document.getElementById('hotel-date-range').scrollIntoView({ behavior: 'smooth' });
                        return;
                    }
                    
                    if (new Date(checkoutDate) <= new Date(checkinDate)) {
                        showMessage('error', 'ğŸ“… Check-out date must be after check-in date.');
                        document.getElementById('hotel-checkout').focus();
                        return;
                    }
                }
                
                // Get vendor value (will be auto-set for per diem items)
                const vendorValue = document.getElementById('vendor').value || 'NJC Per Diem Rate';
                
                // CRITICAL: Check for per diem duplicates BEFORE adding to draft
                const expenseDate = document.getElementById('expense-date').value;
                const perDiemTypes = ['breakfast', 'lunch', 'dinner', 'incidentals'];
                
                if (perDiemTypes.includes(expenseType)) {
                    // Check existing drafts for same per diem type on same date
                    const duplicateInDraft = draftIndividualExpenses.find(draft => 
                        draft.expense_type === expenseType && draft.date === expenseDate
                    );
                    
                    if (duplicateInDraft) {
                        const mealName = getExpenseTypeName(expenseType);
                        showMessage('error', `âŒ DUPLICATE PER DIEM: You already have ${mealName} for ${expenseDate} in your draft. Only ONE per day allowed.`);
                        alert(`âŒ COMPLIANCE VIOLATION: You already have ${mealName} for ${expenseDate}. Only ONE per day allowed!`);
                        return;
                    }
                    
                    // Check submitted expenses via API for same per diem type on same date  
                    try {
                        const response = await fetch('/api/my-expenses', {
                            headers: { 'Authorization': `Bearer ${sessionId}` }
                        });
                        const expenses = await response.json();
                        
                        const duplicateSubmitted = expenses.find(exp => 
                            exp.expense_type === expenseType && 
                            exp.date === expenseDate && 
                            exp.status !== 'rejected'
                        );
                        
                        if (duplicateSubmitted) {
                            const mealName = getExpenseTypeName(expenseType);
                            showMessage('error', `âŒ DUPLICATE PER DIEM: You already claimed ${mealName} for ${expenseDate}. Only ONE per day allowed.`);
                            alert(`âŒ COMPLIANCE VIOLATION: You already claimed ${mealName} for ${expenseDate}!`);
                            return;
                        }
                    } catch (error) {
                        console.error('âŒ Error checking existing per diem expenses:', error);
                        showMessage('error', 'âŒ Could not validate per diem. Please try again.');
                        return;
                    }
                }
                
                // Create draft expense (only after validation passes)
                const expense = {
                    id: Date.now(),
                    expense_type: expenseType,
                    meal_name: getExpenseTypeName(expenseType),
                    date: expenseDate,
                    location: document.getElementById('location').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    vendor: vendorValue,
                    description: document.getElementById('description').value,
                    trip_id: null, // Individual expenses have no trip
                    trip_name: null
                };
                
                draftIndividualExpenses.push(expense);
                saveDrafts();
                console.log('âœ… Expense added to individual draft. New count:', draftIndividualExpenses.length);
                
                // Clear form
                form.reset();
                resetPhotoSection();
                document.getElementById('expense-date').valueAsDate = new Date();
                updatePerDiemRate();
                
                updateDraftIndividualList();
                
                showMessage('success', `âœ… ${expense.meal_name} added to individual draft! (${draftIndividualExpenses.length} expenses total)`);
                
                // Function completed successfully - expense added to draft only
                console.log('ğŸ¯ CRITICAL: Function completed - NO API calls made, only added to draft array');
                
            } catch (error) {
                console.error('âŒ Error in addIndividualExpenseFixed:', error);
                showMessage('error', `âŒ Error adding individual expense: ${error.message}`);
            }
        }
        
        function updateDraftIndividualList() {
            console.log('ğŸ”„ updateDraftIndividualList called. Expenses count:', draftIndividualExpenses.length);
            
            const draftList = document.getElementById('draft-individual-list');
            const submitSection = document.getElementById('individual-submit-section');
            
            if (!draftList) {
                console.error('âŒ draft-individual-list element not found!');
                return;
            }
            
            if (draftIndividualExpenses.length === 0) {
                console.log('ğŸ“ No individual expenses, showing empty state');
                draftList.innerHTML = `
                    <p style="text-align: center; color: #6c757d; padding: 20px;">
                        No individual expenses added yet.<br>
                        <small>Click "Add Individual Expense" to start building your expense batch.</small>
                    </p>
                `;
                submitSection.style.display = 'none';
                return;
            }
            
            console.log('ğŸ“‹ Building individual draft list for', draftIndividualExpenses.length, 'expenses');
            
            const total = draftIndividualExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            
            let html = `
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #007bff; box-shadow: 0 4px 8px rgba(0,123,255,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <h4 style="margin: 0; color: #004085;">ğŸ’° Individual Expense Batch</h4>
                            <div style="color: #004085; font-size: 18px; font-weight: bold;">
                                ${draftIndividualExpenses.length} expenses â€¢ Total: $${total.toFixed(2)}
                            </div>
                        </div>
                        <div style="background: #007bff; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold;">
                            DRAFT
                        </div>
                    </div>
                    <small style="color: #004085; opacity: 0.8;">
                        âœ… Expenses added successfully â€¢ Click "Submit All Individual Expenses" when complete
                    </small>
                </div>
            `;
            
            draftIndividualExpenses.forEach((expense, index) => {
                const icon = njcRates[expense.expense_type]?.icon || 'ğŸ’°';
                const isPerDiem = ['breakfast', 'lunch', 'dinner', 'incidentals'].includes(expense.expense_type);
                const vendorDisplay = isPerDiem ? 'NJC Per Diem' : expense.vendor;
                
                html += `
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px; border-left: 4px solid #007bff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                <span style="font-size: 20px; margin-right: 10px;">${icon}</span>
                                <div>
                                    <strong style="color: #004085; font-size: 16px;">${expense.meal_name}</strong>
                                    <span style="color: #007bff; font-weight: bold; margin-left: 10px; font-size: 16px;">$${expense.amount.toFixed(2)}</span>
                                </div>
                            </div>
                            <div style="color: #666; font-size: 13px; line-height: 1.4;">
                                ğŸ“… ${expense.date} â€¢ ğŸ“ ${expense.location} â€¢ ğŸª ${vendorDisplay}<br>
                                ${expense.description ? 'ğŸ“ ' + expense.description : '<em>No additional notes</em>'}
                            </div>
                        </div>
                        <button onclick="removeIndividualDraftExpense(${index})" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                            ğŸ—‘ï¸ Remove
                        </button>
                    </div>
                `;
            });
            
            draftList.innerHTML = html;
            submitSection.style.display = 'block';
            
            console.log('âœ… Individual draft list HTML updated successfully');
        }
        
        function removeIndividualDraftExpense(index) {
            const removed = draftIndividualExpenses[index];
            draftIndividualExpenses.splice(index, 1);
            saveDrafts();
            updateDraftIndividualList();
            showMessage('info', `ğŸ—‘ï¸ ${removed.meal_name} removed from individual draft`);
        }
        
        async function submitIndividualExpensesForApproval() {
            if (draftIndividualExpenses.length === 0) {
                showMessage('error', 'âŒ No individual expenses to submit.');
                return;
            }
            
            if (!confirm(`Submit ${draftIndividualExpenses.length} individual expenses for approval?`)) {
                return;
            }
            
            try {
                showMessage('info', 'ğŸ“¤ Submitting individual expenses...');
                
                // Submit each expense using JSON (not FormData)
                let successCount = 0;
                let errors = [];
                
                for (const expense of draftIndividualExpenses) {
                    try {
                        const formData = new FormData();
                        formData.append('expense_type', expense.expense_type);
                        formData.append('meal_name', expense.meal_name);
                        formData.append('date', expense.date);
                        formData.append('location', expense.location);
                        formData.append('amount', expense.amount);
                        formData.append('vendor', expense.vendor || 'NJC Per Diem Rate');
                        formData.append('description', expense.description || '');
                        
                        const response = await fetch('/api/expenses', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${sessionId}` },
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok && result.success) {
                            successCount++;
                            console.log(`âœ… Individual expense submitted: ${expense.meal_name} - $${expense.amount}`);
                        } else {
                            const errorMsg = result.error || 'Unknown error';
                            errors.push(`${expense.meal_name}: ${errorMsg}`);
                            console.error(`âŒ Individual expense failed: ${expense.meal_name} - ${errorMsg}`);
                        }
                    } catch (expError) {
                        errors.push(`${expense.meal_name}: Network error - ${expError.message}`);
                        console.error(`âŒ Network error for ${expense.meal_name}:`, expError);
                    }
                }
                
                if (successCount > 0) {
                    if (successCount === draftIndividualExpenses.length) {
                        showMessage('success', `ğŸ‰ ${successCount} individual expenses submitted for approval!`);
                    } else {
                        showMessage('warning', `âš ï¸ ${successCount}/${draftIndividualExpenses.length} submitted. Errors:\n${errors.join('\n')}`);
                        alert(`âš ï¸ Some expenses failed:\n\n${errors.join('\n')}`);
                    }
                    
                    // Clear draft
                    draftIndividualExpenses = [];
                    saveDrafts();
                    updateDraftIndividualList();
                    
                    // Refresh expense history and stats
                    await loadMyExpenses();
                    await loadDashboardStats();
                } else {
                    showMessage('error', `âŒ All expenses failed:\n${errors.join('\n')}`);
                    alert(`âŒ Submission failed:\n\n${errors.join('\n')}\n\nYour draft is preserved.`);
                }
                
            } catch (error) {
                console.error('Individual expenses submission error:', error);
                showMessage('error', 'âŒ Error submitting individual expenses. Please try again.');
            }
        }
        
        function clearIndividualDraft() {
            if (draftIndividualExpenses.length === 0) {
                showMessage('info', 'ğŸ“ No individual expenses to clear.');
                return;
            }
            
            const expenseCount = draftIndividualExpenses.length;
            
            if (!confirm(`Clear all ${expenseCount} individual expenses from draft?`)) {
                return;
            }
            
            draftIndividualExpenses = [];
            saveDrafts();
            updateDraftIndividualList();
            showMessage('success', `ğŸ—‘ï¸ ${expenseCount} individual expenses cleared from draft`);
        }
        
        // Legacy function (kept for compatibility but redirects to individual expense)
        async function submitIndividualExpense() {
            console.log('ğŸ“¤ Submitting individual expense...');
            
            const form = document.getElementById('expense-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const expenseType = document.getElementById('expense-type').value;
            
            // Validate hotel receipt and date requirements
            if (expenseType === 'hotel') {
                if (!fileInput.files[0]) {
                    showMessage('error', 'ğŸ“· Hotel expenses require a receipt photo. Please scroll down and capture/upload your receipt.');
                    document.querySelector('.photo-section').scrollIntoView({ behavior: 'smooth' });
                    return;
                }
                
                const checkinDate = document.getElementById('hotel-checkin').value;
                const checkoutDate = document.getElementById('hotel-checkout').value;
                
                if (!checkinDate || !checkoutDate) {
                    showMessage('error', 'ğŸ“… Hotel expenses require check-in and check-out dates. Please fill in the hotel stay details.');
                    document.getElementById('hotel-date-range').scrollIntoView({ behavior: 'smooth' });
                    return;
                }
                
                if (new Date(checkoutDate) <= new Date(checkinDate)) {
                    showMessage('error', 'ğŸ“… Check-out date must be after check-in date.');
                    document.getElementById('hotel-checkout').focus();
                    return;
                }
            }
            
            const formData = new FormData();
            formData.append('expense_type', expenseType);
            formData.append('meal_name', getExpenseTypeName(expenseType));
            formData.append('date', document.getElementById('expense-date').value);
            formData.append('location', document.getElementById('location').value);
            formData.append('amount', document.getElementById('amount').value);
            formData.append('vendor', document.getElementById('vendor').value);
            formData.append('description', document.getElementById('description').value);
            
            if (fileInput.files[0]) {
                formData.append('receipt', fileInput.files[0]);
            }
            
            try {
                const response = await fetch('/api/expenses', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${sessionId}` },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', 'âœ… Individual expense submitted for approval!');
                    form.reset();
                    resetPhotoSection();
                    document.getElementById('expense-date').valueAsDate = new Date();
                    updatePerDiemRate();
                    await loadMyExpenses();
                } else {
                    showMessage('error', 'âŒ ' + (result.error || 'Failed to submit expense'));
                }
            } catch (error) {
                console.error('Submission error:', error);
                showMessage('error', 'âŒ Network error. Please try again.');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECTION 4: TRIP EXPENSE MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Purpose: Handle expenses associated with business trips (Concur-style workflow)
        // Features: Trip selection, location auto-fill, trip locking, batch submission
        // Business Logic: Requires trip selection, groups expenses by trip for approval
        
        /**
         * Add Expense to Selected Trip
         * Associates expense with a business trip for group submission
         * Implements location memory and trip locking for better UX
         * Validates trip selection and maintains trip-expense relationships
         */
        async function addExpenseToTrip() {
            console.log('ğŸ§³ addExpenseToTrip() called - TRIP SELECTION REQUIRED');
            console.log('ğŸ§³ Current draft expenses count:', draftTripExpenses.length);
            
            try {
                const form = document.getElementById('expense-form');
                if (!form.checkValidity()) {
                    console.log('âŒ Form validation failed');
                    form.reportValidity();
                    return;
                }
                console.log('âœ… Form validation passed');
                
                // Check trip selection
                const tripSelect = document.getElementById('trip-select');
                let selectedTripId = tripSelect.value;
                console.log('ğŸ§³ Selected trip ID:', selectedTripId);
                
                // Use locked trip if available
                if (isTripLocked && lockedTripId) {
                    selectedTripId = lockedTripId;
                    console.log('ğŸ”’ Using locked trip ID:', selectedTripId);
                } else if (!selectedTripId) {
                    console.log('âŒ No trip selected');
                    showMessage('error', 'ğŸ§³ Please select or create a trip first! All expenses must be associated with a trip.');
                    document.getElementById('trip-select').focus();
                    return;
                }
                
                // Get vendor value (will be auto-set for per diem items)
                const vendorValue = document.getElementById('vendor').value || 'NJC Per Diem Rate';
                
                // CRITICAL: Check for per diem duplicates BEFORE adding to trip draft (SAME AS INDIVIDUAL)
                const expenseType = document.getElementById('expense-type').value;
                const expenseDate = document.getElementById('expense-date').value;
                const perDiemTypes = ['breakfast', 'lunch', 'dinner', 'incidentals'];
                
                if (perDiemTypes.includes(expenseType)) {
                    // Check existing trip drafts for same per diem type on same date
                    const duplicateInTripDraft = draftTripExpenses.find(draft => 
                        draft.expense_type === expenseType && draft.date === expenseDate
                    );
                    
                    if (duplicateInTripDraft) {
                        const mealName = getExpenseTypeName(expenseType);
                        showMessage('error', `âŒ DUPLICATE PER DIEM: You already have ${mealName} for ${expenseDate} in this trip. Only ONE per day allowed.`);
                        alert(`âŒ COMPLIANCE VIOLATION: You already have ${mealName} for ${expenseDate} in your trip draft!`);
                        return;
                    }
                    
                    // Check existing individual drafts for same per diem type on same date
                    const duplicateInIndividualDraft = draftIndividualExpenses.find(draft => 
                        draft.expense_type === expenseType && draft.date === expenseDate
                    );
                    
                    if (duplicateInIndividualDraft) {
                        const mealName = getExpenseTypeName(expenseType);
                        showMessage('error', `âŒ DUPLICATE PER DIEM: You already have ${mealName} for ${expenseDate} in individual drafts. Only ONE per day allowed.`);
                        alert(`âŒ COMPLIANCE VIOLATION: You already have ${mealName} for ${expenseDate} in individual expenses!`);
                        return;
                    }
                    
                    // Check submitted expenses via API for same per diem type on same date  
                    try {
                        const response = await fetch('/api/my-expenses', {
                            headers: { 'Authorization': `Bearer ${sessionId}` }
                        });
                        const expenses = await response.json();
                        
                        const duplicateSubmitted = expenses.find(exp => 
                            exp.expense_type === expenseType && 
                            exp.date === expenseDate && 
                            exp.status !== 'rejected'
                        );
                        
                        if (duplicateSubmitted) {
                            const mealName = getExpenseTypeName(expenseType);
                            showMessage('error', `âŒ DUPLICATE PER DIEM: You already claimed ${mealName} for ${expenseDate}. Only ONE per day allowed.`);
                            alert(`âŒ COMPLIANCE VIOLATION: You already claimed ${mealName} for ${expenseDate}!`);
                            return;
                        }
                    } catch (error) {
                        console.error('âŒ Error checking existing per diem expenses:', error);
                        showMessage('error', 'âŒ Could not validate per diem. Please try again.');
                        return;
                    }
                }
                
                // Create draft expense FOR TRIP
                const expense = {
                    id: Date.now(),
                    expense_type: document.getElementById('expense-type').value,
                    meal_name: getExpenseTypeName(document.getElementById('expense-type').value),
                    date: document.getElementById('expense-date').value,
                    location: document.getElementById('location').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    vendor: vendorValue,
                    description: document.getElementById('description').value,
                    trip_id: selectedTripId,
                    trip_name: isTripLocked ? lockedTripName : tripSelect.options[tripSelect.selectedIndex].text
                };
            
            draftTripExpenses.push(expense);
            saveDrafts();
            console.log('âœ… Expense added to draft. New count:', draftTripExpenses.length);
            console.log('ğŸ“‹ Draft expense details:', expense);
            
            // Remember the location for this trip (for auto-fill next time)
            if (expense.location && expense.location.trim()) {
                tripLocationMemory[selectedTripId] = expense.location.trim();
                console.log('ğŸ“ Saved location for trip', selectedTripId, ':', expense.location);
            }
            
            // Clear form but preserve trip selection
            form.reset();
            resetPhotoSection();
            document.getElementById('expense-date').valueAsDate = new Date();
            updatePerDiemRate();
            
            // Restore trip selection (especially important when locked)
            if (isTripLocked) {
                tripSelect.value = lockedTripId;
                tripSelect.disabled = true;
            } else {
                tripSelect.value = selectedTripId;
            }
            
            // Auto-fill location from memory for next expense
            if (tripLocationMemory[selectedTripId]) {
                document.getElementById('location').value = tripLocationMemory[selectedTripId];
            }
            
            console.log('ğŸ”„ Calling updateDraftExpensesList...');
            updateDraftExpensesList();
            updateTripInfo(selectedTripId);
            
            showMessage('success', `âœ… ${expense.meal_name} added to trip! (${draftTripExpenses.length} expenses total)`);
            
            } catch (error) {
                console.error('âŒ Error in addExpenseToTrip:', error);
                showMessage('error', `âŒ Error adding expense: ${error.message}`);
            }
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            sessionId = localStorage.getItem('sessionId');
            currentUser = JSON.parse(localStorage.getItem('user') || 'null');
            
            if (!sessionId || !currentUser) {
                window.location.href = '/login';
                return;
            }
            
            // Verify session and load user info
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                if (!response.ok) {
                    throw new Error('Session expired');
                }
                
                const user = await response.json();
                currentUser = user;
                localStorage.setItem('user', JSON.stringify(user));
                
                // Update UI
                document.getElementById('welcome-text').textContent = `ğŸ‘¤ ${user.name}'s Dashboard`;
                document.getElementById('user-info').textContent = `${user.position || 'Employee'} â€¢ ${user.department || 'Department'} â€¢ ${user.employee_number || 'No ID'}`;
                
                // Set today's date
                document.getElementById('expense-date').valueAsDate = new Date();
                
                // Load data  
                await loadMyExpenses();
                
                // Load saved drafts from localStorage (survives page reload/logout)
                loadDrafts();
                
                // Load trips for dropdown
                await loadTrips();
                
            } catch (error) {
                console.error('Session validation failed:', error);
                localStorage.removeItem('sessionId');
                localStorage.removeItem('user');
                window.location.href = '/login';
            }
        });
        
        // Tab management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'history') {
                loadMyExpenses();
            }
        }
        
        // Get expense type display name
        function getExpenseTypeName(expenseType) {
            const names = {
                'breakfast': 'Breakfast',
                'lunch': 'Lunch', 
                'dinner': 'Dinner',
                'vehicle_km': 'Vehicle Allowance',
                'hotel': 'Hotel/Accommodation',
                'incidentals': 'Incidentals',
                'other': 'Other Expense'
            };
            return names[expenseType] || expenseType;
        }
        
        // Update per diem rate display and form fields
        async function updatePerDiemRate() {
            const selectedType = document.getElementById('expense-type').value;
            const display = document.getElementById('per-diem-display');
            const amountField = document.getElementById('amount');
            const amountInfo = document.getElementById('amount-info');
            const amountLabel = document.getElementById('amount-label');
            const vehicleKmGroup = document.getElementById('vehicle-km-group');
            
            console.log('ğŸ” updatePerDiemRate called with:', selectedType);
            
            // Reset form state
            vehicleKmGroup.style.display = 'none';
            amountField.readOnly = false;
            amountField.style.backgroundColor = '';
            amountInfo.innerHTML = '';
            
            // Hide hotel date range by default (will be shown if hotel is selected)
            hideHotelDateRange();
            
            // Reset photo section highlighting for non-hotel expenses  
            resetPhotoSectionHighlight();
            
            if (!selectedType || selectedType === 'other') {
                display.innerHTML = 'ğŸ’° Select expense type to see NJC rate';
                display.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
                display.style.color = '#6c757d';
                amountLabel.textContent = 'Amount Paid *';
                
                // Show vendor field for other/unselected expenses
                const vendorField = document.getElementById('vendor');
                const vendorLabel = document.querySelector('label[for="vendor"]');
                vendorField.style.display = 'block';
                vendorLabel.style.display = 'block';
                vendorField.setAttribute('required', true);
                vendorField.value = '';
                vendorField.placeholder = 'e.g., Tim Hortons, Hotel Name, Distance in KM';
                
                return;
            }
            
            // Handle fixed rates locally for immediate response
            const fixedRates = {
                'breakfast': { rate: 23.45, fixed: true, description: 'NJC Standard Breakfast Rate' },
                'lunch': { rate: 29.75, fixed: true, description: 'NJC Standard Lunch Rate' },
                'dinner': { rate: 47.05, fixed: true, description: 'NJC Standard Dinner Rate' },
                'incidentals': { rate: 32.08, fixed: true, description: 'NJC Incidental Allowance (Daily)' },
                'vehicle_km': { rate: 0.68, fixed: true, description: 'NJC Vehicle Allowance per Kilometre' },
                'hotel': { rate: null, fixed: false, max_amount: null, description: 'Hotel/Accommodation (Receipt & Dates Required)', no_limit: true }
            };
            
            if (fixedRates[selectedType]) {
                const rateData = fixedRates[selectedType];
                console.log('ğŸ“Š Using fixed rate data:', rateData);
                
                // Update display
                let rateText;
                if (selectedType === 'vehicle_km') {
                    rateText = `$${rateData.rate}/km`;
                } else if (selectedType === 'hotel') {
                    rateText = 'No Limit (Receipt Required)';
                } else {
                    rateText = `$${rateData.rate}`;
                }
                display.innerHTML = `
                    ğŸ›ï¸ <strong>Official NJC Rate:</strong> ${rateText}<br>
                    <small style="opacity: 0.8;">${rateData.description}</small>
                `;
                display.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
                display.style.color = '#0d47a1';
                
                // Handle different expense types
                if (selectedType === 'vehicle_km') {
                    vehicleKmGroup.style.display = 'block';
                    amountLabel.textContent = 'Total Allowance (Calculated) *';
                    amountField.value = '';
                    amountInfo.innerHTML = '<strong style="color: #0d47a1;">ğŸ“ Enter kilometers to calculate amount</strong>';
                    console.log('ğŸš— Vehicle km selected - showing km input');
                } else if (rateData.fixed) {
                    // Fixed per diem rates - LOCK THE FIELD AND HIDE VENDOR
                    console.log('ğŸ”’ Applying fixed rate lock for:', selectedType);
                    amountField.value = rateData.rate.toFixed(2);
                    amountField.readOnly = true;
                    amountField.style.backgroundColor = '#e3f2fd';
                    amountField.style.border = '2px solid #2196f3';
                    amountField.style.fontWeight = 'bold';
                    amountField.style.color = '#0d47a1';
                    amountField.style.cursor = 'not-allowed';
                    amountField.title = 'This is an official NJC per diem rate and cannot be changed';
                    amountInfo.innerHTML = '<strong style="color: #0d47a1;">ğŸ”’ Official NJC rate - cannot be modified</strong>';
                    amountLabel.textContent = 'NJC Per Diem Rate *';
                    
                    // Hide vendor field for per diem items and set default value
                    const vendorField = document.getElementById('vendor');
                    const vendorLabel = document.querySelector('label[for="vendor"]');
                    vendorField.style.display = 'none';
                    vendorLabel.style.display = 'none';
                    vendorField.removeAttribute('required');
                    vendorField.value = 'NJC Per Diem Rate';
                    
                    // Add per diem limit warning for meal types
                    if (['breakfast', 'lunch', 'dinner', 'incidentals'].includes(selectedType)) {
                        amountInfo.innerHTML += '<br><small style="color: #f57c00;">âš ï¸ Only ONE per day allowed</small>';
                    }
                    
                    console.log('âœ… Field locked and vendor hidden successfully');
                } else if (selectedType === 'hotel') {
                    // Hotel - NO maximum limit, receipt required, date range needed
                    amountInfo.innerHTML = `<strong style="color: #0d47a1; background: #fff3cd; padding: 8px; border-radius: 4px; display: block; margin: 5px 0;">ğŸ¨ HOTEL EXPENSE | ğŸ“· RECEIPT PHOTO REQUIRED | ğŸ“… Check-in/out dates required</strong>`;
                    amountLabel.textContent = 'Hotel Cost *';
                    amountField.placeholder = 'Enter total hotel cost';
                    amountField.value = ''; // Clear any previous values
                    
                    // Show vendor field for hotel expenses
                    const vendorField = document.getElementById('vendor');
                    const vendorLabel = document.querySelector('label[for="vendor"]');
                    vendorField.style.display = 'block';
                    vendorLabel.style.display = 'block';
                    vendorField.setAttribute('required', true);
                    vendorField.value = '';
                    vendorField.placeholder = 'Hotel name, booking service, etc.';
                    
                    // Show hotel date range section
                    showHotelDateRange();
                    
                    // Highlight photo section for hotel receipts
                    highlightPhotoSectionForHotel();
                    
                    console.log('ğŸ¨ Hotel selected - receipt required, vendor field shown, date range shown');
                }
                
                // Check for existing per diem on selected date
                checkPerDiemLimits();
            } else {
                console.log('âŒ No fixed rate found for:', selectedType);
                display.innerHTML = 'âš ï¸ Rate not found - please try again';
                display.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%)';
                display.style.color = '#856404';
                
                // Show vendor field for unknown expense types
                const vendorField = document.getElementById('vendor');
                const vendorLabel = document.querySelector('label[for="vendor"]');
                vendorField.style.display = 'block';
                vendorLabel.style.display = 'block';
                vendorField.setAttribute('required', true);
                vendorField.value = '';
                vendorField.placeholder = 'e.g., Tim Hortons, Hotel Name, Distance in KM';
            }
        }
        
        // Calculate vehicle allowance amount
        async function calculateVehicleAmount() {
            const kilometers = document.getElementById('kilometers').value;
            const amountField = document.getElementById('amount');
            const amountInfo = document.getElementById('amount-info');
            
            if (!kilometers || parseFloat(kilometers) <= 0) {
                amountField.value = '';
                amountInfo.innerHTML = '<strong style="color: #0d47a1;">ğŸ“ Enter kilometers to calculate amount</strong>';
                return;
            }
            
            try {
                const response = await fetch('/api/njc-rates/vehicle-allowance', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({ kilometers: parseFloat(kilometers) })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    amountField.value = result.total_amount;
                    amountInfo.innerHTML = `<strong style="color: #27ae60;">âœ… ${result.description}</strong>`;
                } else {
                    amountInfo.innerHTML = '<strong style="color: #dc3545;">âŒ Error calculating allowance</strong>';
                }
                
            } catch (error) {
                console.error('Error calculating vehicle allowance:', error);
                amountInfo.innerHTML = '<strong style="color: #dc3545;">âŒ Could not calculate - please try again</strong>';
            }
        }
        
        // Check per diem limits for selected date and expense type
        async function checkPerDiemLimits() {
            const selectedType = document.getElementById('expense-type').value;
            const selectedDate = document.getElementById('expense-date').value;
            const display = document.getElementById('per-diem-display');
            
            // Only check for per diem types
            const perDiemTypes = ['breakfast', 'lunch', 'dinner', 'incidentals'];
            if (!perDiemTypes.includes(selectedType) || !selectedDate) {
                return;
            }
            
            try {
                const response = await fetch('/api/my-expenses', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                if (response.ok) {
                    const expenses = await response.json();
                    
                    // Check if this per diem type already exists for the selected date
                    const existingExpense = expenses.find(expense => 
                        expense.expense_type === selectedType && 
                        expense.date === selectedDate && 
                        expense.status !== 'rejected'
                    );
                    
                    if (existingExpense) {
                        // Show warning
                        const warningDiv = document.createElement('div');
                        warningDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 8px; margin: 10px 0; font-weight: 600;';
                        warningDiv.innerHTML = `âš ï¸ You already claimed ${selectedType} on ${selectedDate} (Status: ${existingExpense.status.toUpperCase()})`;
                        
                        // Insert warning after the per-diem display
                        const parent = display.parentNode;
                        const existingWarning = parent.querySelector('.per-diem-warning');
                        if (existingWarning) {
                            existingWarning.remove();
                        }
                        warningDiv.className = 'per-diem-warning';
                        parent.insertBefore(warningDiv, display.nextSibling);
                    } else {
                        // Remove warning if no duplicate found
                        const existingWarning = document.querySelector('.per-diem-warning');
                        if (existingWarning) {
                            existingWarning.remove();
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking per diem limits:', error);
            }
        }
        
        // Photo handling
        const fileInput = document.getElementById('file-input');
        const photoSection = document.querySelector('.photo-section');
        const photoPreview = document.getElementById('photo-preview');
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 10 * 1024 * 1024) {
                    showMessage('error', 'âŒ File size too large. Maximum size is 10MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.src = e.target.result;
                    photoPreview.style.display = 'block';
                    photoSection.classList.add('has-photo');
                    photoSection.innerHTML = '<div style="color: #27ae60; font-weight: 600;">âœ… Receipt captured successfully!</div>' + 
                                           '<img id="photo-preview" class="photo-preview" src="' + e.target.result + '">';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Add date change listener to check per diem limits
        document.getElementById('expense-date').addEventListener('change', checkPerDiemLimits);
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECTION 5: HOTEL DATE RANGE & PER DIEM LOGIC
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Purpose: Handle hotel-specific business logic and per diem calculations
        // Features: Check-in/out date validation, length of stay calculation
        // Compliance: Government travel requirements for hotel documentation
        
        function showHotelDateRange() {
            console.log('ğŸ¨ Showing hotel date range section');
            const hotelDateRange = document.getElementById('hotel-date-range');
            hotelDateRange.style.display = 'block';
            
            // Make hotel date fields required when hotel is selected
            document.getElementById('hotel-checkin').setAttribute('required', true);
            document.getElementById('hotel-checkout').setAttribute('required', true);
            
            // Clear any existing values
            document.getElementById('hotel-checkin').value = '';
            document.getElementById('hotel-checkout').value = '';
            document.getElementById('hotel-nights-display').innerHTML = '';
        }
        
        function hideHotelDateRange() {
            console.log('ğŸ¨ Hiding hotel date range section');
            const hotelDateRange = document.getElementById('hotel-date-range');
            hotelDateRange.style.display = 'none';
            
            // Remove required attribute when not hotel
            document.getElementById('hotel-checkin').removeAttribute('required');
            document.getElementById('hotel-checkout').removeAttribute('required');
            
            // Clear values
            document.getElementById('hotel-checkin').value = '';
            document.getElementById('hotel-checkout').value = '';
            document.getElementById('hotel-nights-display').innerHTML = '';
        }
        
        function calculateHotelNights() {
            const checkinDate = document.getElementById('hotel-checkin').value;
            const checkoutDate = document.getElementById('hotel-checkout').value;
            const display = document.getElementById('hotel-nights-display');
            
            if (checkinDate && checkoutDate) {
                const checkin = new Date(checkinDate);
                const checkout = new Date(checkoutDate);
                
                if (checkout <= checkin) {
                    display.innerHTML = 'âŒ Check-out date must be after check-in date';
                    display.style.background = '#f8d7da';
                    display.style.color = '#721c24';
                    display.style.borderColor = '#f1aeb5';
                    return;
                }
                
                const timeDiff = checkout.getTime() - checkin.getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                
                display.innerHTML = `âœ… Hotel stay: ${daysDiff} night${daysDiff === 1 ? '' : 's'} (${checkinDate} to ${checkoutDate})`;
                display.style.background = '#d4edda';
                display.style.color = '#155724';
                display.style.borderColor = '#c3e6cb';
                
                console.log('ğŸ¨ Hotel nights calculated:', daysDiff);
            } else {
                display.innerHTML = '';
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHOTO SECTION HIGHLIGHTING FOR HOTEL RECEIPTS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function highlightPhotoSectionForHotel() {
            const photoSection = document.querySelector('.photo-section');
            const receiptLabel = photoSection.parentElement.querySelector('label');
            
            // Highlight photo section with hotel-specific styling
            photoSection.style.border = '3px solid #dc3545';
            photoSection.style.background = 'linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%)';
            
            // Update label to emphasize requirement
            if (receiptLabel) {
                receiptLabel.innerHTML = 'ğŸ“· Receipt Photo <span style="color: #dc3545; font-weight: bold;">(REQUIRED FOR HOTELS)</span>';
            }
            
            // Update inner content to emphasize hotel requirement
            const hasPhoto = photoSection.classList.contains('has-photo');
            if (!hasPhoto) {
                photoSection.innerHTML = `
                    <div class="camera-icon">ğŸ“·</div>
                    <div><strong style="color: #dc3545;">REQUIRED: Hotel Receipt Photo</strong></div>
                    <div style="font-size: 12px; color: #dc3545; margin-top: 5px; font-weight: bold;">Hotels must include receipt photo</div>
                    <div style="font-size: 11px; color: #6c757d; margin-top: 3px;">Supports: JPG, PNG, GIF, WebP (Max 10MB)</div>
                    <img id="photo-preview" class="photo-preview" style="display: none;">
                `;
            }
        }
        
        function resetPhotoSectionHighlight() {
            const photoSection = document.querySelector('.photo-section');
            const receiptLabel = photoSection.parentElement.querySelector('label');
            
            // Reset to normal styling
            photoSection.style.border = '3px dashed #bdc3c7';
            photoSection.style.background = '#fafbfc';
            
            // Reset label text
            if (receiptLabel) {
                receiptLabel.innerHTML = 'Receipt Photo';
            }
            
            // Reset content if no photo uploaded
            const hasPhoto = photoSection.classList.contains('has-photo');
            if (!hasPhoto) {
                photoSection.innerHTML = `
                    <div class="camera-icon">ğŸ“·</div>
                    <div><strong>Tap to capture or upload receipt</strong></div>
                    <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Supports: JPG, PNG, GIF, WebP (Max 10MB)</div>
                    <img id="photo-preview" class="photo-preview" style="display: none;">
                `;
            }
        }
        
        // Prevent form submission - use buttons instead
        document.getElementById('expense-form').addEventListener('submit', function(e) {
            e.preventDefault();
            showMessage('info', 'ğŸ‘† Please select a trip and use the "Add Expense to Trip" button above.');
        });
        
        // Reset photo section
        function resetPhotoSection() {
            const photoSection = document.querySelector('.photo-section');
            photoSection.classList.remove('has-photo');
            photoSection.innerHTML = `
                <div class="camera-icon">ğŸ“·</div>
                <div><strong>Tap to capture or upload receipt</strong></div>
                <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Supports: JPG, PNG, GIF, WebP (Max 10MB)</div>
                <img id="photo-preview" class="photo-preview" style="display: none;">
            `;
            fileInput.value = '';
        }
        
        // Load user's expenses
        async function loadDashboardStats() {
            // Alias: reload expenses which updates stats
            await loadMyExpenses();
        }

        async function loadMyExpenses() {
            try {
                const response = await fetch('/api/my-expenses', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load expenses');
                }
                
                const expenses = await response.json();
                updateStats(expenses);
                displayExpenses(expenses);
                
            } catch (error) {
                console.error('Error loading expenses:', error);
                document.getElementById('expenses-container').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <div style="font-size: 48px; margin-bottom: 15px;">âŒ</div>
                        <h3>Error Loading Expenses</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Update stats
        function updateStats(expenses) {
            const totalAmount = expenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
            const approvedAmount = expenses.filter(exp => exp.status === 'approved')
                .reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
            const pendingCount = expenses.filter(exp => exp.status === 'pending').length;
            
            document.getElementById('total-expenses').textContent = expenses.length;
            document.getElementById('total-amount').textContent = `$${totalAmount.toFixed(2)}`;
            document.getElementById('approved-amount').textContent = `$${approvedAmount.toFixed(2)}`;
            document.getElementById('pending-count').textContent = pendingCount;
        }
        
        // Display expenses
        function displayExpenses(expenses) {
            const container = document.getElementById('expenses-container');
            
            if (expenses.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“‹</div>
                        <h3>No Expenses Yet</h3>
                        <p>Submit your first expense using the "Submit Expense" tab above.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = expenses.map(expense => {
                const statusClass = expense.status === 'approved' ? 'status-approved' : 
                                  expense.status === 'rejected' ? 'status-rejected' : 'status-pending';
                const statusText = expense.status === 'approved' ? 'âœ… Approved' :
                                 expense.status === 'rejected' ? 'âŒ Rejected' : 'â³ Pending Approval';
                
                return `
                    <div class="expense-item">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; flex-wrap: wrap;">
                            <div style="flex-grow: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div style="font-weight: bold; color: #2c3e50; font-size: 16px;">
                                        ${njcRates[expense.expense_type]?.icon || 'ğŸ’°'} ${expense.meal_name || expense.expense_type}
                                    </div>
                                    <span class="status-badge ${statusClass}">${statusText}</span>
                                </div>
                                <div style="color: #666; margin-bottom: 10px;">
                                    <span style="color: #27ae60; font-size: 18px; font-weight: bold;">$${parseFloat(expense.amount).toFixed(2)}</span> â€¢ 
                                    ğŸ“… ${expense.date} â€¢ 
                                    ğŸ“ ${expense.location}
                                    ${expense.vendor ? ` â€¢ ğŸª ${expense.vendor}` : ''}
                                    ${expense.trip_name ? `<br><span style="color: #0066cc; font-weight: 500;">ğŸ§³ ${expense.trip_name}</span>` : ''}
                                </div>
                                ${expense.description ? `
                                    <div style="font-size: 13px; color: #666; margin-bottom: 8px; padding: 8px 12px; background: #f8f9fa; border-radius: 6px;">
                                        ğŸ“‹ ${expense.description}
                                    </div>
                                ` : ''}
                                ${expense.approval_comment ? `
                                    <div style="font-size: 13px; color: #155724; margin-bottom: 8px; padding: 8px 12px; background: #d4edda; border-radius: 6px;">
                                        âœ… <strong>Approved:</strong> ${expense.approval_comment}
                                    </div>
                                ` : ''}
                                ${expense.rejection_reason ? `
                                    <div style="font-size: 13px; color: #721c24; margin-bottom: 8px; padding: 8px 12px; background: #f8d7da; border-radius: 6px;">
                                        âŒ <strong>Rejected:</strong> ${expense.rejection_reason}
                                    </div>
                                ` : ''}
                                <div style="font-size: 12px; color: #999;">
                                    Submitted: ${new Date(expense.created_at).toLocaleString()}
                                </div>
                            </div>
                            ${expense.receipt_photo ? `
                                <div style="flex-shrink: 0;">
                                    <img src="${expense.receipt_photo}" alt="Receipt" style="max-width: 80px; max-height: 80px; border-radius: 8px; cursor: pointer;" onclick="viewReceipt('${expense.receipt_photo}')">
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // View receipt in modal
        function viewReceipt(receiptPath) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 2000;
                background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
                padding: 20px; cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = receiptPath;
            img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';
            
            modal.appendChild(img);
            modal.onclick = () => modal.remove();
            document.body.appendChild(modal);
        }
        
        // Show messages
        function showMessage(type, message) {
            document.querySelectorAll('.success-message, .error-message').forEach(el => {
                el.style.display = 'none';
            });
            
            const messageElement = document.getElementById(type + '-message');
            const textElement = document.getElementById(type + '-text');
            
            if (messageElement && textElement) {
                textElement.textContent = message.replace(/^[âœ…âŒ]\s*/, '');
                messageElement.style.display = 'block';
                
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 5000);
            }
        }
        
        // Logout
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            localStorage.removeItem('sessionId');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }
        
        // ğŸ§³ TRIP MANAGEMENT FUNCTIONS
        
        // Load user's trips for selection
        async function loadTrips() {
            try {
                const response = await fetch('/api/trips', {
                    headers: { 'Authorization': `Bearer ${sessionId}` }
                });
                
                if (response.ok) {
                    const trips = await response.json();
                    const tripSelect = document.getElementById('trip-select');
                    
                    // Clear existing options (except first)
                    while (tripSelect.children.length > 1) {
                        tripSelect.removeChild(tripSelect.lastChild);
                    }
                    
                    // Add trip options
                    trips.forEach(trip => {
                        if (trip.status === 'draft') { // Only show draft trips for new expenses
                            const option = document.createElement('option');
                            option.value = trip.id;
                            const expenseCount = trip.expense_count || 0;
                            const total = trip.calculated_total || 0;
                            option.textContent = `ğŸ§³ ${trip.trip_name} (${trip.start_date} to ${trip.end_date}) - ${expenseCount} expenses, $${total.toFixed(2)}`;
                            tripSelect.appendChild(option);
                        }
                    });
                    
                    if (trips.filter(t => t.status === 'draft').length === 0) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '(No draft trips available)';
                        option.disabled = true;
                        tripSelect.appendChild(option);
                    }
                    
                    console.log(`âœ… Loaded ${trips.length} trips for selection`);
                } else {
                    console.error('Failed to load trips');
                }
            } catch (error) {
                console.error('Error loading trips:', error);
            }
        }
        
        // Show new trip modal
        function showNewTripModal() {
            const modal = document.getElementById('new-trip-modal');
            modal.style.display = 'flex';
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('trip-start-date').value = today;
            document.getElementById('trip-end-date').value = today;
        }
        
        // Hide new trip modal
        function hideNewTripModal() {
            const modal = document.getElementById('new-trip-modal');
            modal.style.display = 'none';
            
            // Clear form
            document.getElementById('new-trip-form').reset();
        }
        
        // Create new trip
        async function createNewTrip(event) {
            event.preventDefault();
            
            // Debug logging
            console.log('ğŸ§³ Creating trip - sessionId:', sessionId ? 'Present' : 'MISSING');
            
            // Check if sessionId is available
            if (!sessionId) {
                console.error('âŒ No sessionId available');
                showMessage('error', 'âŒ Session expired. Please refresh the page and try again.');
                window.location.href = '/login';
                return;
            }
            
            const tripData = {
                trip_name: document.getElementById('trip-name').value,
                destination: document.getElementById('trip-destination').value,
                purpose: document.getElementById('trip-purpose').value,
                start_date: document.getElementById('trip-start-date').value,
                end_date: document.getElementById('trip-end-date').value
            };
            
            console.log('ğŸ§³ Trip data:', tripData);
            
            try {
                showMessage('info', 'ğŸ§³ Creating trip...');
                
                const response = await fetch('/api/trips', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify(tripData)
                });
                
                console.log('ğŸ§³ Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('ğŸ§³ Response result:', result);
                
                if (result.success) {
                    showMessage('success', `âœ… Trip "${tripData.trip_name}" created successfully!`);
                    hideNewTripModal();
                    await loadTrips(); // Refresh the trips list
                } else {
                    showMessage('error', `âŒ Error creating trip: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('âŒ Error creating trip:', error);
                showMessage('error', `âŒ Failed to create trip: ${error.message}. Please try again.`);
            }
        }
        
        function updateDraftExpensesList() {
            console.log('ğŸ”„ updateDraftExpensesList called. Expenses count:', draftTripExpenses.length);
            
            const draftList = document.getElementById('draft-expenses-list');
            const submitSection = document.getElementById('trip-submit-section');
            
            if (!draftList) {
                console.error('âŒ draft-expenses-list element not found!');
                return;
            }
            
            if (draftTripExpenses.length === 0) {
                console.log('ğŸ“ No expenses, showing empty state');
                draftList.innerHTML = `
                    <p style="text-align: center; color: #6c757d; padding: 20px;">
                        No expenses added to trip yet.<br>
                        <small>Select a trip and click "Add to Trip" to start building your expense report.</small>
                    </p>
                `;
                submitSection.style.display = 'none';
                return;
            }
            
            console.log('ğŸ“‹ Building draft list for', draftTripExpenses.length, 'expenses');
            
            const total = draftTripExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            
            let html = `
                <div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #28a745; box-shadow: 0 4px 8px rgba(40,167,69,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <h4 style="margin: 0; color: #155724;">ğŸ§³ ${draftTripExpenses[0].trip_name}</h4>
                            <div style="color: #155724; font-size: 18px; font-weight: bold;">
                                ${draftTripExpenses.length} expenses â€¢ Total: $${total.toFixed(2)}
                            </div>
                        </div>
                        <div style="background: #28a745; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold;">
                            DRAFT
                        </div>
                    </div>
                    <small style="color: #155724; opacity: 0.8;">
                        âœ… Expenses added successfully â€¢ Click "Submit Trip for Approval" when complete
                    </small>
                </div>
            `;
            
            draftTripExpenses.forEach((expense, index) => {
                const icon = njcRates[expense.expense_type]?.icon || 'ğŸ’°';
                const isPerDiem = ['breakfast', 'lunch', 'dinner', 'incidentals'].includes(expense.expense_type);
                const vendorDisplay = isPerDiem ? 'NJC Per Diem' : expense.vendor;
                
                html += `
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px; border-left: 4px solid #28a745; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                <span style="font-size: 20px; margin-right: 10px;">${icon}</span>
                                <div>
                                    <strong style="color: #155724; font-size: 16px;">${expense.meal_name}</strong>
                                    <span style="color: #28a745; font-weight: bold; margin-left: 10px; font-size: 16px;">$${expense.amount.toFixed(2)}</span>
                                </div>
                            </div>
                            <div style="color: #666; font-size: 13px; line-height: 1.4;">
                                ğŸ“… ${expense.date} â€¢ ğŸ“ ${expense.location} â€¢ ğŸª ${vendorDisplay}<br>
                                ${expense.description ? 'ğŸ“ ' + expense.description : '<em>No additional notes</em>'}
                            </div>
                        </div>
                        <button onclick="removeDraftExpense(${index})" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                            ğŸ—‘ï¸ Remove
                        </button>
                    </div>
                `;
            });
            
            draftList.innerHTML = html;
            submitSection.style.display = 'block';
            
            console.log('âœ… Draft list HTML updated successfully');
            console.log('ğŸ“‹ Final HTML length:', html.length);
        }
        
        function removeDraftExpense(index) {
            const removed = draftTripExpenses[index];
            draftTripExpenses.splice(index, 1);
            saveDrafts();
            updateDraftExpensesList();
            showMessage('info', `ğŸ—‘ï¸ ${removed.meal_name} removed from trip`);
        }
        
        async function submitTripForApproval() {
            if (draftTripExpenses.length === 0) {
                showMessage('error', 'âŒ No expenses in trip to submit.');
                return;
            }
            
            let tripName = draftTripExpenses[0].trip_name;
            let tripId = draftTripExpenses[0].trip_id;
            
            // Check if any expenses are missing trip assignment
            const unassigned = draftTripExpenses.filter(e => !e.trip_id);
            if (unassigned.length > 0) {
                // Try to use the currently selected trip
                const tripSelect = document.getElementById('trip-select');
                const selectedTripId = tripSelect.value;
                
                if (!selectedTripId) {
                    showMessage('error', `âŒ ${unassigned.length} expense(s) have no trip assigned. Please select a trip from the dropdown first.`);
                    tripSelect.focus();
                    return;
                }
                
                // Assign the selected trip to all unassigned expenses
                const selectedTripName = tripSelect.options[tripSelect.selectedIndex].text;
                for (const expense of draftTripExpenses) {
                    if (!expense.trip_id) {
                        expense.trip_id = selectedTripId;
                        expense.trip_name = selectedTripName;
                    }
                }
                saveDrafts();
                updateDraftExpensesList();
                
                tripName = selectedTripName;
                tripId = selectedTripId;
            }
            
            if (!confirm(`Submit trip "${tripName}" with ${draftTripExpenses.length} expenses for approval?`)) {
                return;
            }
            
            try {
                showMessage('info', 'ğŸ“¤ Submitting trip expenses...');
                
                // Submit each expense one by one
                let successCount = 0;
                let errors = [];
                
                for (const expense of draftTripExpenses) {
                    try {
                        const formData = new FormData();
                        formData.append('expense_type', expense.expense_type);
                        formData.append('meal_name', expense.meal_name);
                        formData.append('date', expense.date);
                        formData.append('location', expense.location);
                        formData.append('amount', expense.amount);
                        formData.append('vendor', expense.vendor || 'NJC Per Diem Rate');
                        formData.append('description', expense.description || '');
                        formData.append('trip_id', tripId);
                        
                        const response = await fetch('/api/expenses', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${sessionId}` },
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok && result.success) {
                            successCount++;
                            console.log(`âœ… Expense submitted: ${expense.meal_name} - $${expense.amount}`);
                        } else {
                            const errorMsg = result.error || 'Unknown error';
                            errors.push(`${expense.meal_name}: ${errorMsg}`);
                            console.error(`âŒ Expense failed: ${expense.meal_name} - ${errorMsg}`);
                        }
                    } catch (expError) {
                        errors.push(`${expense.meal_name}: Network error - ${expError.message}`);
                        console.error(`âŒ Network error for ${expense.meal_name}:`, expError);
                    }
                }
                
                console.log(`ğŸ“Š Submission results: ${successCount}/${draftTripExpenses.length} successful`);
                
                if (successCount > 0) {
                    // Submit the trip itself
                    try {
                        const tripResponse = await fetch(`/api/trips/${tripId}/submit`, {
                            method: 'POST',
                            headers: { 
                                'Authorization': `Bearer ${sessionId}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const tripResult = await tripResponse.json();
                        console.log('Trip submit response:', tripResult);
                    } catch (tripErr) {
                        console.error('Trip status update error:', tripErr);
                    }
                    
                    if (successCount === draftTripExpenses.length) {
                        showMessage('success', `ğŸ‰ Trip "${tripName}" with ${successCount} expenses submitted for approval!`);
                    } else {
                        showMessage('warning', `âš ï¸ ${successCount}/${draftTripExpenses.length} expenses submitted. Errors:\n${errors.join('\n')}`);
                        alert(`âš ï¸ Some expenses failed to submit:\n\n${errors.join('\n')}`);
                    }
                    
                    // Clear draft
                    draftTripExpenses = [];
                    saveDrafts();
                    updateDraftExpensesList();
                    
                    // Unlock trip if locked
                    if (isTripLocked) {
                        isTripLocked = false;
                        lockedTripId = null;
                        lockedTripName = '';
                        const tripSelect = document.getElementById('trip-select');
                        tripSelect.disabled = false;
                        tripSelect.style.opacity = '1';
                        tripSelect.style.cursor = 'pointer';
                        updateTripLockButton();
                    }
                    
                    // Refresh everything
                    await loadTrips();
                    await loadMyExpenses();
                    await loadDashboardStats();
                } else {
                    // ALL expenses failed
                    showMessage('error', `âŒ All expenses failed to submit:\n${errors.join('\n')}`);
                    alert(`âŒ Trip submission failed. Errors:\n\n${errors.join('\n')}\n\nYour draft is preserved - fix the issues and try again.`);
                }
            } catch (error) {
                console.error('Trip submission error:', error);
                showMessage('error', `âŒ Error submitting trip: ${error.message}. Please try again.`);
                alert(`âŒ Trip submission failed: ${error.message}`);
            }
        }
        
        function clearTripDraft() {
            if (draftTripExpenses.length === 0) {
                showMessage('info', 'ğŸ“ No expenses to clear.');
                return;
            }
            
            const expenseCount = draftTripExpenses.length;
            const tripName = draftTripExpenses.length > 0 ? draftTripExpenses[0].trip_name : 'trip';
            
            if (!confirm(`Clear all ${expenseCount} expenses from ${tripName}?`)) {
                return;
            }
            
            draftTripExpenses = [];
            saveDrafts();
            updateDraftExpensesList();
            
            // Optionally unlock trip when clearing draft
            if (isTripLocked && confirm('Also unlock the trip selection?')) {
                toggleTripLock();
            }
            
            showMessage('success', `ğŸ—‘ï¸ ${expenseCount} expenses cleared from trip draft`);
        }
        
        // Get expense type display name
        function getExpenseTypeName(type) {
            return njcRates[type]?.name || type.charAt(0).toUpperCase() + type.slice(1);
        }
        
        // ğŸ”’ TRIP LOCKING SYSTEM
        
        function handleTripSelection() {
            console.log('ğŸ”„ Trip selection changed, locked:', isTripLocked);
            
            if (isTripLocked) {
                console.log('ğŸ”’ Trip is locked, ignoring selection change');
                return;
            }
            
            const tripSelect = document.getElementById('trip-select');
            const selectedValue = tripSelect.value;
            const lockBtn = document.getElementById('trip-lock-btn');
            
            if (selectedValue && selectedValue !== '') {
                // Show lock button when trip is selected
                lockBtn.style.display = 'inline-block';
                updateTripInfo(selectedValue);
            } else {
                // Hide lock button when no trip selected
                lockBtn.style.display = 'none';
                isTripLocked = false;
                lockedTripId = null;
                lockedTripName = '';
                updateTripLockButton();
                updateTripInfo('');
            }
        }
        
        function clearTripSelection() {
            const tripSelect = document.getElementById('trip-select');
            tripSelect.value = '';
            if (isTripLocked) {
                isTripLocked = false;
                lockedTripId = null;
                lockedTripName = '';
                tripSelect.disabled = false;
                tripSelect.style.opacity = '1';
                tripSelect.style.cursor = 'pointer';
                updateTripLockButton();
            }
            updateTripInfo('');
            showMessage('info', 'ğŸ”„ Trip selection cleared.');
        }

        function toggleTripLock() {
            const tripSelect = document.getElementById('trip-select');
            const selectedValue = tripSelect.value;
            
            if (!selectedValue) {
                showMessage('error', 'ğŸ§³ Please select a trip first before locking.');
                return;
            }
            
            if (isTripLocked) {
                // UNLOCK TRIP
                isTripLocked = false;
                lockedTripId = null;
                lockedTripName = '';
                tripSelect.disabled = false;
                tripSelect.style.opacity = '1';
                tripSelect.style.cursor = 'pointer';
                
                showMessage('info', 'ğŸ”“ Trip unlocked - you can now select a different trip.');
                console.log('ğŸ”“ Trip unlocked');
                
            } else {
                // LOCK TRIP
                isTripLocked = true;
                lockedTripId = selectedValue;
                lockedTripName = tripSelect.options[tripSelect.selectedIndex].text;
                tripSelect.disabled = true;
                tripSelect.style.opacity = '0.7';
                tripSelect.style.cursor = 'not-allowed';
                
                showMessage('success', `ğŸ”’ Trip "${lockedTripName.replace('ğŸ§³ ', '')}" locked! Add your expenses, then unlock when done.`);
                console.log('ğŸ”’ Trip locked:', lockedTripName);
            }
            
            updateTripLockButton();
            updateTripInfo(selectedValue);
        }
        
        function updateTripLockButton() {
            const lockBtn = document.getElementById('trip-lock-btn');
            
            if (isTripLocked) {
                lockBtn.innerHTML = 'ğŸ”’ Locked';
                lockBtn.style.background = '#dc3545';
                lockBtn.title = 'Click to unlock trip selection';
            } else {
                lockBtn.innerHTML = 'ğŸ”“ Unlocked';  
                lockBtn.style.background = '#28a745';
                lockBtn.title = 'Click to lock trip selection';
            }
        }
        
        function updateTripInfo(selectedValue) {
            const tripInfo = document.getElementById('trip-info');
            
            if (selectedValue && selectedValue !== '') {
                const tripSelect = document.getElementById('trip-select');
                const tripName = tripSelect.options[tripSelect.selectedIndex].text.replace('ğŸ§³ ', '');
                
                // Auto-fill location if we have a saved location for this trip
                const locationField = document.getElementById('location');
                if (tripLocationMemory[selectedValue] && !locationField.value.trim()) {
                    locationField.value = tripLocationMemory[selectedValue];
                    console.log('ğŸ“ Auto-filled location from trip memory:', tripLocationMemory[selectedValue]);
                }
                
                let html = `
                    <div style="background: #e8f5e8; color: #155724; font-weight: 500; border: 1px solid #c3e6cb; border-radius: 8px; padding: 12px;">
                        ğŸ§³ <strong>SELECTED:</strong> ${tripName}<br>
                `;
                
                if (isTripLocked) {
                    html += `
                        <small style="opacity: 0.9;">
                            ğŸ”’ <strong>LOCKED</strong> - This trip will stay selected for all expenses<br>
                            â• Keep adding expenses to this trip â€¢ ğŸ”“ Click unlock when done
                        </small>
                    `;
                } else {
                    html += `
                        <small style="opacity: 0.8;">
                            ğŸ“ Ready to add expenses â€¢ ğŸ”’ Click lock to prevent accidental changes
                        </small>
                    `;
                }
                
                // Show location memory status
                if (tripLocationMemory[selectedValue]) {
                    html += `<br><small style="opacity: 0.7;">ğŸ“ Location auto-filled: ${tripLocationMemory[selectedValue]}</small>`;
                }
                
                html += `</div>`;
                tripInfo.innerHTML = html;
                tripInfo.style.display = 'block';
                
            } else {
                tripInfo.style.display = 'none';
            }
        }
        
    </script>
</body>
</html>
