# ClaimFlow Backup & Rollback Guide
> **Created**: 2026-02-23 23:30 EST  
> **Git SHA**: `a78c7c56ea992a46a15656331343f69e8f874ec4`  
> **Git Tag**: `v5.0-transport-e2e-verified-2026-02-23`  
> **Branch**: `main`  
> **Live URL**: https://claimflow-e0za.onrender.com  
> **Repo**: https://github.com/Thunder207/claimflow.git  

---

## üî¥ ROLLBACK INSTRUCTIONS

### If something breaks after this point:

```bash
# 1. Rollback to this exact state
cd /path/to/expense-app
git checkout v5.0-transport-e2e-verified-2026-02-23

# 2. Or rollback to any prior milestone
git checkout v4.0-governance-validated-2026-02-21-1612EST   # pre-transport
git checkout v2.2-e2e-verified-2026-02-20-2140EST           # pre-supervisor-UI
git checkout v2.0-dayplanner-2026-02-19-2012EST             # Day Planner only
git checkout v1.0-stable-2026-02-19-1730EST                 # pre-Day Planner

# 3. Force deploy the rollback to Render
git push -f origin HEAD:main
curl -X POST \
  -H "Authorization: Bearer rnd_PM94FfZa3hFY3OzBJ1Ao5j9yD0qI" \
  -H "Content-Type: application/json" \
  'https://api.render.com/v1/services/srv-d6aj99rnv86c739nt670/deploys' \
  -d '{"clearCache":"do_not_clear"}'
```

### Tag Reference (newest ‚Üí oldest)
| Tag | Date | What's Included |
|-----|------|-----------------|
| `v5.0-transport-e2e-verified-2026-02-23` | Feb 23 | **THIS BACKUP** ‚Äî Smart Transport, full E2E |
| `v4.0-governance-validated-2026-02-21-1612EST` | Feb 21 | Governance roles, no transport |
| `v3.0-supervisor-ui-2026-02-20-2255EST` | Feb 20 | Supervisor dashboard |
| `v2.2-e2e-verified-2026-02-20-2140EST` | Feb 20 | Day Planner E2E verified |
| `v2.0-dayplanner-2026-02-19-2012EST` | Feb 19 | Day Planner initial |
| `v1.0-stable-2026-02-19-1730EST` | Feb 19 | Original stable (no Day Planner) |

---

## üü¢ WHAT'S WORKING (verified Feb 23, 2026)

### Full Employee ‚Üí Supervisor Flow
1. ‚úÖ Employee creates Travel Authorization with per diem Day Planner + transport costs
2. ‚úÖ Employee submits AT for approval (PENDING status)
3. ‚úÖ Supervisor sees AT with cost breakdown (Meals / Lodging / Other) and approves
4. ‚úÖ Trip auto-created upon AT approval
5. ‚úÖ Employee opens Trip, enters actual transport costs via Day Planner
6. ‚úÖ Employee submits Trip ‚Üí creates expense records including `transport_flight` etc.
7. ‚úÖ Supervisor sees day-by-day breakdown with transport line items and approves

### Verified via:
- **API tests**: 5/5 passed (AT creation, transport save, expense records, supervisor visibility)
- **Browser E2E**: 5/5 steps passed with previous test data
- **Browser re-test (in progress)**: Steps 1-3 completed, Step 4 mid-flow when backup created

---

## üìÇ PROJECT STRUCTURE

### Critical Files (touch with care)
```
app.js                    (4,560 lines) ‚Äî Backend: Express server, all API routes, SQLite
employee-dashboard.html   (7,113 lines) ‚Äî Frontend: entire employee + trip UI
```

### Supporting Files
```
admin.html                ‚Äî Supervisor dashboard (served at /admin)
login.html                ‚Äî Login page
signup.html               ‚Äî Signup page
translations.js           ‚Äî EN/FR bilingual support
audit-system.js           ‚Äî Audit logging module
njc-rates-service.js      ‚Äî NJC per diem rate calculations
package.json              ‚Äî Node dependencies
render.yaml               ‚Äî Render deployment config
```

### Documentation (read in this order)
```
CONTINUITY.md             ‚Äî Quick-start recovery doc (architecture, credentials, data flow)
ARCHITECTURE.md           ‚Äî Deep dive: database schema, API endpoints, component details
BACKUP-2026-02-23-2330EST.md ‚Äî THIS FILE: rollback + handoff
```

---

## üîë CREDENTIALS & ACCESS

### Render.com Deployment
- **API Key**: `rnd_PM94FfZa3hFY3OzBJ1Ao5j9yD0qI`
- **Service ID**: `srv-d6aj99rnv86c739nt670`
- **Deploy command**: See rollback section above

### Demo Logins
| Role | Name | Email | Password |
|------|------|-------|----------|
| Employee | Anna Lee | anna.lee@company.com | anna123 |
| Supervisor | Lisa Brown | lisa.brown@company.com | lisa123 |
| Employee | David Wilson | david.wilson@company.com | david123 |
| Supervisor | Sarah Chen | sarah.chen@company.com | sarah123 |

**‚ö†Ô∏è Database is SQLite in-memory ‚Äî ALL DATA RESETS on every Render deploy.**

---

## üèóÔ∏è HOW TO PICK UP AND KEEP WORKING

### First Steps for a New Developer/Agent

1. **Clone and read**:
   ```bash
   git clone https://github.com/Thunder207/claimflow.git
   cd claimflow
   cat CONTINUITY.md        # Start here
   cat ARCHITECTURE.md      # Deep dive
   ```

2. **Run locally**:
   ```bash
   npm install
   node app.js              # Starts on port 3000
   # Open http://localhost:3000
   ```

3. **Understand the transport data flow** (most complex part):
   - AT creation: `createTravelAuth()` in `employee-dashboard.html`
   - Trip submission: `dpSubmitForApproval()` in `employee-dashboard.html`
   - Backend validation: `validExpenseTypes` array in `app.js` (~line 3856)
   - **DOM-direct reading**: Trip submit reads active transport from DOM, NOT from JS state

### ID Naming Convention (CRITICAL ‚Äî past bugs came from mixing these up)
| Context | Prefix | Example IDs |
|---------|--------|-------------|
| AT Creation Modal | `at-` | `at-flight-dep`, `at-flight-ret` |
| AT Day Planner | `dp-` | `dp-flight-dep`, `dp-flight-ret` |
| Trip Day Planner | `tdp-` | `tdp-flight-dep`, `tdp-flight-ret` |
| AT Transport Toggles | `dp-transport-toggles` | Container for AT buttons |
| Trip Transport Toggles | `tdp-transport-toggles` | Container for Trip buttons |

### Common Pitfalls (learned the hard way)
1. **Never mix AT/Trip transport IDs** ‚Äî causes buttons to silently fail
2. **Don't trust `dpState.transport`** ‚Äî read DOM directly in submit functions
3. **Always add new expense types to `validExpenseTypes`** in app.js or backend rejects them
4. **Test JS syntax after edits** ‚Äî one orphan `}` broke the entire app (commit `02ff898`)
5. **SQLite resets on deploy** ‚Äî don't panic when test data disappears
6. **Never claim "fixed" without user testing** ‚Äî deploy ‚â† working

---

## üìã OPEN ITEMS / FUTURE WORK

| Priority | Item | Notes |
|----------|------|-------|
| Medium | AT ‚Üí Trip transport auto-populate | When trip loads, read AT `details` JSON and pre-fill transport buttons + amounts |
| Low | `est_transport` supervisor display | Shows $0 in AT summary even though expense records are correct |
| Low | Hotel receipt upload | UI buttons exist but backend processing may be incomplete |
| Future | PostgreSQL migration | For production persistence (SQLite is ephemeral) |
| Future | Email notifications | Notify supervisor on AT/Trip submission |
| Future | PDF receipt generation | Export expense reports as PDF |

---

## üìä CURRENT STATE SNAPSHOT (Feb 23, 2026 23:30 EST)

- **Code**: Clean, all committed, pushed to GitHub
- **Live site**: Running at https://claimflow-e0za.onrender.com
- **Test data on live**: Has AT "Toronto Business Meeting" (APPROVED) + Trip (PENDING, 0 expenses)
- **Browser test paused at**: Anna Lee's trip, Flight button activated, needs $600/$600 entry + submit
- **No uncommitted changes**
- **No known bugs** in current deployment
